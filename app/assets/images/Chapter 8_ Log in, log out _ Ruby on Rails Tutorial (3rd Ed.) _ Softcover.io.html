<!DOCTYPE html>
<!-- saved from url=(0049)https://www.railstutorial.org/book/log_in_log_out -->
<html id="custDomain"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script type="text/javascript" src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/1310fd97f1"></script><script src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/nr-918.min.js"></script><script src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/6713.js" async="" type="text/javascript"></script><script type="text/javascript" async="" src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/54eea5d20a23b37d87000040.js"></script><script id="facebook-jssdk" src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/sdk.js"></script><script id="twitter-wjs" src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/widgets.js"></script><script async="" src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/analytics.js"></script><script src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/1197428788.js" type="text/javascript"></script>

<meta name="csrf-param" content="authenticity_token">
<meta name="csrf-token" content="3LOAe/ToNZ836WeTYhsegcwR0mTO2SvK/jbS2ZdkSiSQl6hsaqS5cCPDPGWwK+WTzUw3WPo7BK/pZdqoaV/ICw==">

<script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"beacon":"bam.nr-data.net","errorBeacon":"bam.nr-data.net","licenseKey":"1310fd97f1","applicationID":"4014257","transactionName":"IVZWR0tbWF4BFxhWVw1SSxxaQUdGCwhoRl0DXQ==","queueTime":0,"applicationTime":139,"agent":""}</script>
<script type="text/javascript">window.NREUM||(NREUM={}),__nr_require=function(e,t,n){function r(n){if(!t[n]){var o=t[n]={exports:{}};e[n][0].call(o.exports,function(t){var o=e[n][1][t];return r(o||t)},o,o.exports)}return t[n].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<n.length;o++)r(n[o]);return r}({1:[function(e,t,n){function r(e,t){return function(){o(e,[(new Date).getTime()].concat(a(arguments)),null,t)}}var o=e("handle"),i=e(2),a=e(3);"undefined"==typeof window.newrelic&&(newrelic=NREUM);var u=["setPageViewName","addPageAction","setCustomAttribute","finished","addToTrace","inlineHit"],c=["addPageAction"],f="api-";i(u,function(e,t){newrelic[t]=r(f+t,"api")}),i(c,function(e,t){newrelic[t]=r(f+t)}),t.exports=newrelic,newrelic.noticeError=function(e){"string"==typeof e&&(e=new Error(e)),o("err",[e,(new Date).getTime()])}},{}],2:[function(e,t,n){function r(e,t){var n=[],r="",i=0;for(r in e)o.call(e,r)&&(n[i]=t(r,e[r]),i+=1);return n}var o=Object.prototype.hasOwnProperty;t.exports=r},{}],3:[function(e,t,n){function r(e,t,n){t||(t=0),"undefined"==typeof n&&(n=e?e.length:0);for(var r=-1,o=n-t||0,i=Array(0>o?0:o);++r<o;)i[r]=e[t+r];return i}t.exports=r},{}],ee:[function(e,t,n){function r(){}function o(e){function t(e){return e&&e instanceof r?e:e?u(e,a,i):i()}function n(n,r,o){e&&e(n,r,o);for(var i=t(o),a=l(n),u=a.length,c=0;u>c;c++)a[c].apply(i,r);var s=f[g[n]];return s&&s.push([m,n,r,i]),i}function p(e,t){w[e]=l(e).concat(t)}function l(e){return w[e]||[]}function d(e){return s[e]=s[e]||o(n)}function v(e,t){c(e,function(e,n){t=t||"feature",g[n]=t,t in f||(f[t]=[])})}var w={},g={},m={on:p,emit:n,get:d,listeners:l,context:t,buffer:v};return m}function i(){return new r}var a="nr@context",u=e("gos"),c=e(2),f={},s={},p=t.exports=o();p.backlog=f},{}],gos:[function(e,t,n){function r(e,t,n){if(o.call(e,t))return e[t];var r=n();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(e,t,{value:r,writable:!0,enumerable:!1}),r}catch(i){}return e[t]=r,r}var o=Object.prototype.hasOwnProperty;t.exports=r},{}],handle:[function(e,t,n){function r(e,t,n,r){o.buffer([e],r),o.emit(e,t,n)}var o=e("ee").get("handle");t.exports=r,r.ee=o},{}],id:[function(e,t,n){function r(e){var t=typeof e;return!e||"object"!==t&&"function"!==t?-1:e===window?0:a(e,i,function(){return o++})}var o=1,i="nr@id",a=e("gos");t.exports=r},{}],loader:[function(e,t,n){function r(){if(!w++){var e=v.info=NREUM.info,t=s.getElementsByTagName("script")[0];if(e&&e.licenseKey&&e.applicationID&&t){c(l,function(t,n){e[t]||(e[t]=n)});var n="https"===p.split(":")[0]||e.sslForHttp;v.proto=n?"https://":"http://",u("mark",["onload",a()],null,"api");var r=s.createElement("script");r.src=v.proto+e.agent,t.parentNode.insertBefore(r,t)}}}function o(){"complete"===s.readyState&&i()}function i(){u("mark",["domContent",a()],null,"api")}function a(){return(new Date).getTime()}var u=e("handle"),c=e(2),f=window,s=f.document;NREUM.o={ST:setTimeout,CT:clearTimeout,XHR:f.XMLHttpRequest,REQ:f.Request,EV:f.Event,PR:f.Promise,MO:f.MutationObserver},e(1);var p=""+location,l={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-918.min.js"},d=window.XMLHttpRequest&&XMLHttpRequest.prototype&&XMLHttpRequest.prototype.addEventListener&&!/CriOS/.test(navigator.userAgent),v=t.exports={offset:a(),origin:p,features:{},xhrWrappable:d};s.addEventListener?(s.addEventListener("DOMContentLoaded",i,!1),f.addEventListener("load",r,!1)):(s.attachEvent("onreadystatechange",o),f.attachEvent("onload",r)),u("mark",["firstbyte",a()],null,"api");var w=0},{}]},{},["loader"]);</script>
<title>Chapter 8: Log in, log out
 | Ruby on Rails Tutorial (3rd Ed.) | Softcover.io</title>
<link href="https://www.railstutorial.org/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed">
<link href="https://www.railstutorial.org/favicon.png" rel="icon">
<link href="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/font-awesome.min.css" rel="stylesheet">
<link href="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/css" rel="stylesheet" type="text/css">
<link rel="stylesheet" media="screen" href="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/reading-98324c4b458671e880d44f225c71be40c13b2b700c97a7d2a011bf853f681dec.css">
<link href="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/print-f4bd271fd41b8086410e78c14546336605a29e5c72c2d08b094c7ccfe03de6c4.css" media="print" rel="stylesheet" type="text/css">
<script>
  window.Config = {
    bucket: "softcover",
    previewBucket: "softcover-cloud"
  }
</script>
<script src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/jquery-2.0.3.min.js" type="text/javascript"></script>
<script src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/jquery.formalize.min.js" type="text/javascript"></script>
<script src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/underscore-min.js" type="text/javascript"></script>
<script src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/saved_resource" type="text/javascript"></script>
<script src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/jsapi" type="text/javascript"></script>
<script src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/application-e0d916d98026573fe47e5b8cf39f21e93ffe548362c933ddaf1618037b37252c.js"></script>

<meta content="http://www.railstutorial.org" property="og:url">
<meta content="Ruby on Rails Tutorial (3rd Ed.)" property="og:title">
<meta content="The Ruby on Rails Tutorial book and screencast series teach you how to develop and deploy real, industrial-strength web applications with Ruby on Rails, the open-source web framework that powers top websites such as Twitter, Hulu, GitHub, and the Yellow Pages. The Ruby on Rails Tutorial book is available for free online and is available for purchase as an ebook (PDF, EPUB, and MOBI formats). The companion screencast series includes 12 individual lessons, one for each chapter of the Ruby on Rails Tutorial book. All purchases also include a free copy of the Solutions Manual for Exercises, with solutions to every exercise in the book." property="og:description">
<meta content="Softcover.io" property="og:site_name">
<meta content="https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial_3rd_edition/images/cover-web.png" property="og:image">
<meta content="https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial_3rd_edition/images/cover-web.png" property="og:image:secure_url">
<meta content="image/png" property="og:image:type">
<meta content="500" property="og:image:width">
<meta content="500" property="og:image:height">
<script>
  // test key only
  // this identifies your website in the createToken call below
  Stripe.setPublishableKey('pk_live_Xn1p0BfxqKxkAxtEr03P7wmd');
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('require', 'linker');
  ga('linker:autoLink', ['www.railstutorial.org', 'softcover.io']);

  ga('create', 'UA-46858978-1', 'softcover.io', {'allowLinker': true});
  ga('send', 'pageview');

  ga('create', 'UA-8667566-1', 'auto', {
    'name': 'book',
    'allowLinker': true
  });

  ga('book.send', 'pageview');

</script>

<script type="text/javascript">var _sf_startpt=(new Date()).getTime()</script>


<script src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/custom_domain_js.js" type="text/javascript"></script>
<script type="text/javascript" async="" src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/tagjs"></script><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/saved_resource(1)" width="1" height="1" border="0"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/saved_resource(2)" width="1" height="1" border="0"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/saved_resource(3)" width="1" height="1" border="0"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/saved_resource(4)" width="1" height="1" border="0"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/saved_resource(5)" width="1" height="1" border="0"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/seg" width="1" height="1" border="0"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/seg(1)" width="1" height="1" border="0"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/seg(2)" width="1" height="1" border="0"><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck.RTL {right: .7em; left: auto}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">.fb_hidden{position:absolute;top:-10000px;z-index:10001}.fb_reposition{overflow:hidden;position:relative}.fb_invisible{display:none}.fb_reset{background:none;border:0;border-spacing:0;color:#000;cursor:auto;direction:ltr;font-family:"lucida grande", tahoma, verdana, arial, sans-serif;font-size:11px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:1;margin:0;overflow:visible;padding:0;text-align:left;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;visibility:visible;white-space:normal;word-spacing:normal}.fb_reset>div{overflow:hidden}.fb_link img{border:none}@keyframes fb_transform{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}.fb_animate{animation:fb_transform .3s forwards}
.fb_dialog{background:rgba(82, 82, 82, .7);position:absolute;top:-10000px;z-index:10001}.fb_reset .fb_dialog_legacy{overflow:visible}.fb_dialog_advanced{padding:10px;-moz-border-radius:8px;-webkit-border-radius:8px;border-radius:8px}.fb_dialog_content{background:#fff;color:#333}.fb_dialog_close_icon{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 0 transparent;_background-image:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif);cursor:pointer;display:block;height:15px;position:absolute;right:18px;top:17px;width:15px}.fb_dialog_mobile .fb_dialog_close_icon{top:5px;left:5px;right:auto}.fb_dialog_padding{background-color:transparent;position:absolute;width:1px;z-index:-1}.fb_dialog_close_icon:hover{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -15px transparent;_background-image:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif)}.fb_dialog_close_icon:active{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -30px transparent;_background-image:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif)}.fb_dialog_loader{background-color:#f6f7f8;border:1px solid #606060;font-size:24px;padding:20px}.fb_dialog_top_left,.fb_dialog_top_right,.fb_dialog_bottom_left,.fb_dialog_bottom_right{height:10px;width:10px;overflow:hidden;position:absolute}.fb_dialog_top_left{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 0;left:-10px;top:-10px}.fb_dialog_top_right{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -10px;right:-10px;top:-10px}.fb_dialog_bottom_left{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -20px;bottom:-10px;left:-10px}.fb_dialog_bottom_right{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -30px;right:-10px;bottom:-10px}.fb_dialog_vert_left,.fb_dialog_vert_right,.fb_dialog_horiz_top,.fb_dialog_horiz_bottom{position:absolute;background:#525252;filter:alpha(opacity=70);opacity:.7}.fb_dialog_vert_left,.fb_dialog_vert_right{width:10px;height:100%}.fb_dialog_vert_left{margin-left:-10px}.fb_dialog_vert_right{right:0;margin-right:-10px}.fb_dialog_horiz_top,.fb_dialog_horiz_bottom{width:100%;height:10px}.fb_dialog_horiz_top{margin-top:-10px}.fb_dialog_horiz_bottom{bottom:0;margin-bottom:-10px}.fb_dialog_iframe{line-height:0}.fb_dialog_content .dialog_title{background:#6d84b4;border:1px solid #3a5795;color:#fff;font-size:14px;font-weight:bold;margin:0}.fb_dialog_content .dialog_title>span{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yd/r/Cou7n-nqK52.gif) no-repeat 5px 50%;float:left;padding:5px 0 7px 26px}body.fb_hidden{-webkit-transform:none;height:100%;margin:0;overflow:visible;position:absolute;top:-10000px;left:0;width:100%}.fb_dialog.fb_dialog_mobile.loading{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/ya/r/3rhSv5V8j3o.gif) white no-repeat 50% 50%;min-height:100%;min-width:100%;overflow:hidden;position:absolute;top:0;z-index:10001}.fb_dialog.fb_dialog_mobile.loading.centered{width:auto;height:auto;min-height:initial;min-width:initial;background:none}.fb_dialog.fb_dialog_mobile.loading.centered #fb_dialog_loader_spinner{width:100%}.fb_dialog.fb_dialog_mobile.loading.centered .fb_dialog_content{background:none}.loading.centered #fb_dialog_loader_close{color:#fff;display:block;padding-top:20px;clear:both;font-size:18px}#fb-root #fb_dialog_ipad_overlay{background:rgba(0, 0, 0, .45);position:absolute;bottom:0;left:0;right:0;top:0;width:100%;min-height:100%;z-index:10000}#fb-root #fb_dialog_ipad_overlay.hidden{display:none}.fb_dialog.fb_dialog_mobile.loading iframe{visibility:hidden}.fb_dialog_content .dialog_header{-webkit-box-shadow:white 0 1px 1px -1px inset;background:-webkit-gradient(linear, 0% 0%, 0% 100%, from(#738ABA), to(#2C4987));border-bottom:1px solid;border-color:#1d4088;color:#fff;font:14px Helvetica, sans-serif;font-weight:bold;text-overflow:ellipsis;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0;vertical-align:middle;white-space:nowrap}.fb_dialog_content .dialog_header table{-webkit-font-smoothing:subpixel-antialiased;height:43px;width:100%}.fb_dialog_content .dialog_header td.header_left{font-size:12px;padding-left:5px;vertical-align:middle;width:60px}.fb_dialog_content .dialog_header td.header_right{font-size:12px;padding-right:5px;vertical-align:middle;width:60px}.fb_dialog_content .touchable_button{background:-webkit-gradient(linear, 0% 0%, 0% 100%, from(#4966A6), color-stop(.5, #355492), to(#2A4887));border:1px solid #2f477a;-webkit-background-clip:padding-box;-webkit-border-radius:3px;-webkit-box-shadow:rgba(0, 0, 0, .117188) 0 1px 1px inset, rgba(255, 255, 255, .167969) 0 1px 0;display:inline-block;margin-top:3px;max-width:85px;line-height:18px;padding:4px 12px;position:relative}.fb_dialog_content .dialog_header .touchable_button input{border:none;background:none;color:#fff;font:12px Helvetica, sans-serif;font-weight:bold;margin:2px -12px;padding:2px 6px 3px 6px;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}.fb_dialog_content .dialog_header .header_center{color:#fff;font-size:16px;font-weight:bold;line-height:18px;text-align:center;vertical-align:middle}.fb_dialog_content .dialog_content{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/y9/r/jKEcVPZFk-2.gif) no-repeat 50% 50%;border:1px solid #555;border-bottom:0;border-top:0;height:150px}.fb_dialog_content .dialog_footer{background:#f6f7f8;border:1px solid #555;border-top-color:#ccc;height:40px}#fb_dialog_loader_close{float:left}.fb_dialog.fb_dialog_mobile .fb_dialog_close_button{text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}.fb_dialog.fb_dialog_mobile .fb_dialog_close_icon{visibility:hidden}#fb_dialog_loader_spinner{animation:rotateSpinner 1.2s linear infinite;background-color:transparent;background-image:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yD/r/t-wz8gw1xG1.png);background-repeat:no-repeat;background-position:50% 50%;height:24px;width:24px}@keyframes rotateSpinner{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.fb_iframe_widget{display:inline-block;position:relative}.fb_iframe_widget span{display:inline-block;position:relative;text-align:justify}.fb_iframe_widget iframe{position:absolute}.fb_iframe_widget_fluid_desktop,.fb_iframe_widget_fluid_desktop span,.fb_iframe_widget_fluid_desktop iframe{max-width:100%}.fb_iframe_widget_fluid_desktop iframe{min-width:220px;position:relative}.fb_iframe_widget_lift{z-index:1}.fb_hide_iframes iframe{position:relative;left:-10000px}.fb_iframe_widget_loader{position:relative;display:inline-block}.fb_iframe_widget_fluid{display:inline}.fb_iframe_widget_fluid span{width:100%}.fb_iframe_widget_loader iframe{min-height:32px;z-index:2;zoom:1}.fb_iframe_widget_loader .FB_Loader{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/y9/r/jKEcVPZFk-2.gif) no-repeat;height:32px;width:32px;margin-left:-16px;position:absolute;left:50%;z-index:4}</style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck.RTL {right: .7em; left: auto}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck.RTL {right: .7em; left: auto}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck.RTL {right: .7em; left: auto}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck.RTL {right: .7em; left: auto}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck.RTL {right: .7em; left: auto}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><script id="mathJaxJS" type="text/javascript" src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/MathJax.js"></script><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck.RTL {right: .7em; left: auto}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">.MathJax_Display {text-align: center; margin: 1em 0em; position: relative; display: block!important; text-indent: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; width: 100%}
.MathJax .merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MathJax .MJX-monospace {font-family: monospace}
.MathJax .MJX-sans-serif {font-family: sans-serif}
#MathJax_Tooltip {background-color: InfoBackground; color: InfoText; border: 1px solid black; box-shadow: 2px 2px 5px #AAAAAA; -webkit-box-shadow: 2px 2px 5px #AAAAAA; -moz-box-shadow: 2px 2px 5px #AAAAAA; -khtml-box-shadow: 2px 2px 5px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true'); padding: 3px 4px; z-index: 401; position: absolute; left: 0; top: 0; width: auto; height: auto; display: none}
.MathJax {display: inline; font-style: normal; font-weight: normal; line-height: normal; font-size: 100%; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0}
.MathJax:focus, body :focus .MathJax {display: inline-table}
.MathJax img, .MathJax nobr, .MathJax a {border: 0; padding: 0; margin: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; vertical-align: 0; line-height: normal; text-decoration: none}
img.MathJax_strut {border: 0!important; padding: 0!important; margin: 0!important; vertical-align: 0!important}
.MathJax span {display: inline; position: static; border: 0; padding: 0; margin: 0; vertical-align: 0; line-height: normal; text-decoration: none}
.MathJax nobr {white-space: nowrap!important}
.MathJax img {display: inline!important; float: none!important}
.MathJax * {transition: none; -webkit-transition: none; -moz-transition: none; -ms-transition: none; -o-transition: none}
.MathJax_Processing {visibility: hidden; position: fixed; width: 0; height: 0; overflow: hidden}
.MathJax_Processed {display: none!important}
.MathJax_ExBox {display: block!important; overflow: hidden; width: 1px; height: 60ex; min-height: 0; max-height: none}
.MathJax .MathJax_EmBox {display: block!important; overflow: hidden; width: 1px; height: 60em; min-height: 0; max-height: none}
.MathJax .MathJax_HitBox {cursor: text; background: white; opacity: 0; filter: alpha(opacity=0)}
.MathJax .MathJax_HitBox * {filter: none; opacity: 1; background: transparent}
#MathJax_Tooltip * {filter: none; opacity: 1; background: transparent}
@font-face {font-family: MathJax_Main; src: url('https://cdn.mathjax.org/mathjax/2.6-latest/fonts/HTML-CSS/TeX/woff/MathJax_Main-Regular.woff?rev=2.6.1') format('woff'), url('https://cdn.mathjax.org/mathjax/2.6-latest/fonts/HTML-CSS/TeX/otf/MathJax_Main-Regular.otf?rev=2.6.1') format('opentype')}
@font-face {font-family: MathJax_Main-bold; src: url('https://cdn.mathjax.org/mathjax/2.6-latest/fonts/HTML-CSS/TeX/woff/MathJax_Main-Bold.woff?rev=2.6.1') format('woff'), url('https://cdn.mathjax.org/mathjax/2.6-latest/fonts/HTML-CSS/TeX/otf/MathJax_Main-Bold.otf?rev=2.6.1') format('opentype')}
@font-face {font-family: MathJax_Main-italic; src: url('https://cdn.mathjax.org/mathjax/2.6-latest/fonts/HTML-CSS/TeX/woff/MathJax_Main-Italic.woff?rev=2.6.1') format('woff'), url('https://cdn.mathjax.org/mathjax/2.6-latest/fonts/HTML-CSS/TeX/otf/MathJax_Main-Italic.otf?rev=2.6.1') format('opentype')}
@font-face {font-family: MathJax_Math-italic; src: url('https://cdn.mathjax.org/mathjax/2.6-latest/fonts/HTML-CSS/TeX/woff/MathJax_Math-Italic.woff?rev=2.6.1') format('woff'), url('https://cdn.mathjax.org/mathjax/2.6-latest/fonts/HTML-CSS/TeX/otf/MathJax_Math-Italic.otf?rev=2.6.1') format('opentype')}
@font-face {font-family: MathJax_Caligraphic; src: url('https://cdn.mathjax.org/mathjax/2.6-latest/fonts/HTML-CSS/TeX/woff/MathJax_Caligraphic-Regular.woff?rev=2.6.1') format('woff'), url('https://cdn.mathjax.org/mathjax/2.6-latest/fonts/HTML-CSS/TeX/otf/MathJax_Caligraphic-Regular.otf?rev=2.6.1') format('opentype')}
@font-face {font-family: MathJax_Size1; src: url('https://cdn.mathjax.org/mathjax/2.6-latest/fonts/HTML-CSS/TeX/woff/MathJax_Size1-Regular.woff?rev=2.6.1') format('woff'), url('https://cdn.mathjax.org/mathjax/2.6-latest/fonts/HTML-CSS/TeX/otf/MathJax_Size1-Regular.otf?rev=2.6.1') format('opentype')}
@font-face {font-family: MathJax_Size2; src: url('https://cdn.mathjax.org/mathjax/2.6-latest/fonts/HTML-CSS/TeX/woff/MathJax_Size2-Regular.woff?rev=2.6.1') format('woff'), url('https://cdn.mathjax.org/mathjax/2.6-latest/fonts/HTML-CSS/TeX/otf/MathJax_Size2-Regular.otf?rev=2.6.1') format('opentype')}
@font-face {font-family: MathJax_Size3; src: url('https://cdn.mathjax.org/mathjax/2.6-latest/fonts/HTML-CSS/TeX/woff/MathJax_Size3-Regular.woff?rev=2.6.1') format('woff'), url('https://cdn.mathjax.org/mathjax/2.6-latest/fonts/HTML-CSS/TeX/otf/MathJax_Size3-Regular.otf?rev=2.6.1') format('opentype')}
@font-face {font-family: MathJax_Size4; src: url('https://cdn.mathjax.org/mathjax/2.6-latest/fonts/HTML-CSS/TeX/woff/MathJax_Size4-Regular.woff?rev=2.6.1') format('woff'), url('https://cdn.mathjax.org/mathjax/2.6-latest/fonts/HTML-CSS/TeX/otf/MathJax_Size4-Regular.otf?rev=2.6.1') format('opentype')}
.MathJax .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style></head>
<body class=""><div style="visibility: hidden; overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal;"><div id="MathJax_Hidden"></div></div><div id="MathJax_Message" style="display: none;"></div><div id="MathJax_Message" style="display: none;"></div><div id="MathJax_Message" style="display: none;"></div><div id="MathJax_Message" style="display: none;"></div><div id="MathJax_Message" style="display: none;"></div><div id="MathJax_Message" style="display: none;"></div><div id="MathJax_Message" style="display: none;"></div>
<noscript>
&lt;div id='noscript'&gt;
&lt;h2&gt;Please enable javascript&lt;/h2&gt;
This site requires you to allow JavaScript to run in the browser for all features to work. Thank you!
&lt;/div&gt;
</noscript>
<script type="text/javascript">
!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
window.fbAsyncInit = function() {
FB.init({
appId      : '145973438749643',
xfbml      : true,
version    : 'v2.0'
});
};
(function(d, s, id){
var js, fjs = d.getElementsByTagName(s)[0];
if (d.getElementById(id)) {return;}
js = d.createElement(s); js.id = id;
js.src = "//connect.facebook.net/en_US/sdk.js";
fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script>
<div class="closeLeft container">
<div class="container_footer">
<div id="header">
<div class="wrapper">
<a class="logo" href="https://www.softcover.io/"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/logo-ac6f1f6a838105d63e98f5fd5f2cf2596824a92c61a7f3c2a7aaf884a61e2fc1.png" alt="Logo ac6f1f6a838105d63e98f5fd5f2cf2596824a92c61a7f3c2a7aaf884a61e2fc1">
</a><a id="mobileMenu" href="javascript://"><div class="closedMenu">
≡
<span>Menu</span>
</div>
<div class="openMenu">
x
<span>Close</span>
</div>
</a><div class="j_userHeader closeLeft" style="display:inline"><ul class="headerMenu">
<li><a href="https://www.softcover.io/login">Log In</a></li>
<li><a href="https://www.softcover.io/account/sign_up">Sign Up</a></li>
</ul>
</div>
<div id="dropBG"></div>
<div class="clear"></div>
</div>
</div>

<link rel="stylesheet" media="screen" href="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/custom.css">
<div class="page-book">
<div id="bookHeader">
<div class="wrapper">
<div class="bookCover">
<a href="https://www.railstutorial.org/book"><img class="cover" src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/cover-web.png" alt="Cover web">
<img class="coverBG" src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/cover_bg-e5e0c77fac617f88e7a2088ebb8aac68ac4f978d6ce9e66a77a34d255dbfea02.png" alt="Cover bg e5e0c77fac617f88e7a2088ebb8aac68ac4f978d6ce9e66a77a34d255dbfea02">
<p>
<i class="ibooksMedia iRead"></i>
READ ONLINE FREE
</p>
</a></div>
<div class="bookInfo">
<h1>
Ruby on Rails Tutorial (3rd Ed.)
<span class="j_subtitle">Learn Web Development with Rails</span>
<strong>Michael Hartl</strong>
</h1>
<p class="j_description">
 The Ruby on Rails Tutorial book and screencast series teach you how to develop and deploy real, industrial-strength web applications with Ruby on Rails, the open-source web framework that powers top websites such as Twitter, Hulu, GitHub, and the Yellow Pages. The Ruby on Rails Tutorial book is available for free online and is available for purchase as an ebook (PDF, EPUB, and MOBI formats). The companion screencast series includes 12 individual lessons, one for each chapter of the Ruby on Rails Tutorial book. All purchases also include a free copy of the Solutions Manual for Exercises, with solutions to every exercise in the book. 

</p>

<div class="bookControls">
<a href="https://www.railstutorial.org/"><button class="transBG">Book Info</button>
</a><a href="mailto:admin@railstutorial.org"><button class="transBG">Contact Author</button>
</a></div>

</div>

</div>
</div>

<div id="bookMenu" class="bookMenuFixed">
<div class="side-menu" id="book-side">
<div class="side-menu-toggle">
<a class="side-menu-close" onclick="$(&#39;.page-book&#39;).addClass(&#39;side-menu-closed&#39;)" href="javascript://"><i class="fa fa-close"></i>
</a><a class="side-menu-open" onclick="$(&#39;.page-book&#39;).removeClass(&#39;side-menu-closed&#39;)" href="javascript://"><i class="fa fa-bars"></i>
</a></div>
<ul><li><a>Frontmatter
</a></li><li><a>Chapter 1: From zero to deploy
</a></li><li><a>Chapter 2: A toy app
</a></li><li><a>Chapter 3: Mostly static pages
</a></li><li><a>Chapter 4: Rails-flavored Ruby
</a></li><li><a>Chapter 5: Filling in the layout
</a></li><li><a>Chapter 6: Modeling users
</a></li><li><a>Chapter 7: Sign up
</a></li><li><a>Chapter 8: Log in, log out
</a></li><li><a>Chapter 9: Updating, showing, and deleting users
</a></li><li><a>Chapter 10: Account activation and password reset
</a></li><li><a>Chapter 11: User microposts
</a></li><li><a>Chapter 12: Following users
</a></li></ul>
</div>
<div class="bookMenu-actions j_downloadLinks"><a onclick="$(&#39;#bookMenuEmail&#39;).toggleClass(&#39;open&#39;); return false" href="https://www.railstutorial.org/book/log_in_log_out"><button class="greyButton iEmailUpdate">
<i class="fa fa-heart"></i>
Mailing List
</button>
</a><a class="buttonStyle attention" href="https://www.railstutorial.org/#pricing">Buy Now</a>
<a href="https://www.softcover.io/email-capture/28fdb94f/ruby_on_rails_tutorial_3rd_edition"><button>Download Previews</button>
</a></div>
<div class="bookMenuSize">
<a id="sizeRegular" class="current" href="javascript://"></a>
<a id="sizeBig" href="javascript://"></a>
<a id="sizeBigger" href="javascript://"></a>
</div>
<div class="bookMenuSearch">
<a id="j_singlePage" href="javascript://"><i class="fa fa-search"></i>
Single Page
</a></div>
<div class="bookMenu-arrows">
<a class="leftArrow" href="javascript://">◄</a>
<a class="upArrow" href="javascript://">▲</a>
<a class="rightArrow" href="javascript://">►</a>
<div id="chapter-title">Chapter 8: Log in, log out
</div>
</div>
<div id="bookMenuEmail">
<label>Get a free 8-part email course &amp; priority notifications about the Ruby on Rails Tutorial &amp; related products.</label>

<div class="j_followBookForm"><form action="https://www.softcover.io/books/107/follow" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="✓">
<!-- %input{name: "name", type: "text", placeholder: "YOUR NAME"} -->
<input name="email" placeholder="Your email address" type="text">
<input class="greyButton optClick_follow" type="submit" value="Follow Author">
</form>

</div>
</div>
</div>

<div class="book-wr">
<div id="bookHtml" style="opacity: 1;"><div id="book"><div id="_cha-log_in_log_out" data-tralics-id="cid51" class="chapter" data-number="8" data-chapter="log_in_log_out"><h1><a href="https://www.railstutorial.org/book/log_in_log_out#cha-log_in_log_out" class="heading hyperref"><span class="number">Chapter 8 </span>Log in, log out</a></h1>
<p>Now that new users can sign up for our site (<a href="https://www.railstutorial.org/book/sign_up#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>), it’s time to give them the ability to log in and log out.<span class="intersentencespace"></span> We’ll be implementing all three of the most common models for login/logout behavior on the web: “forgetting” users on browser close (<a href="https://www.railstutorial.org/book/log_in_log_out#sec-sessions_and_failed_login" class="hyperref">Section&nbsp;<span class="ref">8.1</span></a> and <a href="https://www.railstutorial.org/book/log_in_log_out#sec-logging_in" class="hyperref">Section&nbsp;<span class="ref">8.2</span></a>), <em>automatically</em> remembering users (<a href="https://www.railstutorial.org/book/log_in_log_out#sec-remember_me" class="hyperref">Section&nbsp;<span class="ref">8.4</span></a>), and <em>optionally</em> remembering users based on the value of a “remember me” checkbox (<a href="https://www.railstutorial.org/book/log_in_log_out#sec-remember_me_checkbox" class="hyperref">Section&nbsp;<span class="ref">8.4.5</span></a>).<sup id="_cha-8_footnote-ref-1" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-1">1</a></sup></p>
<p>The authentication system we develop in this chapter will allow us to customize the site and implement an authorization model based on login status and identity of the current user.<span class="intersentencespace"></span> For example, in this chapter we’ll update the site header with login/logout links and a profile link.<span class="intersentencespace"></span> In <a href="https://www.railstutorial.org/book/updating_and_deleting_users#cha-updating_showing_and_deleting_users" class="hyperref">Chapter&nbsp;<span class="ref">9</span></a>, we’ll impose a security model in which only logged-in users can visit the user index page, only the correct user can access the page for editing their information, and only administrative users can delete other users from the database.<span class="intersentencespace"></span> Finally, in <a href="https://www.railstutorial.org/book/user_microposts#cha-user_microposts" class="hyperref">Chapter&nbsp;<span class="ref">11</span></a>, we’ll use the identity of a logged-in user to create microposts associated with that user, and in <a href="https://www.railstutorial.org/book/following_users#cha-following_users" class="hyperref">Chapter&nbsp;<span class="ref">12</span></a> we’ll allow the current user to follow other users of the application (thereby receiving a feed of their microposts).</p>
<p>This is a long and challenging chapter covering many detailed aspects of login common systems, so I recommend focusing on completing it section by section.<span class="intersentencespace"></span> In addition, many readers have reported benefiting from going through it a second time.</p>
</div><div id="_sec-sessions_and_failed_login" data-tralics-id="cid52" class="section" data-number="8.1"><h2><a href="https://www.railstutorial.org/book/log_in_log_out#sec-sessions_and_failed_login" class="heading hyperref"><span class="number">8.1 </span>Sessions</a></h2>
<p><a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol" target="_blank">HTTP</a> is a <a href="https://en.wikipedia.org/wiki/Stateless_protocol" target="_blank"><em>stateless protocol</em></a>, treating each request as an independent transaction that is unable to use information from any previous requests.<span class="intersentencespace"></span> This means there is no way <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#HTTP_session_state" target="_blank">within the hypertext transfer protocol</a> to remember a user’s identity from page to page; instead, web applications requiring user login must use a <a href="http://en.wikipedia.org/wiki/Session_(computer_science)" target="_blank"><em>session</em></a>, which is a semi-permanent connection between two computers (such as a client computer running a web browser and a server running Rails).</p>
<p>The most common techniques for implementing sessions in Rails involve using <a href="http://en.wikipedia.org/wiki/HTTP_cookie" target="_blank"><em>cookies</em></a>, which are small pieces of text placed on the user’s browser.<span class="intersentencespace"></span> Because cookies persist from one page to the next, they can store information (such as a user id) that can be used by the application to retrieve the logged-in user from the database.<span class="intersentencespace"></span> In this section and <a href="https://www.railstutorial.org/book/log_in_log_out#sec-logging_in" class="hyperref">Section&nbsp;<span class="ref">8.2</span></a>, we’ll use the Rails method called <code>session</code> to make temporary sessions that expire automatically on browser close,<sup id="_cha-8_footnote-ref-2" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-2">2</a></sup> and then in <a href="https://www.railstutorial.org/book/log_in_log_out#sec-remember_me" class="hyperref">Section&nbsp;<span class="ref">8.4</span></a> we’ll add longer-lived sessions using another Rails method called <code>cookies</code>.</p>
<p>It’s convenient to model sessions as a RESTful resource: visiting the login page will render a form for <em>new</em> sessions, logging in will <em>create</em> a session, and logging out will <em>destroy</em> it.<span class="intersentencespace"></span> Unlike the Users resource, which uses a database back-end (via the User model) to persist data, the Sessions resource will use cookies, and much of the work involved in login comes from building this cookie-based authentication machinery.<span class="intersentencespace"></span> In this section and the next, we’ll prepare for this work by constructing a Sessions controller, a login form, and the relevant controller actions.<span class="intersentencespace"></span> We’ll then complete user login in <a href="https://www.railstutorial.org/book/log_in_log_out#sec-logging_in" class="hyperref">Section&nbsp;<span class="ref">8.2</span></a> by adding the necessary session-manipulation code.</p>
<p>As in previous chapters, we’ll do our work on a topic branch and merge in the changes at the end:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b log-in-log-out
</pre></div></div>
<div id="_sec-sessions_controller" data-tralics-id="uid743" class="subsection" data-number="8.1.1"><h3><a href="https://www.railstutorial.org/book/log_in_log_out#sec-sessions_controller" class="heading hyperref"><span class="number">8.1.1 </span>Sessions controller</a></h3>
<p>The elements of logging in and out correspond to particular REST actions of the Sessions controller: the login form is handled by the <code>new</code> action (covered in this section), actually logging in is handled by sending a <code class="tt">POST</code> request to the <code>create</code> action (<a href="https://www.railstutorial.org/book/log_in_log_out#sec-logging_in" class="hyperref">Section&nbsp;<span class="ref">8.2</span></a>), and logging out is handled by sending a <code class="tt">DELETE</code> request to the <code>destroy</code> action (<a href="https://www.railstutorial.org/book/log_in_log_out#sec-logging_out" class="hyperref">Section&nbsp;<span class="ref">8.3</span></a>).<span class="intersentencespace"></span> (Recall the association of HTTP verbs with REST actions from <a href="https://www.railstutorial.org/book/sign_up#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>.)</p>
<p>To get started, we’ll generate a Sessions controller with a <code>new</code> action:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Sessions new
</pre></div></div>
<p>(Including <code>new</code> actually generates <em>views</em> as well, which is why we don’t include actions like <code>create</code> and <code>destroy</code> that don’t correspond to views.)<span class="intersentencespace"></span> Following the model from <a href="https://www.railstutorial.org/book/sign_up#sec-signup_form" class="hyperref">Section&nbsp;<span class="ref">7.2</span></a> for the signup page, our plan is to create a login form for creating new sessions, as mocked up in <a href="https://www.railstutorial.org/book/log_in_log_out#fig-login_mockup" class="hyperref">Figure&nbsp;<span class="ref">8.1</span></a>.</p>
<div class="center figure" id="_fig-login_mockup" data-tralics-id="uid744" data-number="8.1">
<div class="graphics image box"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/login_mockup.png" alt="images/figures/login_mockup"></div><div class="caption"><span class="header">Figure 8.1: </span><span class="description">A mockup of the login form.
</span></div></div>
<p>Unlike the Users resource, which used the special <code>resources</code> method to obtain a full suite of RESTful routes automatically (<a href="https://www.railstutorial.org/book/sign_up#code-users_resource" class="hyperref">Listing&nbsp;<span class="ref">7.3</span></a>), the Sessions resource will use only named routes, handling <code class="tt">GET</code> and <code class="tt">POST</code> requests with the <code>login</code> route and <code class="tt">DELETE</code> request with the <code>logout</code> route.<span class="intersentencespace"></span> The result appears in <a href="https://www.railstutorial.org/book/log_in_log_out#code-sessions_resource" class="hyperref">Listing&nbsp;<span class="ref">8.1</span></a> (which also deletes the unneeded routes generated by <code>rails generate controller</code>).</p>
<div class="codelisting" id="_code-sessions_resource" data-tralics-id="uid745" data-number="8.1"><div class="heading"><span class="number">Listing 8.1:</span> 

<span class="description">Adding a resource to get the standard RESTful actions for sessions.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span>                <span class="s1">'static_pages#home'</span>
  <span class="n">get</span>    <span class="s1">'help'</span>    <span class="o">=&gt;</span> <span class="s1">'static_pages#help'</span>
  <span class="n">get</span>    <span class="s1">'about'</span>   <span class="o">=&gt;</span> <span class="s1">'static_pages#about'</span>
  <span class="n">get</span>    <span class="s1">'contact'</span> <span class="o">=&gt;</span> <span class="s1">'static_pages#contact'</span>
  <span class="n">get</span>    <span class="s1">'signup'</span>  <span class="o">=&gt;</span> <span class="s1">'users#new'</span>
<span class="hll">  <span class="n">get</span>    <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#new'</span>
</span><span class="hll">  <span class="n">post</span>   <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#create'</span>
</span><span class="hll">  <span class="n">delete</span> <span class="s1">'logout'</span>  <span class="o">=&gt;</span> <span class="s1">'sessions#destroy'</span>
</span>  <span class="n">resources</span> <span class="ss">:users</span>
<span class="k">end</span>
</pre></div></div></div><p>The routes defined in <a href="https://www.railstutorial.org/book/log_in_log_out#code-sessions_resource" class="hyperref">Listing&nbsp;<span class="ref">8.1</span></a> correspond to URLs and actions similar to those for users (<a href="https://www.railstutorial.org/book/sign_up#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>), as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#table-RESTful_sessions" class="hyperref">Table&nbsp;<span class="ref">8.1</span></a>.</p>
<div class="table" id="_table-RESTful_sessions" data-tralics-id="uid746" data-number="8.1"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>HTTP request</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>Named route</strong></td>
<td class="align_left"><strong>Action</strong></td>
<td class="align_left"><strong>Purpose</strong></td>
</tr><tr><td class="align_left"><code class="tt">GET</code></td>
<td class="align_left">/login</td>
<td class="align_left"><code>login_path</code></td>
<td class="align_left"><code>new</code></td>
<td class="align_left">page for a new session (login)</td>
</tr><tr><td class="align_left"><code class="tt">POST</code></td>
<td class="align_left">/login</td>
<td class="align_left"><code>login_path</code></td>
<td class="align_left"><code>create</code></td>
<td class="align_left">create a new session (login)</td>
</tr><tr><td class="align_left"><code class="tt">DELETE</code></td>
<td class="align_left">/logout</td>
<td class="align_left"><code>logout_path</code></td>
<td class="align_left"><code>destroy</code></td>
<td class="align_left">delete a session (log out)</td>
</tr></tbody></table><div class="caption"><span class="header">Table 8.1: </span><span class="description">Routes provided by the sessions rules in <a href="https://www.railstutorial.org/book/log_in_log_out#code-sessions_resource" class="hyperref">Listing&nbsp;<span class="ref">8.1</span></a>.
</span></div></div>
<p>Since we’ve now added several custom named routes, it’s useful to look at the complete list of the routes for our application, which we can generate using <code>rake routes</code>:</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake routes
 Prefix Verb   URI Pattern               Controller#Action
     root GET    /                         static_pages#home
     help GET    /help(.:format)           static_pages#help
    about GET    /about(.:format)          static_pages#about
  contact GET    /contact(.:format)        static_pages#contact
   signup GET    /signup(.:format)         users#new
    login GET    /login(.:format)          sessions#new
          POST   /login(.:format)          sessions#create
   logout DELETE /logout(.:format)         sessions#destroy
    users GET    /users(.:format)          users#index
          POST   /users(.:format)          users#create
 new_user GET    /users/new(.:format)      users#new
edit_user GET    /users/:id/edit(.:format) users#edit
     user GET    /users/:id(.:format)      users#show
          PATCH  /users/:id(.:format)      users#update
          PUT    /users/:id(.:format)      users#update
          DELETE /users/:id(.:format)      users#destroy
</pre></div></div>
<p>It’s not necessary to understand the results in detail, but viewing the routes in this manner gives us a high-level overview of the actions supported by our application.</p>
</div>
<div id="_sec-login_form" data-tralics-id="uid747" class="subsection" data-number="8.1.2"><h3><a href="https://www.railstutorial.org/book/log_in_log_out#sec-login_form" class="heading hyperref"><span class="number">8.1.2 </span>Login form</a></h3>
<p>Having defined the relevant controller and route, now we’ll fill in the view for new sessions, i.e., the login form.<span class="intersentencespace"></span> Comparing <a href="https://www.railstutorial.org/book/log_in_log_out#fig-login_mockup" class="hyperref">Figure&nbsp;<span class="ref">8.1</span></a> with <a href="https://www.railstutorial.org/book/sign_up#fig-signup_mockup" class="hyperref">Figure&nbsp;<span class="ref">7.11</span></a>, we see that the login form is similar in appearance to the signup form, except with two fields (email and password) in place of four.</p>
<p>As seen in <a href="https://www.railstutorial.org/book/log_in_log_out#fig-login_failure_mockup" class="hyperref">Figure&nbsp;<span class="ref">8.2</span></a>, when the login information is invalid we want to re-render the login page and display an error message.<span class="intersentencespace"></span> In <a href="https://www.railstutorial.org/book/sign_up#sec-signup_error_messages" class="hyperref">Section&nbsp;<span class="ref">7.3.3</span></a>, we used an error-messages partial to display error messages, but we saw in that section that those messages are provided automatically by Active Record.<span class="intersentencespace"></span> This won’t work for session creation errors because the session isn’t an Active Record object, so we’ll render the error as a flash message instead.</p>
<div class="center figure" id="_fig-login_failure_mockup" data-tralics-id="uid748" data-number="8.2">
<div class="graphics image box"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/login_failure_mockup.png" alt="images/figures/login_failure_mockup"></div><div class="caption"><span class="header">Figure 8.2: </span><span class="description">A mockup of login failure.
</span></div></div>
<p>Recall from <a href="https://www.railstutorial.org/book/sign_up#code-signup_form" class="hyperref">Listing&nbsp;<span class="ref">7.13</span></a> that the signup form uses the <code>form_for</code> helper, taking as an argument the user instance variable <code>@user</code>:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>The main difference between the session form and the signup form is that we have no Session model, and hence no analogue for the <code>@user</code> variable.<span class="intersentencespace"></span> This means that, in constructing the new session form, we have to give <code>form_for</code> slightly more information; in particular, whereas</p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</pre></div></div>
<p>allows Rails to infer that the <code>action</code> of the form should be to <code class="tt">POST</code> to the URL /users, in the case of sessions we need to indicate the <em>name</em> of the resource and the corresponding URL:<sup id="_cha-8_footnote-ref-3" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-3">3</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">login_path</span><span class="p">)</span>
</pre></div></div>
<p>With the proper <code>form_for</code> in hand, it’s easy to make a login form to match the mockup in <a href="https://www.railstutorial.org/book/log_in_log_out#fig-login_mockup" class="hyperref">Figure&nbsp;<span class="ref">8.1</span></a> using the signup form (<a href="https://www.railstutorial.org/book/sign_up#code-signup_form" class="hyperref">Listing&nbsp;<span class="ref">7.13</span></a>) as a model, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-login_form" class="hyperref">Listing&nbsp;<span class="ref">8.2</span></a>.</p>
<div class="codelisting" id="_code-login_form" data-tralics-id="uid750" data-number="8.2"><div class="heading"><span class="number">Listing 8.2:</span> 

<span class="description">Code for the login form.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/sessions/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Log in"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Log in<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">login_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;p&gt;</span>New user? <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>Note that we’ve added a link to the signup page for convenience.<span class="intersentencespace"></span> With the code in <a href="https://www.railstutorial.org/book/log_in_log_out#code-login_form" class="hyperref">Listing&nbsp;<span class="ref">8.2</span></a>, the login form appears as in <a href="https://www.railstutorial.org/book/log_in_log_out#fig-login_form" class="hyperref">Figure&nbsp;<span class="ref">8.3</span></a>.<span class="intersentencespace"></span> (Because the “Log in” navigation link hasn’t yet been filled in, you’ll have to type the /login URL directly into your address bar.<span class="intersentencespace"></span> We’ll fix this blemish in <a href="https://www.railstutorial.org/book/log_in_log_out#sec-changing_the_layout_links" class="hyperref">Section&nbsp;<span class="ref">8.2.3</span></a>.)</p>
<div class="center figure" id="_fig-login_form" data-tralics-id="uid751" data-number="8.3">
<div class="graphics image"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/login_form.png" alt="images/figures/login_form"></div><div class="caption"><span class="header">Figure 8.3: </span><span class="description">The login form.
</span></div></div>
<p>The generated form HTML appears in <a href="https://www.railstutorial.org/book/log_in_log_out#code-login_form_html" class="hyperref">Listing&nbsp;<span class="ref">8.3</span></a>.</p>
<div class="codelisting" id="_code-login_form_html" data-tralics-id="uid752" data-number="8.3"><div class="heading"><span class="number">Listing 8.3:</span> 

<span class="description">HTML for the login form produced by <a href="https://www.railstutorial.org/book/log_in_log_out#code-login_form" class="hyperref">Listing&nbsp;<span class="ref">8.2</span></a>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">"UTF-8"</span> <span class="na">action=</span><span class="s">"/login"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"utf8"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"&amp;#x2713;"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"authenticity_token"</span> <span class="na">type=</span><span class="s">"hidden"</span>
         <span class="na">value=</span><span class="s">"NNb6+J/j46LcrgYUC60wQ2titMuJQ5lLqyAbnbAUkdo="</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"session_email"</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">id=</span><span class="s">"session_email"</span>
         <span class="na">name=</span><span class="s">"session[email]"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"session_password"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"session_password"</span> <span class="na">name=</span><span class="s">"session[password]"</span>
         <span class="na">type=</span><span class="s">"password"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"btn btn-primary"</span> <span class="na">name=</span><span class="s">"commit"</span> <span class="na">type=</span><span class="s">"submit"</span>
       <span class="na">value=</span><span class="s">"Log in"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div></div></div><p>Comparing <a href="https://www.railstutorial.org/book/log_in_log_out#code-login_form_html" class="hyperref">Listing&nbsp;<span class="ref">8.3</span></a> with <a href="https://www.railstutorial.org/book/sign_up#code-signup_form_html" class="hyperref">Listing&nbsp;<span class="ref">7.15</span></a>, you might be able to guess that submitting this form will result in a <code>params</code> hash where <code>params[:session][:email]</code> and <code>params[:session][:password]</code> correspond to the email and password fields.</p>
</div>
<div id="_sec-finding_and_authenticating_a_user" data-tralics-id="uid753" class="subsection" data-number="8.1.3"><h3><a href="https://www.railstutorial.org/book/log_in_log_out#sec-finding_and_authenticating_a_user" class="heading hyperref"><span class="number">8.1.3 </span>Finding and authenticating a user</a></h3>
<p>As in the case of creating users (signup), the first step in creating sessions (login) is to handle <em>invalid</em> input.<span class="intersentencespace"></span> We’ll start by reviewing what happens when a form gets submitted, and then arrange for helpful error messages to appear in the case of login failure (as mocked up in <a href="https://www.railstutorial.org/book/log_in_log_out#fig-login_failure_mockup" class="hyperref">Figure&nbsp;<span class="ref">8.2</span></a>.)<span class="intersentencespace"></span> Then we’ll lay the foundation for successful login (<a href="https://www.railstutorial.org/book/log_in_log_out#sec-logging_in" class="hyperref">Section&nbsp;<span class="ref">8.2</span></a>) by evaluating each login submission based on the validity of its email/password combination.</p>
<p>Let’s start by defining a minimalist <code>create</code> action for the Sessions controller, along with empty <code>new</code> and <code>destroy</code> actions (<a href="https://www.railstutorial.org/book/log_in_log_out#code-initial_create_session" class="hyperref">Listing&nbsp;<span class="ref">8.4</span></a>).<span class="intersentencespace"></span> The <code>create</code> action in <a href="https://www.railstutorial.org/book/log_in_log_out#code-initial_create_session" class="hyperref">Listing&nbsp;<span class="ref">8.4</span></a> does nothing but render the <code>new</code> view, but it’s enough to get us started.<span class="intersentencespace"></span> Submitting the <a href="http://localhost:3000/sessions/new" target="_blank">/sessions/new</a> form then yields the result shown in <a href="https://www.railstutorial.org/book/log_in_log_out#fig-initial_failed_login_rails_3" class="hyperref">Figure&nbsp;<span class="ref">8.4</span></a>.</p>
<div class="codelisting" id="_code-initial_create_session" data-tralics-id="uid754" data-number="8.4"><div class="heading"><span class="number">Listing 8.4:</span> 

<span class="description">A preliminary version of the Sessions <code>create</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
<span class="hll">    <span class="n">render</span> <span class="s1">'new'</span>
</span>  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="center figure" id="_fig-initial_failed_login_rails_3" data-tralics-id="uid755" data-number="8.4">
<div class="graphics image"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/initial_failed_login_3rd_edition.png" alt="images/figures/initial_failed_login_3rd_edition"></div><div class="caption"><span class="header">Figure 8.4: </span><span class="description">The initial failed login, with <code>create</code> as in <a href="https://www.railstutorial.org/book/log_in_log_out#code-initial_create_session" class="hyperref">Listing&nbsp;<span class="ref">8.4</span></a>.
</span></div></div>
<p>Carefully inspecting the debug information in <a href="https://www.railstutorial.org/book/log_in_log_out#fig-initial_failed_login_rails_3" class="hyperref">Figure&nbsp;<span class="ref">8.4</span></a> shows that, as hinted at the end of <a href="https://www.railstutorial.org/book/log_in_log_out#sec-login_form" class="hyperref">Section&nbsp;<span class="ref">8.1.2</span></a>, the submission results in a <code>params</code> hash containing the email and password under the key <code>session</code>, which (omitting some irrelevant details used internally by Rails) appears as follows:</p>
<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">session</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="s">'user@example.com'</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">'foobar'</span>
<span class="l-Scalar-Plain">commit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Log in</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sessions</span>
</pre></div></div>
<p>As with the case of user signup (<a href="https://www.railstutorial.org/book/sign_up#fig-signup_failure" class="hyperref">Figure&nbsp;<span class="ref">7.15</span></a>), these parameters form a <em>nested</em> hash like the one we saw in <a href="https://www.railstutorial.org/book/rails_flavored_ruby#code-nested_hashes" class="hyperref">Listing&nbsp;<span class="ref">4.10</span></a>.<span class="intersentencespace"></span> In particular, <code>params</code> contains a nested hash of the form</p>
<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span> <span class="p">}</span> <span class="p">}</span>
</pre></div></div>
<p>This means that</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">]</span>
</pre></div></div>
<p>is itself a hash:</p>
<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span> <span class="p">}</span>
</pre></div></div>
<p>As a result,</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span>
</pre></div></div>
<p>is the submitted email address and</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span>
</pre></div></div>
<p>is the submitted password.</p>
<p>In other words, inside the <code>create</code> action the <code>params</code> hash has all the information needed to authenticate users by email and password.<span class="intersentencespace"></span> Not coincidentally, we already have exactly the methods we need: the <code>User.find_by</code> method provided by Active Record (<a href="https://www.railstutorial.org/book/modeling_users#sec-finding_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.4</span></a>) and the <code>authenticate</code> method provided by <code>has_secure_password</code> (<a href="https://www.railstutorial.org/book/modeling_users#sec-creating_and_authenticating_a_user" class="hyperref">Section&nbsp;<span class="ref">6.3.4</span></a>).<span class="intersentencespace"></span> Recalling that <code>authenticate</code> returns <code>false</code> for an invalid authentication (<a href="https://www.railstutorial.org/book/modeling_users#sec-creating_and_authenticating_a_user" class="hyperref">Section&nbsp;<span class="ref">6.3.4</span></a>), our strategy for user login can be summarized as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-find_authenticate_user" class="hyperref">Listing&nbsp;<span class="ref">8.5</span></a>.</p>
<div class="codelisting" id="_code-find_authenticate_user" data-tralics-id="uid756" data-number="8.5"><div class="heading"><span class="number">Listing 8.5:</span> 

<span class="description">Finding and authenticating a user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
<span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</span>      <span class="c1"># Log the user in and redirect to the user's show page.</span>
    <span class="k">else</span>
      <span class="c1"># Create an error message.</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The first highlighted line in <a href="https://www.railstutorial.org/book/log_in_log_out#code-find_authenticate_user" class="hyperref">Listing&nbsp;<span class="ref">8.5</span></a> pulls the user out of the database using the submitted email address.<span class="intersentencespace"></span> (Recall from <a href="https://www.railstutorial.org/book/modeling_users#sec-uniqueness_validation" class="hyperref">Section&nbsp;<span class="ref">6.2.5</span></a> that email addresses are saved as all lower-case, so here we use the <code>downcase</code> method to ensure a match when the submitted address is valid.)<span class="intersentencespace"></span> The next line can be a bit confusing but is fairly common in idiomatic Rails programming:</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>This uses <code>&amp;&amp;</code> (logical <em>and</em>) to determine if the resulting user is valid.<span class="intersentencespace"></span> Taking into account that any object other than <code>nil</code> and <code>false</code> itself is <code>true</code> in a boolean context (<a href="https://www.railstutorial.org/book/rails_flavored_ruby#sec-objects_and_message_passing" class="hyperref">Section&nbsp;<span class="ref">4.2.3</span></a>), the possibilities appear as in <a href="https://www.railstutorial.org/book/log_in_log_out#table-user_and_and" class="hyperref">Table&nbsp;<span class="ref">8.2</span></a>.<span class="intersentencespace"></span> We see from <a href="https://www.railstutorial.org/book/log_in_log_out#table-user_and_and" class="hyperref">Table&nbsp;<span class="ref">8.2</span></a> that the <code>if</code> statement is <code>true</code> only if a user with the given email both exists in the database and has the given password, exactly as required.</p>
<div class="table" id="_table-user_and_and" data-tralics-id="uid757" data-number="8.2"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>User</strong></td>
<td class="align_left"><strong>Password</strong></td>
<td class="align_left"><strong>a &amp;&amp; b</strong></td>
</tr><tr><td class="align_left">nonexistent</td>
<td class="align_left"><em>anything</em></td>
<td class="align_left"><code>(nil &amp;&amp; [anything]) == false</code></td>
</tr><tr><td class="align_left">valid user</td>
<td class="align_left">wrong password</td>
<td class="align_left"><code>(true &amp;&amp; false) == false</code></td>
</tr><tr><td class="align_left">valid user</td>
<td class="align_left">right password</td>
<td class="align_left"><code>(true &amp;&amp; true) == true</code></td>
</tr></tbody></table><div class="caption"><span class="header">Table 8.2: </span><span class="description">Possible results of <code>user &amp;&amp; user.authenticate(…)</code>.
</span></div></div>
</div>
<div id="_sec-rendering_with_a_flash_message" data-tralics-id="uid758" class="subsection" data-number="8.1.4"><h3><a href="https://www.railstutorial.org/book/log_in_log_out#sec-rendering_with_a_flash_message" class="heading hyperref"><span class="number">8.1.4 </span>Rendering with a flash message</a></h3>
<p>Recall from <a href="https://www.railstutorial.org/book/sign_up#sec-signup_error_messages" class="hyperref">Section&nbsp;<span class="ref">7.3.3</span></a> that we displayed signup errors using the User model error messages.<span class="intersentencespace"></span> These errors are associated with a particular Active Record object, but this strategy won’t work here because the session isn’t an Active Record model.<span class="intersentencespace"></span> Instead, we’ll put a message in the flash to be displayed upon failed login.<span class="intersentencespace"></span> A first, slightly incorrect, attempt appears in <a href="https://www.railstutorial.org/book/log_in_log_out#code-failed_login_attempt" class="hyperref">Listing&nbsp;<span class="ref">8.6</span></a>.</p>
<div class="codelisting" id="_code-failed_login_attempt" data-tralics-id="uid759" data-number="8.6"><div class="heading"><span class="number">Listing 8.6:</span> 

<span class="description">An (unsuccessful) attempt at handling failed login.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># Log the user in and redirect to the user's show page.</span>
    <span class="k">else</span>
<span class="hll">      <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span> <span class="c1"># Not quite right!</span>
</span>      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Because of the flash message display in the site layout (<a href="https://www.railstutorial.org/book/sign_up#code-layout_flash" class="hyperref">Listing&nbsp;<span class="ref">7.25</span></a>), the <code>flash[:danger]</code> message automatically gets displayed; because of the Bootstrap CSS, it automatically gets nice styling (<a href="https://www.railstutorial.org/book/log_in_log_out#fig-failed_login_flash" class="hyperref">Figure&nbsp;<span class="ref">8.5</span></a>).</p>
<div class="center figure" id="_fig-failed_login_flash" data-tralics-id="uid760" data-number="8.5">
<div class="graphics image"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/failed_login_flash_3rd_edition.png" alt="images/figures/failed_login_flash_3rd_edition"></div><div class="caption"><span class="header">Figure 8.5: </span><span class="description">The flash message for a failed login.
</span></div></div>
<p>Unfortunately, as noted in the text and in the comment in <a href="https://www.railstutorial.org/book/log_in_log_out#code-failed_login_attempt" class="hyperref">Listing&nbsp;<span class="ref">8.6</span></a>, this code isn’t quite right.<span class="intersentencespace"></span> The page looks fine, though, so what’s the problem?<span class="intersentencespace"></span> The issue is that the contents of the flash persist for one <em>request</em>, but—unlike a redirect, which we used in <a href="https://www.railstutorial.org/book/sign_up#code-signup_flash" class="hyperref">Listing&nbsp;<span class="ref">7.24</span></a>—re-rendering a template with <code>render</code> doesn’t count as a request.<span class="intersentencespace"></span> The result is that the flash message persists one request longer than we want.<span class="intersentencespace"></span> For example, if we submit invalid login information and then click on the Home page, the flash gets displayed a second time (<a href="https://www.railstutorial.org/book/log_in_log_out#fig-flash_persistence" class="hyperref">Figure&nbsp;<span class="ref">8.6</span></a>).<span class="intersentencespace"></span> Fixing this blemish is the task of <a href="https://www.railstutorial.org/book/log_in_log_out#sec-a_flash_test" class="hyperref">Section&nbsp;<span class="ref">8.1.5</span></a>.</p>
<div class="center figure" id="_fig-flash_persistence" data-tralics-id="uid761" data-number="8.6">
<div class="graphics image"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/flash_persistence_3rd_edition.png" alt="images/figures/flash_persistence_3rd_edition"></div><div class="caption"><span class="header">Figure 8.6: </span><span class="description">An example of flash persistence.
</span></div></div>
</div>
<div id="_sec-a_flash_test" data-tralics-id="uid762" class="subsection" data-number="8.1.5"><h3><a href="https://www.railstutorial.org/book/log_in_log_out#sec-a_flash_test" class="heading hyperref"><span class="number">8.1.5 </span>A flash test</a></h3>
<p>The incorrect flash behavior is a minor bug in our application.<span class="intersentencespace"></span> According to the testing guidelines from <a href="https://www.railstutorial.org/book/static_pages#aside-when_to_test" class="hyperref">Box&nbsp;<span class="ref">3.3</span></a>, this is exactly the sort of situation where we should write a test to catch the error so that it doesn’t recur.<span class="intersentencespace"></span> We’ll thus write a short integration test for the login form submission before proceeding.<span class="intersentencespace"></span> In addition to documenting the bug and preventing a regression, this will also give us a good foundation for further integration tests of login and logout.</p>
<p>We start by generating an integration test for our application’s login behavior:</p>
<div class="code"><div class="highlight"><pre><span class="hll"><span class="gp">$</span> rails generate integration_test users_login
</span><span class="go">      invoke  test_unit</span>
<span class="go">      create    test/integration/users_login_test.rb</span>
</pre></div></div>
<p>Next, we need a test to capture the sequence shown in <a href="https://www.railstutorial.org/book/log_in_log_out#fig-failed_login_flash" class="hyperref">Figure&nbsp;<span class="ref">8.5</span></a> and <a href="https://www.railstutorial.org/book/log_in_log_out#fig-flash_persistence" class="hyperref">Figure&nbsp;<span class="ref">8.6</span></a>.<span class="intersentencespace"></span> The basic steps appear as follows:</p>
<ol>
<li>Visit the login path.<span class="intersentencespace"></span>
</li>
<li>Verify that the new sessions form renders properly.<span class="intersentencespace"></span>
</li>
<li>Post to the sessions path with an invalid <code>params</code> hash.<span class="intersentencespace"></span>
</li>
<li>Verify that the new sessions form gets re-rendered and that a flash message appears.<span class="intersentencespace"></span>
</li>
<li>Visit another page (such as the Home page).<span class="intersentencespace"></span>
</li>
<li>Verify that the flash message <em>doesn’t</em> appear on the new page.<span class="intersentencespace"></span>
</li></ol>
<p>A test implementing the above steps appears in <a href="https://www.railstutorial.org/book/log_in_log_out#code-flash_persistence_test" class="hyperref">Listing&nbsp;<span class="ref">8.7</span></a>.</p>
<div class="codelisting" id="_code-flash_persistence_test" data-tralics-id="uid769" data-number="8.7"><div class="heading"><span class="number">Listing 8.7:</span> 

<span class="description">A test to catch unwanted flash persistence.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_login_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersLoginTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="nb">test</span> <span class="s2">"login with invalid information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">login_path</span>
    <span class="n">assert_template</span> <span class="s1">'sessions/new'</span>
    <span class="n">post</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span> <span class="s2">""</span> <span class="p">}</span>
    <span class="n">assert_template</span> <span class="s1">'sessions/new'</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">get</span> <span class="n">root_path</span>
    <span class="n">assert</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>After adding the test in <a href="https://www.railstutorial.org/book/log_in_log_out#code-flash_persistence_test" class="hyperref">Listing&nbsp;<span class="ref">8.7</span></a>, the login test should be <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="_uid770" data-tralics-id="uid770" data-number="8.8"><div class="heading"><span class="number">Listing 8.8:</span> <span class="description"><span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test TEST=test/integration/users_login_test.rb
</pre></div></div></div><p>This shows how to run one (and only one) test file using the argument <code>TEST</code> and the full path to the file.</p>
<p>The way to get the failing test in <a href="https://www.railstutorial.org/book/log_in_log_out#code-flash_persistence_test" class="hyperref">Listing&nbsp;<span class="ref">8.7</span></a> to pass is to replace <code>flash</code> with the special variant <code>flash.now</code>, which is specifically designed for displaying flash messages on rendered pages.<span class="intersentencespace"></span> Unlike the contents of <code>flash</code>, the contents of <code>flash.now</code> disappear as soon as there is an additional request, which is exactly the behavior we’ve tested in <a href="https://www.railstutorial.org/book/log_in_log_out#code-flash_persistence_test" class="hyperref">Listing&nbsp;<span class="ref">8.7</span></a>.<span class="intersentencespace"></span> With this substitution, the corrected application code appears as in <a href="https://www.railstutorial.org/book/log_in_log_out#code-correct_login_failure" class="hyperref">Listing&nbsp;<span class="ref">8.9</span></a>.</p>
<div class="codelisting" id="_code-correct_login_failure" data-tralics-id="uid771" data-number="8.9"><div class="heading"><span class="number">Listing 8.9:</span> 

<span class="description">Correct code for failed login.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># Log the user in and redirect to the user's show page.</span>
    <span class="k">else</span>
<span class="hll">      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
</span>      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>We can then verify that both the login integration test and the full test suite are <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="_uid772" data-tralics-id="uid772" data-number="8.10"><div class="heading"><span class="number">Listing 8.10:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test TEST=test/integration/users_login_test.rb
$ bundle exec rake test
</pre></div></div></div></div></div><div id="_sec-logging_in" data-tralics-id="cid53" class="section" data-number="8.2"><h2><a href="https://www.railstutorial.org/book/log_in_log_out#sec-logging_in" class="heading hyperref"><span class="number">8.2 </span>Logging in</a></h2>
<p>Now that our login form can handle invalid submissions, the next step is to handle valid submissions correctly by actually logging a user in.<span class="intersentencespace"></span> In this section, we’ll log the user in with a temporary session cookie that expires automatically upon browser close.<span class="intersentencespace"></span> In <a href="https://www.railstutorial.org/book/log_in_log_out#sec-remember_me" class="hyperref">Section&nbsp;<span class="ref">8.4</span></a>, we’ll add sessions that persist even after closing the browser.</p>
<p>Implementing sessions will involve defining a large number of related functions for use across multiple controllers and views.<span class="intersentencespace"></span> You may recall from <a href="https://www.railstutorial.org/book/rails_flavored_ruby#sec-back_to_the_title_helper" class="hyperref">Section&nbsp;<span class="ref">4.2.5</span></a> that Ruby provides a <em>module</em> facility for packaging such functions in one place.<span class="intersentencespace"></span> Conveniently, a Sessions helper module was generated automatically when generating the Sessions controller (<a href="https://www.railstutorial.org/book/log_in_log_out#sec-sessions_controller" class="hyperref">Section&nbsp;<span class="ref">8.1.1</span></a>).<span class="intersentencespace"></span> Moreover, such helpers are automatically included in Rails views; by including the module into the base class of all controllers (the Application controller), we arrange to make them available in our controllers as well (<a href="https://www.railstutorial.org/book/log_in_log_out#code-sessions_helper_include" class="hyperref">Listing&nbsp;<span class="ref">8.11</span></a>).</p>
<div class="codelisting" id="_code-sessions_helper_include" data-tralics-id="uid773" data-number="8.11"><div class="heading"><span class="number">Listing 8.11:</span> 

<span class="description">Including the Sessions helper module into the Application controller.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/application_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with</span><span class="p">:</span> <span class="ss">:exception</span>
<span class="hll">  <span class="kp">include</span> <span class="no">SessionsHelper</span>
</span><span class="k">end</span>
</pre></div></div></div><p>With this configuration complete, we’re now ready to write the code to log users in.</p>
<div id="_sec-a_working_log_in_method" data-tralics-id="uid774" class="subsection" data-number="8.2.1"><h3><a href="https://www.railstutorial.org/book/log_in_log_out#sec-a_working_log_in_method" class="heading hyperref"><span class="number">8.2.1 </span>The <code class="tt">log_in</code> method</a></h3>
<p>Logging a user in is simple with the help of the <code>session</code> method defined by Rails.<span class="intersentencespace"></span> (This method is separate and distinct from the Sessions controller generated in <a href="https://www.railstutorial.org/book/log_in_log_out#sec-sessions_controller" class="hyperref">Section&nbsp;<span class="ref">8.1.1</span></a>.)<span class="intersentencespace"></span> We can treat <code>session</code> as if it were a hash, and assign to it as follows:</p>
<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</pre></div></div>
<p>This places a temporary cookie on the user’s browser containing an encrypted version of the user’s id, which allows us to retrieve the id on subsequent pages using <code>session[:user_id]</code>.<span class="intersentencespace"></span> In contrast to the persistent cookie created by the <code>cookies</code> method (<a href="https://www.railstutorial.org/book/log_in_log_out#sec-remember_me" class="hyperref">Section&nbsp;<span class="ref">8.4</span></a>), the temporary cookie created by the <code>session</code> method expires immediately when the browser is closed.</p>
<p>Because we’ll want to use the same login technique in a couple of different places, we’ll define a method called <code>log_in</code> in the Sessions helper, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-log_in_function" class="hyperref">Listing&nbsp;<span class="ref">8.12</span></a>.</p>
<div class="codelisting" id="_code-log_in_function" data-tralics-id="uid775" data-number="8.12"><div class="heading"><span class="number">Listing 8.12:</span> 

<span class="description">The <code>log_in</code> function.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># Logs in the given user.</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="hll">    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Because temporary cookies created using the <code>session</code> method are automatically encrypted, the code in <a href="https://www.railstutorial.org/book/log_in_log_out#code-log_in_function" class="hyperref">Listing&nbsp;<span class="ref">8.12</span></a> is secure, and there is no way for an attacker to use the session information to log in as the user.<span class="intersentencespace"></span> This applies only to temporary sessions initiated with the <code>session</code> method, though, and is <em>not</em> the case for persistent sessions created using the <code>cookies</code> method.<span class="intersentencespace"></span> Permanent cookies are vulnerable to a <em>session hijacking</em> attack, so in <a href="https://www.railstutorial.org/book/log_in_log_out#sec-remember_me" class="hyperref">Section&nbsp;<span class="ref">8.4</span></a> we’ll have to be much more careful about the information we place on the user’s browser.</p>
<p>With the <code>log_in</code> method defined in <a href="https://www.railstutorial.org/book/log_in_log_out#code-log_in_function" class="hyperref">Listing&nbsp;<span class="ref">8.12</span></a>, we’re now ready to complete the session <code>create</code> action by logging the user in and redirecting to the user’s profile page.<span class="intersentencespace"></span> The result appears in <a href="https://www.railstutorial.org/book/log_in_log_out#code-log_in_success" class="hyperref">Listing&nbsp;<span class="ref">8.13</span></a>.<sup id="_cha-8_footnote-ref-4" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-4">4</a></sup></p>
<div class="codelisting" id="_code-log_in_success" data-tralics-id="uid777" data-number="8.13"><div class="heading"><span class="number">Listing 8.13:</span> 

<span class="description">Logging in a user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
<span class="hll">      <span class="n">log_in</span> <span class="n">user</span>
</span><span class="hll">      <span class="n">redirect_to</span> <span class="n">user</span>
</span>    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note the compact redirect</p>
<div class="code"><div class="highlight"><pre><span class="n">redirect_to</span> <span class="n">user</span>
</pre></div></div>
<p>which we saw before in <a href="https://www.railstutorial.org/book/sign_up#sec-the_finished_signup_form" class="hyperref">Section&nbsp;<span class="ref">7.4.1</span></a>.<span class="intersentencespace"></span> Rails automatically converts this to the route for the user’s profile page:</p>
<div class="code"><div class="highlight"><pre><span class="n">user_url</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>With the <code>create</code> action defined in <a href="https://www.railstutorial.org/book/log_in_log_out#code-log_in_success" class="hyperref">Listing&nbsp;<span class="ref">8.13</span></a>, the login form defined in <a href="https://www.railstutorial.org/book/log_in_log_out#code-login_form" class="hyperref">Listing&nbsp;<span class="ref">8.2</span></a> should now be working.<span class="intersentencespace"></span> It doesn’t have any effects on the application display, though, so short of inspecting the browser session directly there’s no way to tell that you’re logged in.<span class="intersentencespace"></span> As a first step toward enabling more visible changes, in <a href="https://www.railstutorial.org/book/log_in_log_out#sec-current_user" class="hyperref">Section&nbsp;<span class="ref">8.2.2</span></a> we’ll retrieve the current user from the database using the id in the session.<span class="intersentencespace"></span> In <a href="https://www.railstutorial.org/book/log_in_log_out#sec-changing_the_layout_links" class="hyperref">Section&nbsp;<span class="ref">8.2.3</span></a>, we’ll change the links on the application layout, including a URL to the current user’s profile.</p>
</div>
<div id="_sec-current_user" data-tralics-id="uid778" class="subsection" data-number="8.2.2"><h3><a href="https://www.railstutorial.org/book/log_in_log_out#sec-current_user" class="heading hyperref"><span class="number">8.2.2 </span>Current user</a></h3>
<p>Having placed the user’s id securely in the temporary session, we are now in a position to retrieve it on subsequent pages, which we’ll do by defining a <code>current_user</code> method to find the user in the database corresponding to the session id.<span class="intersentencespace"></span> The purpose of <code>current_user</code> is to allow constructions such as</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>and</p>
<div class="code"><div class="highlight"><pre><span class="n">redirect_to</span> <span class="n">current_user</span>
</pre></div></div>
<p>To find the current user, one possibility is to use the <code>find</code> method, as on the user profile page (<a href="https://www.railstutorial.org/book/sign_up#code-user_show_action" class="hyperref">Listing&nbsp;<span class="ref">7.5</span></a>):</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>But recall from <a href="https://www.railstutorial.org/book/modeling_users#sec-finding_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.4</span></a> that <code>find</code> raises an exception if the user id doesn’t exist.<span class="intersentencespace"></span> This behavior is appropriate on the user profile page because it will only happen if the id is invalid, but in the present case <code>session[:user_id]</code> will often be <code>nil</code> (i.e., for non-logged-in users).<span class="intersentencespace"></span> To handle this possibility, we’ll use the same <code>find_by</code> method used to find by email address in the <code>create</code> method, with <code>id</code> in place of <code>email</code>:</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>Rather than raising an exception, this method returns <code>nil</code> (indicating no such user) if the id is invalid.</p>
<p>We could now define the <code>current_user</code> method as follows:</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">current_user</span>
  <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>This would work fine, but it would hit the database multiple times if, e.g., <code>current_user</code> appeared multiple times on a page.<span class="intersentencespace"></span> Instead, we’ll follow a common Ruby convention by storing the result of <code>User.find_by</code> in an instance variable, which hits the database the first time but returns the instance variable immediately on subsequent invocations:<sup id="_cha-8_footnote-ref-5" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-5">5</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="vi">@current_user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="vi">@current_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
<span class="k">else</span>
  <span class="vi">@current_user</span>
<span class="k">end</span>
</pre></div></div>
<p>Recalling the <em>or</em>&nbsp;operator <code class="tt">||</code> seen in <a href="https://www.railstutorial.org/book/rails_flavored_ruby#sec-objects_and_message_passing" class="hyperref">Section&nbsp;<span class="ref">4.2.3</span></a>, we can rewrite this as follows:</p>
<div class="code"><div class="highlight"><pre><span class="vi">@current_user</span> <span class="o">=</span> <span class="vi">@current_user</span> <span class="o">||</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>Because a User object is true in a boolean context, the call to <code>find_by</code> only gets executed if <code>@current_user</code> hasn’t yet been assigned.</p>
<p>Although the preceding code would work, it’s not idiomatically correct Ruby; instead, the proper way to write the assignment to <code>@current_user</code> is like this:</p>
<div class="code"><div class="highlight"><pre><span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>This uses the potentially confusing but frequently used <code>||=</code> (“or equals”) operator (<a href="https://www.railstutorial.org/book/log_in_log_out#aside-or_equals" class="hyperref">Box&nbsp;<span class="ref">8.1</span></a>).</p>
<div class="aside" id="_aside-or_equals" data-tralics-id="uid780" data-number="8.1"><div class="heading"><span class="number">Box 8.1.</span> 

<span class="description">What the *$@!<span class="intersentencespace"></span> is <code class="tt">||=</code> ?<span class="intersentencespace"></span> </span></div>
<p>The <code class="tt">||=</code> (“or equals”) assignment operator is a common Ruby idiom and is thus important for aspiring Rails developers to recognize.<span class="intersentencespace"></span> Although at first it may seem mysterious, <em>or equals</em> is easy to understand by analogy.</p>
<p>We start by noting the common pattern of incrementing a variable:</p>
<pre>  x = x + 1</pre>
<p>Many languages provide a syntactic shortcut for this operation; in Ruby (and in C, C++, Perl, Python, Java, etc.), it can also appear as follows:</p>
<pre>  x += 1</pre>
<p>Analogous constructs exist for other operators as well:</p>
<pre>  $ rails console
  &gt;&gt; x = 1
  =&gt; 1
  &gt;&gt; x += 1
  =&gt; 2
  &gt;&gt; x *= 3
  =&gt; 6
  &gt;&gt; x -= 8
  =&gt; -2
  &gt;&gt; x /= 2
  =&gt; -1</pre>
<p>In each case, the pattern is that <code class="tt">x = x O y</code> and <code class="tt">x O= y</code> are equivalent for any operator <code class="tt">O</code>.</p>
<p>Another common Ruby pattern is assigning to a variable if it’s <code class="tt">nil</code> but otherwise leaving it alone.<span class="intersentencespace"></span> Recalling the <em>or</em>&nbsp;operator <code class="tt">||</code> seen in <a href="https://www.railstutorial.org/book/rails_flavored_ruby#sec-objects_and_message_passing" class="hyperref">Section&nbsp;<span class="ref">4.2.3</span></a>, we can write this as follows:</p>
<pre>  &gt;&gt; @foo
  =&gt; nil
  &gt;&gt; @foo = @foo || "bar"
  =&gt; "bar"
  &gt;&gt; @foo = @foo || "baz"
  =&gt; "bar"</pre>
<p>Since <code class="tt">nil</code> is false in a boolean context, the first assignment to <code class="tt">@foo</code> is <code class="tt">nil || "bar"</code>, which evaluates to <code class="tt">"bar"</code>.<span class="intersentencespace"></span> Similarly, the second assignment is <code class="tt">@foo || "baz"</code>, i.e., <code class="tt">"bar" || "baz"</code>, which also evaluates to <code class="tt">"bar"</code>.<span class="intersentencespace"></span> This is because anything other than <code class="tt">nil</code> or <code class="tt">false</code> is <code class="tt">true</code> in a boolean context, and the series of <code class="tt">||</code> expressions terminates after the first true expression is evaluated.<span class="intersentencespace"></span> (This practice of evaluating <code class="tt">||</code> expressions from left to right and stopping on the first true value is known as <em>short-circuit evaluation</em>.<span class="intersentencespace"></span> The same principle applies to <code class="tt">&amp;&amp;</code> statements, except in this case evaluation stops on the first <em>false</em> value.)</p>
<p>Comparing the console sessions for the various operators, we see that <code class="tt">@foo = @foo || "bar"</code> follows the <code class="tt">x = x O y</code> pattern with <code class="tt">||</code> in the place of <code class="tt">O</code>:</p>
<pre>  x    =   x   +   1      -&gt;     x     +=   1
  x    =   x   *   3      -&gt;     x     *=   3
  x    =   x   -   8      -&gt;     x     -=   8
  x    =   x   /   2      -&gt;     x     /=   2
  @foo = @foo || "bar"    -&gt;     @foo ||= "bar"</pre>
<p>Thus we see that <span class="inline_verbatim">@foo = @foo || "bar"</span> and <span class="inline_verbatim">@foo ||= "bar"</span> are equivalent.<span class="intersentencespace"></span> In the context of the current user, this suggests the following construction:</p>
<pre>@current_user ||= User.find_by(id: session[:user_id])</pre>
<p>Voilà&nbsp;!</p>
<p>(By the way, under the hood Ruby actually evaluates the expression <code class="tt">@foo || @foo = "bar"</code>, which avoids an unnecessary assignment when <code class="tt">@foo</code> is <code class="tt">nil</code> or <code class="tt">false</code>.<span class="intersentencespace"></span> But this expression doesn’t explain the <code class="tt">||=</code> notation as well, so the above discussion uses the nearly equivalent <code class="tt">@foo = @foo || "bar"</code>.)</p>

</div><p>Applying the results of the above discussion yields the succinct <code>current_user</code> method shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-current_user" class="hyperref">Listing&nbsp;<span class="ref">8.14</span></a>.</p>
<div class="codelisting" id="_code-current_user" data-tralics-id="uid781" data-number="8.14"><div class="heading"><span class="number">Listing 8.14:</span> 

<span class="description">Finding the current user in the session.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># Logs in the given user.</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>

  <span class="c1"># Returns the current logged-in user (if any).</span>
  <span class="k">def</span> <span class="nf">current_user</span>
<span class="hll">    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the working <code>current_user</code> method in <a href="https://www.railstutorial.org/book/log_in_log_out#code-current_user" class="hyperref">Listing&nbsp;<span class="ref">8.14</span></a>, we’re now in a position to make changes to our application based on user login status.</p>
</div>
<div id="_sec-changing_the_layout_links" data-tralics-id="uid782" class="subsection" data-number="8.2.3"><h3><a href="https://www.railstutorial.org/book/log_in_log_out#sec-changing_the_layout_links" class="heading hyperref"><span class="number">8.2.3 </span>Changing the layout links</a></h3>
<p>The first practical application of logging in involves changing the layout links based on login status.<span class="intersentencespace"></span> In particular, as seen in the <a href="https://www.railstutorial.org/book/log_in_log_out#fig-login_success_mockup" class="hyperref">Figure&nbsp;<span class="ref">8.7</span></a> mockup,<sup id="_cha-8_footnote-ref-6" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-6">6</a></sup> we’ll add links for logging out, for user settings, for listing all users, and for the current user’s profile page.<span class="intersentencespace"></span> Note in <a href="https://www.railstutorial.org/book/log_in_log_out#fig-login_success_mockup" class="hyperref">Figure&nbsp;<span class="ref">8.7</span></a> that the logout and profile links appear in a dropdown “Account” menu; we’ll see in <a href="https://www.railstutorial.org/book/log_in_log_out#code-layout_login_logout_links" class="hyperref">Listing&nbsp;<span class="ref">8.16</span></a> how to make such a menu with Bootstrap.</p>
<div class="center figure" id="_fig-login_success_mockup" data-tralics-id="uid784" data-number="8.7">
<div class="graphics image box"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/login_success_mockup.png" alt="images/figures/login_success_mockup"></div><div class="caption"><span class="header">Figure 8.7: </span><span class="description">A mockup of the user profile after a successful login.
</span></div></div>
<p>At this point, in real life I would consider writing an integration test to capture the behavior described above.<span class="intersentencespace"></span> As noted in <a href="https://www.railstutorial.org/book/static_pages#aside-when_to_test" class="hyperref">Box&nbsp;<span class="ref">3.3</span></a>, as you become more familiar with the testing tools in Rails you may find yourself more inclined to write tests first.<span class="intersentencespace"></span> In this case, though, such a test involves several new ideas, so for now it’s best deferred to its own section (<a href="https://www.railstutorial.org/book/log_in_log_out#sec-testing_layout_changes" class="hyperref">Section&nbsp;<span class="ref">8.2.4</span></a>).</p>
<p>The way to change the links in the site layout involves using an
if-else statement inside embedded Ruby to show one set of links if the user is logged in and another set of links otherwise:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span>
  # Links for logged-in users
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  # Links for non-logged-in-users
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>This kind of code requires the existence of a <code>logged_in?</code> boolean method, which we’ll now define.</p>
<p>A user is logged in if there is a current user in the session, i.e., if <code>current_user</code> is not <code>nil</code>.<span class="intersentencespace"></span> Checking for this requires the use of the “not” operator (<a href="https://www.railstutorial.org/book/rails_flavored_ruby#sec-objects_and_message_passing" class="hyperref">Section&nbsp;<span class="ref">4.2.3</span></a>), written using an exclamation point&nbsp;<code>!</code><span class="intersentencespace"></span> and usually read as “bang”.<span class="intersentencespace"></span> The resulting <code>logged_in?</code> method appears in <a href="https://www.railstutorial.org/book/log_in_log_out#code-logged_in_p" class="hyperref">Listing&nbsp;<span class="ref">8.15</span></a>.</p>
<div class="codelisting" id="_code-logged_in_p" data-tralics-id="uid785" data-number="8.15"><div class="heading"><span class="number">Listing 8.15:</span> 

<span class="description">The <code>logged_in?</code> helper method.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># Logs in the given user.</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>

  <span class="c1"># Returns the current logged-in user (if any).</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Returns true if the user is logged in, false otherwise.</span>
  <span class="k">def</span> <span class="nf">logged_in?</span>
<span class="hll">    <span class="o">!</span><span class="n">current_user</span><span class="o">.</span><span class="n">nil?</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With addition in <a href="https://www.railstutorial.org/book/log_in_log_out#code-logged_in_p" class="hyperref">Listing&nbsp;<span class="ref">8.15</span></a>, we’re now ready to change the layout links if a user is logged in.<span class="intersentencespace"></span> There are four new links, two of which are stubbed out (to be completed in <a href="https://www.railstutorial.org/book/updating_and_deleting_users#cha-updating_showing_and_deleting_users" class="hyperref">Chapter&nbsp;<span class="ref">9</span></a>):</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span>    <span class="s1">'#'</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>The logout link, meanwhile, uses the logout path defined in <a href="https://www.railstutorial.org/book/log_in_log_out#code-sessions_resource" class="hyperref">Listing&nbsp;<span class="ref">8.1</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log out"</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>Notice that the logout link passes a hash argument indicating that it should submit with an HTTP <code class="tt">DELETE</code> request.<sup id="_cha-8_footnote-ref-7" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-7">7</a></sup><span class="intersentencespace"></span> We’ll also add a profile link as follows:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>Here we could write</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>but as usual Rails allows us to link directly to the user by automatically converting <code>current_user</code> into <code>user_path(current_user)</code> in this context.<span class="intersentencespace"></span> Finally, when users <em>aren’t</em> logged in, we’ll use the login path defined in <a href="https://www.railstutorial.org/book/log_in_log_out#code-sessions_resource" class="hyperref">Listing&nbsp;<span class="ref">8.1</span></a> to make a link to the login form:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="n">login_path</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>Putting everything together gives the updated header partial shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-layout_login_logout_links" class="hyperref">Listing&nbsp;<span class="ref">8.16</span></a>.</p>
<div class="codelisting" id="_code-layout_login_logout_links" data-tralics-id="uid787" data-number="8.16"><div class="heading"><span class="number">Listing 8.16:</span> 

<span class="description">Changing the layout links for logged-in users.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/_header.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">"logo"</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;nav&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
<span class="hll">        <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span>
</span><span class="hll">          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
</span>          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/b&gt;</span>
            <span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
<span class="hll">              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
</span><span class="hll">              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
</span>              <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"divider"</span><span class="nt">&gt;&lt;/li&gt;</span>
              <span class="nt">&lt;li&gt;</span>
<span class="hll">                <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log out"</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">"delete"</span> <span class="cp">%&gt;</span>
</span>              <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
          <span class="nt">&lt;/li&gt;</span>
<span class="hll">        <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
</span><span class="hll">          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="n">login_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
</span><span class="hll">        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</span>      <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/nav&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div></div></div><p>As part of including the new links into the layout, <a href="https://www.railstutorial.org/book/log_in_log_out#code-layout_login_logout_links" class="hyperref">Listing&nbsp;<span class="ref">8.16</span></a> takes advantage of Bootstrap’s ability to make dropdown menus.<sup id="_cha-8_footnote-ref-8" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-8">8</a></sup><span class="intersentencespace"></span> Note in particular the inclusion of the special Bootstrap CSS classes such as <code>dropdown</code>, <code>dropdown-menu</code>, etc.<span class="intersentencespace"></span> To activate the dropdown menu, we need to include Bootstrap’s custom JavaScript library in the Rails asset pipeline’s <code>application.js</code> file, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-bootstrap_js" class="hyperref">Listing&nbsp;<span class="ref">8.17</span></a>.</p>
<div class="codelisting" id="_code-bootstrap_js" data-tralics-id="uid789" data-number="8.17"><div class="heading"><span class="number">Listing 8.17:</span> 

<span class="description">Adding the Bootstrap JavaScript library to <code>application.js</code>.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/javascripts/application.js</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1">//= require jquery</span>
<span class="c1">//= require jquery_ujs</span>
<span class="hll"><span class="c1">//= require bootstrap</span>
</span><span class="c1">//= require turbolinks</span>
<span class="c1">//= require_tree .</span>
</pre></div></div></div><p>At this point, you should visit the login path and log in as a valid user, which effectively tests the code in the previous three sections.<sup id="_cha-8_footnote-ref-9" class="footnote intersentence"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-9">9</a></sup><span class="intersentencespace"></span> With the code in <a href="https://www.railstutorial.org/book/log_in_log_out#code-layout_login_logout_links" class="hyperref">Listing&nbsp;<span class="ref">8.16</span></a> and <a href="https://www.railstutorial.org/book/log_in_log_out#code-bootstrap_js" class="hyperref">Listing&nbsp;<span class="ref">8.17</span></a>, you should see the dropdown menu and links for logged-in users, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#fig-profile_with_logout_link" class="hyperref">Figure&nbsp;<span class="ref">8.8</span></a>.<span class="intersentencespace"></span> If you quit your browser completely, you should also be able to verify that the application forgets your login status, requiring you to log in again to see the changes described above.</p>
<div class="center figure" id="_fig-profile_with_logout_link" data-tralics-id="uid791" data-number="8.8">
<div class="graphics image"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/profile_with_logout_link_3rd_edition.png" alt="images/figures/profile_with_logout_link_3rd_edition"></div><div class="caption"><span class="header">Figure 8.8: </span><span class="description">A logged-in user with new links and a dropdown menu.
</span></div></div>
</div>
<div id="_sec-testing_layout_changes" data-tralics-id="uid792" class="subsection" data-number="8.2.4"><h3><a href="https://www.railstutorial.org/book/log_in_log_out#sec-testing_layout_changes" class="heading hyperref"><span class="number">8.2.4 </span>Testing layout changes</a></h3>
<p>Having verified by hand that the application is behaving properly upon successful login, before moving on we’ll write an integration test to capture that behavior and catch regressions.<span class="intersentencespace"></span> We’ll build on the test from <a href="https://www.railstutorial.org/book/log_in_log_out#code-flash_persistence_test" class="hyperref">Listing&nbsp;<span class="ref">8.7</span></a> and write a series of steps to verify the following sequence of actions:</p>
<ol>
<li>Visit the login path.<span class="intersentencespace"></span>
</li>
<li>Post valid information to the sessions path.<span class="intersentencespace"></span>
</li>
<li>Verify that the login link disappears.<span class="intersentencespace"></span>
</li>
<li>Verify that a logout link appears
</li>
<li>Verify that a profile link appears.<span class="intersentencespace"></span>
</li></ol>
<p>In order to see these changes, our test needs to log in as a previously registered user, which means that such a user must already exist in the database.<span class="intersentencespace"></span> The default Rails way to do this is to use <em>fixtures</em>, which are a way of organizing data to be loaded into the test database.<span class="intersentencespace"></span> We discovered in <a href="https://www.railstutorial.org/book/modeling_users#sec-uniqueness_validation" class="hyperref">Section&nbsp;<span class="ref">6.2.5</span></a> that we needed to delete the default fixtures so that our email uniqueness tests would pass (<a href="https://www.railstutorial.org/book/modeling_users#code-empty_fixtures" class="hyperref">Listing&nbsp;<span class="ref">6.30</span></a>).<span class="intersentencespace"></span> Now we’re ready to start filling in that empty file with custom fixtures of our own.</p>
<p>In the present case, we need only one user, whose information should consist of a valid name and email address.<span class="intersentencespace"></span> Because we’ll need to log the user in, we also have to include a valid password to compare with the password submitted to the Sessions controller’s <code>create</code> action.<span class="intersentencespace"></span> Referring to the data model in <a href="https://www.railstutorial.org/book/modeling_users#fig-user_model_password_digest" class="hyperref">Figure&nbsp;<span class="ref">6.8</span></a>, we see that this means creating a <code>password_digest</code> attribute for the user fixture, which we’ll accomplish by defining a <code>digest</code> method of our own.</p>
<p>As discussed in <a href="https://www.railstutorial.org/book/modeling_users#sec-a_hashed_password" class="hyperref">Section&nbsp;<span class="ref">6.3.1</span></a>, the password digest is created using bcrypt (via <code>has_secure_password</code>), so we’ll need to create the fixture password using the same method.<span class="intersentencespace"></span> By inspecting the <a href="https://github.com/rails/rails/blob/master/activemodel/lib/active_model/secure_password.rb" target="_blank">secure password source code</a>, we find that this method is</p>
<div class="code"><div class="highlight"><pre><span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
</pre></div></div>
<p>where <code>string</code> is the string to be hashed and <code>cost</code> is the <em>cost parameter</em> that determines the computational cost to calculate the hash.<span class="intersentencespace"></span> Using a high cost makes it computationally intractable to use the hash to determine the original password, which is an important security precaution in a production environment, but in tests we want the <code>digest</code> method to be as fast as possible.<span class="intersentencespace"></span> The secure password source code has a line for this as well:</p>
<div class="code"><div class="highlight"><pre><span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                              <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
</pre></div></div>
<p>This rather obscure code, which you don’t need to understand in detail, arranges for precisely the behavior described above: it uses the minimum cost parameter in tests and a normal (high) cost parameter in production.<span class="intersentencespace"></span> (We’ll learn more about the strange <code>?</code>-<code>:</code> notation in <a href="https://www.railstutorial.org/book/log_in_log_out#sec-remember_me_checkbox" class="hyperref">Section&nbsp;<span class="ref">8.4.5</span></a>.)</p>
<p>There are several places we could put the resulting <code>digest</code> method, but we’ll have an opportunity in <a href="https://www.railstutorial.org/book/log_in_log_out#sec-remember_token" class="hyperref">Section&nbsp;<span class="ref">8.4.1</span></a> to reuse <code>digest</code> in the User model.<span class="intersentencespace"></span> This suggests placing the method in <code>user.rb</code>.<span class="intersentencespace"></span> Because we won’t necessarily have access to a user object when calculating the digest (as will be the case in the fixtures file), we’ll attach the <code>digest</code> method to the User class itself, which (as we saw briefly in <a href="https://www.railstutorial.org/book/rails_flavored_ruby#sec-constructors" class="hyperref">Section&nbsp;<span class="ref">4.4.1</span></a>) makes it a <em>class method</em>.<span class="intersentencespace"></span> The result appears in <a href="https://www.railstutorial.org/book/log_in_log_out#code-digest_method" class="hyperref">Listing&nbsp;<span class="ref">8.18</span></a>.</p>
<div class="codelisting" id="_code-digest_method" data-tralics-id="uid798" data-number="8.18"><div class="heading"><span class="number">Listing 8.18:</span> 

<span class="description">Adding a digest method for use in fixtures.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>

  <span class="c1"># Returns the hash digest of the given string.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="hll">    <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
</span><span class="hll">                                                  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
</span><span class="hll">    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the <code>digest</code> method from <a href="https://www.railstutorial.org/book/log_in_log_out#code-digest_method" class="hyperref">Listing&nbsp;<span class="ref">8.18</span></a>, we are now ready to create a user fixture for a valid user, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-real_user_fixture" class="hyperref">Listing&nbsp;<span class="ref">8.19</span></a>.<sup id="_cha-8_footnote-ref-10" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-10">10</a></sup></p>
<div class="codelisting" id="_code-real_user_fixture" data-tralics-id="uid800" data-number="8.19"><div class="heading"><span class="number">Listing 8.19:</span> 

<span class="description">A fixture for testing user login.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/fixtures/users.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">michael</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Michael Example</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael@example.com</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
</pre></div></div></div><p>Note in particular that fixtures support embedded Ruby, which allows us to use</p>
<div class="code"><div class="highlight"><pre><span class="o">&lt;%=</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="s1">'password'</span><span class="p">)</span> <span class="o">%&gt;</span>
</pre></div></div>
<p>to create the valid password digest for the test user.</p>
<p>Although we’ve defined the <code>password_digest</code> attribute required by <code>has_secure_password</code>, sometimes it’s convenient to refer to the plain (virtual) password as well.<span class="intersentencespace"></span> Unfortunately, this is impossible to arrange with fixtures, and adding a <code>password</code> attribute to <a href="https://www.railstutorial.org/book/log_in_log_out#code-real_user_fixture" class="hyperref">Listing&nbsp;<span class="ref">8.19</span></a> causes Rails to complain that there is no such column in the database (which is true).<span class="intersentencespace"></span> We’ll make do by adopting the convention that all fixture users have the same password (<code>’password’</code>).</p>
<p>Having created a fixture with a valid user, we can retrieve it inside a test as follows:</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
</pre></div></div>
<p>Here <code>users</code> corresponds to the fixture filename <code>users.yml</code>, while the symbol <code>:michael</code> references user with the key shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-real_user_fixture" class="hyperref">Listing&nbsp;<span class="ref">8.19</span></a>.</p>
<p>With the fixture user as above, we can now write a test for the layout links by converting the sequence enumerated at the beginning of this section into code, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-user_login_test_valid_information" class="hyperref">Listing&nbsp;<span class="ref">8.20</span></a>.</p>
<div class="codelisting" id="_code-user_login_test_valid_information" data-tralics-id="uid801" data-number="8.20"><div class="heading"><span class="number">Listing 8.20:</span> 

<span class="description">A test for user logging in with valid information.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_login_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersLoginTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

<span class="hll">  <span class="k">def</span> <span class="nf">setup</span>
</span><span class="hll">    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
</span><span class="hll">  <span class="k">end</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"login with valid information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">login_path</span>
    <span class="n">post</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span> <span class="s1">'password'</span> <span class="p">}</span>
    <span class="n">assert_redirected_to</span> <span class="vi">@user</span>
    <span class="n">follow_redirect!</span>
    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">logout_path</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Here we’ve used</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_redirected_to</span> <span class="vi">@user</span>
</pre></div></div>
<p>to check the right redirect target and</p>
<div class="code"><div class="highlight"><pre><span class="n">follow_redirect!</span>
</pre></div></div>
<p>to actually visit the target page.<span class="intersentencespace"></span> <a href="https://www.railstutorial.org/book/log_in_log_out#code-user_login_test_valid_information" class="hyperref">Listing&nbsp;<span class="ref">8.20</span></a> also verifies that the login link disappears by verifying that there are <em>zero</em> login path links on the page:</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
</pre></div></div>
<p>By including the extra <code>count: 0</code> option, we tell <code>assert_select</code> that we expect there to be zero links matching the given pattern.<span class="intersentencespace"></span> (Compare to <code>count: 2</code> in <a href="https://www.railstutorial.org/book/filling_in_the_layout#code-layout_links_test" class="hyperref">Listing&nbsp;<span class="ref">5.26</span></a>, which checks for exactly two matching links.)</p>
<p>Because the application code was already working, this test should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="_uid802" data-tralics-id="uid802" data-number="8.21"><div class="heading"><span class="number">Listing 8.21:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test TEST=test/integration/users_login_test.rb \
&gt;                       TESTOPTS="--name test_login_with_valid_information"
</pre></div></div></div><p>This shows how to run a specific test within a test file by passing the option</p>
<div class="code"><div class="highlight"><pre><span class="go">TESTOPTS="--name test_login_with_valid_information"</span>
</pre></div></div>
<p>containing the name of the test.<span class="intersentencespace"></span> (A test’s name is just the word “test” and the words in the test description joined using underscores.)<span class="intersentencespace"></span> Note that the <code>&gt;</code> on the second line is a “line continuation” character inserted automatically by the shell, and should not be typed literally.</p>
</div>
<div id="_sec-login_upon_signup" data-tralics-id="uid803" class="subsection" data-number="8.2.5"><h3><a href="https://www.railstutorial.org/book/log_in_log_out#sec-login_upon_signup" class="heading hyperref"><span class="number">8.2.5 </span>Login upon signup</a></h3>
<p>Although our authentication system is now working, newly registered users might be confused, as they are not logged in by default.<span class="intersentencespace"></span> Because it would be strange to force users to log in immediately after signing up, we’ll log in new users automatically as part of the signup process.<span class="intersentencespace"></span> To arrange this behavior, all we need to do is add a call to <code>log_in</code> in the Users controller <code>create</code> action, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-login_upon_signup" class="hyperref">Listing&nbsp;<span class="ref">8.22</span></a>.<sup id="_cha-8_footnote-ref-11" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-11">11</a></sup></p>
<div class="codelisting" id="_code-login_upon_signup" data-tralics-id="uid805" data-number="8.22"><div class="heading"><span class="number">Listing 8.22:</span> 

<span class="description">Logging in the user upon signup.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
<span class="hll">      <span class="n">log_in</span> <span class="vi">@user</span>
</span>      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Welcome to the Sample App!"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>To test the behavior from <a href="https://www.railstutorial.org/book/log_in_log_out#code-login_upon_signup" class="hyperref">Listing&nbsp;<span class="ref">8.22</span></a>, we can add a line to the test from <a href="https://www.railstutorial.org/book/sign_up#code-a_test_for_valid_submission" class="hyperref">Listing&nbsp;<span class="ref">7.26</span></a> to check that the user is logged in.<span class="intersentencespace"></span> It’s helpful in this context to define a <code>is_logged_in?</code> helper method to parallel the <code>logged_in?</code> helper defined in <a href="https://www.railstutorial.org/book/log_in_log_out#code-logged_in_p" class="hyperref">Listing&nbsp;<span class="ref">8.15</span></a>, which returns <code>true</code> if there’s a user id in the (test) session and false otherwise (<a href="https://www.railstutorial.org/book/log_in_log_out#code-test_helper_sessions" class="hyperref">Listing&nbsp;<span class="ref">8.23</span></a>).<span class="intersentencespace"></span> (Because helper methods aren’t available in tests, we can’t use the <code>current_user</code> as in <a href="https://www.railstutorial.org/book/log_in_log_out#code-logged_in_p" class="hyperref">Listing&nbsp;<span class="ref">8.15</span></a>, but the <code>session</code> method is available, so we use that instead.)<span class="intersentencespace"></span> Here we use <code>is_logged_in?</code> instead of <code>logged_in?</code> so that the test helper and Sessions helper methods have different names, which prevents them from being mistaken for each other.<sup id="_cha-8_footnote-ref-12" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-12">12</a></sup></p>
<div class="codelisting" id="_code-test_helper_sessions" data-tralics-id="uid807" data-number="8.23"><div class="heading"><span class="number">Listing 8.23:</span> 

<span class="description">A boolean method for login status inside tests.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/test_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">ENV</span><span class="o">[</span><span class="s1">'RAILS_ENV'</span><span class="o">]</span> <span class="o">||=</span> <span class="s1">'test'</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">class</span> <span class="nc">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="n">fixtures</span> <span class="ss">:all</span>

  <span class="c1"># Returns true if a test user is logged in.</span>
<span class="hll">  <span class="k">def</span> <span class="nf">is_logged_in?</span>
</span><span class="hll">    <span class="o">!</span><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">].</span><span class="n">nil?</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div></div><p>With the code in <a href="https://www.railstutorial.org/book/log_in_log_out#code-test_helper_sessions" class="hyperref">Listing&nbsp;<span class="ref">8.23</span></a>, we can assert that the user is logged in after signup using the line shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-login_after_signup_test" class="hyperref">Listing&nbsp;<span class="ref">8.24</span></a>.</p>
<div class="codelisting" id="_code-login_after_signup_test" data-tralics-id="uid808" data-number="8.24"><div class="heading"><span class="number">Listing 8.24:</span> 

<span class="description">A test of login after signup.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_signup_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersSignupTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"valid signup information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_difference</span> <span class="s1">'User.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">post_via_redirect</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
                                            <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                                            <span class="ss">password</span><span class="p">:</span>              <span class="s2">"password"</span><span class="p">,</span>
                                            <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"password"</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
<span class="hll">    <span class="n">assert</span> <span class="n">is_logged_in?</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>At this point, the test suite should still be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="_uid809" data-tralics-id="uid809" data-number="8.25"><div class="heading"><span class="number">Listing 8.25:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div></div></div></div><div id="_sec-logging_out" data-tralics-id="cid54" class="section" data-number="8.3"><h2><a href="https://www.railstutorial.org/book/log_in_log_out#sec-logging_out" class="heading hyperref"><span class="number">8.3 </span>Logging out</a></h2>
<p>As discussed in <a href="https://www.railstutorial.org/book/log_in_log_out#sec-sessions_and_failed_login" class="hyperref">Section&nbsp;<span class="ref">8.1</span></a>, our authentication model is to keep users logged in until they log out explicitly.<span class="intersentencespace"></span> In this section, we’ll add this necessary logout capability.<span class="intersentencespace"></span> Because the “Log out” link has already been defined (<a href="https://www.railstutorial.org/book/log_in_log_out#code-layout_login_logout_links" class="hyperref">Listing&nbsp;<span class="ref">8.16</span></a>), all we need is to write a valid controller action to destroy user sessions.</p>
<p>So far, the Sessions controller actions have followed the RESTful convention of using <code>new</code> for a login page and <code>create</code> to complete the login.<span class="intersentencespace"></span> We’ll continue this theme by using a <code>destroy</code> action to delete sessions, i.e., to log out.<span class="intersentencespace"></span> Unlike the login functionality, which we use in both <a href="https://www.railstutorial.org/book/log_in_log_out#code-log_in_success" class="hyperref">Listing&nbsp;<span class="ref">8.13</span></a> and <a href="https://www.railstutorial.org/book/log_in_log_out#code-login_upon_signup" class="hyperref">Listing&nbsp;<span class="ref">8.22</span></a>, we’ll only be logging out in one place, so we’ll put the relevant code directly in the <code>destroy</code> action.<span class="intersentencespace"></span> As we’ll see in <a href="https://www.railstutorial.org/book/log_in_log_out#sec-remember_tests" class="hyperref">Section&nbsp;<span class="ref">8.4.6</span></a>, this design (with a little refactoring) will also make the authentication machinery easier to test.</p>
<p>Logging out involves undoing the effects of the <code>log_in</code> method from <a href="https://www.railstutorial.org/book/log_in_log_out#code-log_in_function" class="hyperref">Listing&nbsp;<span class="ref">8.12</span></a>, which involves deleting the user id from the session.<sup id="_cha-8_footnote-ref-13" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-13">13</a></sup><span class="intersentencespace"></span> To do this, we use the <code>delete</code> method as follows:</p>
<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
</pre></div></div>
<p>We’ll also set the current user to <code>nil</code>, although in the present case this won’t matter because of an immediate redirect to the root URL.<sup id="_cha-8_footnote-ref-14" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-14">14</a></sup><span class="intersentencespace"></span> As with <code>log_in</code> and associated methods, we’ll put the resulting <code>log_out</code> method in the Sessions helper module, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-log_out_method" class="hyperref">Listing&nbsp;<span class="ref">8.26</span></a>.</p>
<div class="codelisting" id="_code-log_out_method" data-tralics-id="uid812" data-number="8.26"><div class="heading"><span class="number">Listing 8.26:</span> 

<span class="description">The <code>log_out</code> method.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># Logs in the given user.</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Logs out the current user.</span>
  <span class="k">def</span> <span class="nf">log_out</span>
<span class="hll">    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
</span><span class="hll">    <span class="vi">@current_user</span> <span class="o">=</span> <span class="kp">nil</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>We can put the <code>log_out</code> method to use in the Sessions controller’s <code>destroy</code> action, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-destroy_session" class="hyperref">Listing&nbsp;<span class="ref">8.27</span></a>.</p>
<div class="codelisting" id="_code-destroy_session" data-tralics-id="uid813" data-number="8.27"><div class="heading"><span class="number">Listing 8.27:</span> 

<span class="description">Destroying a session (user logout).<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">log_in</span> <span class="n">user</span>
      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
<span class="hll">    <span class="n">log_out</span>
</span><span class="hll">    <span class="n">redirect_to</span> <span class="n">root_url</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>To test the logout machinery, we can add some steps to the user login test from <a href="https://www.railstutorial.org/book/log_in_log_out#code-user_login_test_valid_information" class="hyperref">Listing&nbsp;<span class="ref">8.20</span></a>.<span class="intersentencespace"></span> After logging in, we use <code>delete</code> to issue a <code class="tt">DELETE</code> request to the logout path (<a href="https://www.railstutorial.org/book/log_in_log_out#table-RESTful_sessions" class="hyperref">Table&nbsp;<span class="ref">8.1</span></a>) and verify that the user is logged out and redirected to the root URL. We also check that the login link reappears and that the logout and profile links disappear.<span class="intersentencespace"></span> The new steps appear in <a href="https://www.railstutorial.org/book/log_in_log_out#code-user_logout_test" class="hyperref">Listing&nbsp;<span class="ref">8.28</span></a>.</p>
<div class="codelisting" id="_code-user_logout_test" data-tralics-id="uid814" data-number="8.28"><div class="heading"><span class="number">Listing 8.28:</span> 

<span class="description">A test for user logout.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_login_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersLoginTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="hll">  <span class="nb">test</span> <span class="s2">"login with valid information followed by logout"</span> <span class="k">do</span>
</span>    <span class="n">get</span> <span class="n">login_path</span>
    <span class="n">post</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span> <span class="s1">'password'</span> <span class="p">}</span>
<span class="hll">    <span class="n">assert</span> <span class="n">is_logged_in?</span>
</span>    <span class="n">assert_redirected_to</span> <span class="vi">@user</span>
    <span class="n">follow_redirect!</span>
    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">logout_path</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
<span class="hll">    <span class="n">delete</span> <span class="n">logout_path</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="n">is_logged_in?</span>
</span><span class="hll">    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
</span><span class="hll">    <span class="n">follow_redirect!</span>
</span><span class="hll">    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">login_path</span>
</span><span class="hll">    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span>      <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
</span><span class="hll">    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>(Now that we have <code>is_logged_in?</code> available in tests, we’ve also thrown in a bonus <code>assert is_logged_in?</code> immediately after posting valid information to the sessions path.)</p>
<p>With the session <code>destroy</code> action thus defined and tested, the initial signup/login/logout triumvirate is complete, and the test suite should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="_uid815" data-tralics-id="uid815" data-number="8.29"><div class="heading"><span class="number">Listing 8.29:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div></div></div><div id="_sec-remember_me" data-tralics-id="cid55" class="section" data-number="8.4"><h2><a href="https://www.railstutorial.org/book/log_in_log_out#sec-remember_me" class="heading hyperref"><span class="number">8.4 </span>Remember me</a></h2>
<p>The login system we finished in <a href="https://www.railstutorial.org/book/log_in_log_out#sec-logging_in" class="hyperref">Section&nbsp;<span class="ref">8.2</span></a> is self-contained and fully functional, but most websites have the additional capability of remembering users’ sessions even after they close their browsers.<span class="intersentencespace"></span> In this section, we’ll start by remembering user logins by default, expiring their sessions only when they explicitly log out.<span class="intersentencespace"></span> In <a href="https://www.railstutorial.org/book/log_in_log_out#sec-remember_me_checkbox" class="hyperref">Section&nbsp;<span class="ref">8.4.5</span></a>, we’ll enable a common alternative model, a “remember me” checkbox that allows users to opt out of being remembered.<span class="intersentencespace"></span> Both of these models are professional-grade, with the first used by sites such as <a href="http://github.com/" target="_blank">GitHub</a> and <a href="http://bitbucket.org/" target="_blank">Bitbucket</a>, and the second used by sites such as <a href="http://www.facebook.com/" target="_blank">Facebook</a> and <a href="http://twitter.com/" target="_blank">Twitter</a>.</p>
<div id="_sec-remember_token" data-tralics-id="uid816" class="subsection" data-number="8.4.1"><h3><a href="https://www.railstutorial.org/book/log_in_log_out#sec-remember_token" class="heading hyperref"><span class="number">8.4.1 </span>Remember token and digest</a></h3>
<p>In <a href="https://www.railstutorial.org/book/log_in_log_out#sec-logging_in" class="hyperref">Section&nbsp;<span class="ref">8.2</span></a>, we used the Rails <code>session</code> method to store the user’s id, but this information disappears when the user closes their browser.<span class="intersentencespace"></span> In this section, we’ll take the first step toward persistent sessions by generating a <em>remember token</em> appropriate for creating permanent cookies using the <code>cookies</code> method, together with a secure <em>remember digest</em> for authenticating those tokens.</p>
<p>As noted in <a href="https://www.railstutorial.org/book/log_in_log_out#sec-a_working_log_in_method" class="hyperref">Section&nbsp;<span class="ref">8.2.1</span></a>, information stored using <code>session</code> is automatically secure, but this is not the case with information stored using <code>cookies</code>.<span class="intersentencespace"></span> In particular, persistent cookies are vulnerable to <a href="http://en.wikipedia.org/wiki/Session_hijacking" target="_blank">session hijacking</a>, in which an attacker uses a stolen remember token to log in as a particular user.<span class="intersentencespace"></span> There are four main ways to steal cookies: (1) using a <a href="https://en.wikipedia.org/wiki/Packet_analyzer" target="_blank">packet sniffer</a> to detect cookies being passed over insecure networks,<sup id="_cha-8_footnote-ref-15" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-15">15</a></sup> (2) compromising a database containing remember tokens, (3) using <a href="http://en.wikipedia.org/wiki/Cross-site_scripting" target="_blank">cross-site scripting (XSS)</a>, and (4) gaining physical access to a machine with a logged-in user.<span class="intersentencespace"></span> We prevented the first problem in <a href="https://www.railstutorial.org/book/sign_up#sec-professional_grade_deployment" class="hyperref">Section&nbsp;<span class="ref">7.5</span></a> by using <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security" target="_blank">Secure Sockets Layer</a> (SSL) site-wide, which protects network data from packet sniffers.<span class="intersentencespace"></span> We’ll prevent the second problem by storing a hash digest of the remember token instead of the token itself, in much the same way that we stored password digests instead of raw passwords in <a href="https://www.railstutorial.org/book/modeling_users#sec-adding_a_secure_password" class="hyperref">Section&nbsp;<span class="ref">6.3</span></a>.<span class="intersentencespace"></span> Rails automatically prevents the third problem by escaping any content inserted into view templates.<span class="intersentencespace"></span> Finally, although there’s no iron-clad way to stop attackers who have physical access to a logged-in computer, we’ll minimize the fourth problem by changing tokens every time a user logs out and by taking care to <em>cryptographically sign</em> any potentially sensitive information we place on the browser.</p>
<p>With these design and security considerations in mind, our plan for creating persistent sessions appears as follows:</p>
<ol>
<li>Create a random string of digits for use as a remember token.<span class="intersentencespace"></span>
</li>
<li>Place the token in the browser cookies with an expiration date far in the future.<span class="intersentencespace"></span>
</li>
<li>Save the hash digest of the token to the database.<span class="intersentencespace"></span>
</li>
<li>Place an encrypted version of the user’s id in the browser cookies.<span class="intersentencespace"></span>
</li>
<li>When presented with a cookie containing a persistent user id, find the user in the database using the given id, and verify that the remember token cookie matches the associated hash digest from the database.<span class="intersentencespace"></span>
</li></ol>
<p>Note how similar the final step is to logging a user in, where we retrieve the user by email address and then verify (using the <code>authenticate</code> method) that the submitted password matches the password digest (<a href="https://www.railstutorial.org/book/log_in_log_out#code-find_authenticate_user" class="hyperref">Listing&nbsp;<span class="ref">8.5</span></a>).<span class="intersentencespace"></span> As a result, our implementation will parallel aspects of <code>has_secure_password</code>.</p>
<p>We’ll start by adding the required <code>remember_digest</code> attribute to the User model, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#fig-user_model_remember_digest" class="hyperref">Figure&nbsp;<span class="ref">8.9</span></a>.</p>
<div class="center figure" id="_fig-user_model_remember_digest" data-tralics-id="uid823" data-number="8.9"><span class="graphics"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/user_model_remember_digest.png" alt="user_model_remember_digest"></span>
<div class="caption"><span class="header">Figure 8.9: </span><span class="description">The User model with an added <code>remember_digest</code> attribute.
</span></div></div>
<p>To add the data model from <a href="https://www.railstutorial.org/book/log_in_log_out#fig-user_model_remember_digest" class="hyperref">Figure&nbsp;<span class="ref">8.9</span></a> to our application, we’ll generate a migration:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_remember_digest_to_users remember_digest:string
</pre></div></div>
<p>(Compare to the password digest migration in <a href="https://www.railstutorial.org/book/modeling_users#sec-a_hashed_password" class="hyperref">Section&nbsp;<span class="ref">6.3.1</span></a>.)<span class="intersentencespace"></span> As in previous migrations, we’ve used a migration name that ends in <code>_to_users</code> to tell Rails that the migration is designed to alter the <code>users</code> table in the database.<span class="intersentencespace"></span> Because we also included the attribute (<code>remember_digest</code>) and type (<code>string</code>), Rails generates a default migration for us, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-add_remember_digest_to_users_generated" class="hyperref">Listing&nbsp;<span class="ref">8.30</span></a>.</p>
<div class="codelisting" id="_code-add_remember_digest_to_users_generated" data-tralics-id="uid824" data-number="8.30"><div class="heading"><span class="number">Listing 8.30:</span> 

<span class="description">The generated migration for the remember digest.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/migrate/[timestamp]_add_remember_digest_to_users.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddRememberDigestToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:remember_digest</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Because we don’t expect to retrieve users by remember digest, there’s no need to put an index on the <code>remember_digest</code> column, and we can use the default migration as generated above:</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake db:migrate
</pre></div></div>
<p>Now we have to decide what to use as a remember token.<span class="intersentencespace"></span> There are many mostly equivalent possibilities—essentially, any long random string will do.<span class="intersentencespace"></span> The <code>urlsafe_base64</code> method from the <code>SecureRandom</code> module in the Ruby standard library fits the bill:<sup id="_cha-8_footnote-ref-16" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-16">16</a></sup> it returns a random string of length 22 composed of the characters A–Z, a–z, 0–9, “-”, and “_” (for a total of 64 possibilities, thus “<a href="http://en.wikipedia.org/wiki/Base64" target="_blank">base64</a>”).<span class="intersentencespace"></span> A typical base64 string appears as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails console
<span class="gp">&gt;</span>&gt; SecureRandom.urlsafe_base64
<span class="go">=&gt; "q5lt38hQDc_959PVoo6b7A"</span>
</pre></div></div>
<p>Just as it’s perfectly fine if two users have the same password,<sup id="_cha-8_footnote-ref-17" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-17">17</a></sup> there’s no need for remember tokens to be unique, but it’s more secure if they are.<sup id="_cha-8_footnote-ref-18" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-18">18</a></sup><span class="intersentencespace"></span> In the case of the base64 string above, each of the 22 characters has 64 possibilities, so the probability of two remember tokens colliding is a negligibly small <span class="inline_math"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo&gt;/&lt;/mo&gt;&lt;/mrow&gt;&lt;msup&gt;&lt;mn&gt;64&lt;/mn&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mn&gt;22&lt;/mn&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msup&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;132&lt;/mn&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;mo&gt;&amp;#x2248;&lt;/mo&gt;&lt;msup&gt;&lt;mn&gt;10&lt;/mn&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;40&lt;/mn&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1" role="math" style="width: 11.314em; display: inline-block;"><span style="display: inline-block; position: relative; width: 10.163em; height: 0px; font-size: 111%;"><span style="position: absolute; clip: rect(1.154em 1010.16em 2.555em -999.997em); top: -2.15em; left: 0.003em;"><span class="mrow" id="MathJax-Span-2"><span class="mn" id="MathJax-Span-3" style="font-family: MathJax_Main;">1</span><span class="texatom" id="MathJax-Span-4"><span class="mrow" id="MathJax-Span-5"><span class="mo" id="MathJax-Span-6" style="font-family: MathJax_Main;">/</span></span></span><span class="msubsup" id="MathJax-Span-7"><span style="display: inline-block; position: relative; width: 1.804em; height: 0px;"><span style="position: absolute; clip: rect(3.156em 1000.95em 4.157em -999.997em); top: -4.002em; left: 0.003em;"><span class="mn" id="MathJax-Span-8" style="font-family: MathJax_Main;">64</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -4.402em; left: 1.004em;"><span class="texatom" id="MathJax-Span-9"><span class="mrow" id="MathJax-Span-10"><span class="mn" id="MathJax-Span-11" style="font-size: 70.7%; font-family: MathJax_Main;">22</span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span class="mo" id="MathJax-Span-12" style="font-family: MathJax_Main; padding-left: 0.303em;">=</span><span class="msubsup" id="MathJax-Span-13" style="padding-left: 0.303em;"><span style="display: inline-block; position: relative; width: 2.205em; height: 0px;"><span style="position: absolute; clip: rect(3.206em 1000.45em 4.157em -999.997em); top: -4.002em; left: 0.003em;"><span class="mn" id="MathJax-Span-14" style="font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -4.402em; left: 0.503em;"><span class="texatom" id="MathJax-Span-15"><span class="mrow" id="MathJax-Span-16"><span class="mo" id="MathJax-Span-17" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-18" style="font-size: 70.7%; font-family: MathJax_Main;">132</span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span class="mo" id="MathJax-Span-19" style="font-family: MathJax_Main; padding-left: 0.303em;">≈</span><span class="msubsup" id="MathJax-Span-20" style="padding-left: 0.303em;"><span style="display: inline-block; position: relative; width: 2.355em; height: 0px;"><span style="position: absolute; clip: rect(3.206em 1000.95em 4.157em -999.997em); top: -4.002em; left: 0.003em;"><span class="mn" id="MathJax-Span-21" style="font-family: MathJax_Main;">10</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -4.402em; left: 1.004em;"><span class="texatom" id="MathJax-Span-22"><span class="mrow" id="MathJax-Span-23"><span class="mo" id="MathJax-Span-24" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-25" style="font-size: 70.7%; font-family: MathJax_Main;">40</span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.155em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.331em; border-left-width: 0px; border-left-style: solid; width: 0px; height: 1.336em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>1</mn><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><msup><mn>64</mn><mrow class="MJX-TeXAtom-ORD"><mn>22</mn></mrow></msup><mo>=</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mo>−</mo><mn>132</mn></mrow></msup><mo>≈</mo><msup><mn>10</mn><mrow class="MJX-TeXAtom-ORD"><mo>−</mo><mn>40</mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-1"> 1/64^{22} = 2^{-132} \approx 10^{-40} </script></span>.<span class="intersentencespace"></span> As a bonus, by using base64 strings specifically designed to be safe in URLs (as indicated by the name <code>urlsafe_base64</code>), we’ll be able to use the same token generator to make account activation and password reset links in <a href="https://www.railstutorial.org/book/account_activation_password_reset#cha-account_activation_and_password_reset" class="hyperref">Chapter&nbsp;<span class="ref">10</span></a>.</p>
<p>Remembering users involves creating a remember token and saving the digest of the token to the database.<span class="intersentencespace"></span> We’ve already defined a <code>digest</code> method for use in the test fixtures (<a href="https://www.railstutorial.org/book/log_in_log_out#code-digest_method" class="hyperref">Listing&nbsp;<span class="ref">8.18</span></a>), and we can use the results of the discussion above to create a <code>new_token</code> method to create a new token.<span class="intersentencespace"></span> As with <code>digest</code>, the new token method doesn’t need a user object, so we’ll make it a class method.<sup id="_cha-8_footnote-ref-19" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-19">19</a></sup><span class="intersentencespace"></span> The result is the User model shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-token_method" class="hyperref">Listing&nbsp;<span class="ref">8.31</span></a>.</p>
<div class="codelisting" id="_code-token_method" data-tralics-id="uid829" data-number="8.31"><div class="heading"><span class="number">Listing 8.31:</span> 

<span class="description">Adding a method for generating tokens.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>

  <span class="c1"># Returns the hash digest of the given string.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                                  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Returns a random token.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">new_token</span>
<span class="hll">    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Our plan for the implementation is to make a <code>user.remember</code> method that associates a remember token with the user and saves the corresponding remember digest to the database.<span class="intersentencespace"></span> Because of the migration in <a href="https://www.railstutorial.org/book/log_in_log_out#code-add_remember_digest_to_users_generated" class="hyperref">Listing&nbsp;<span class="ref">8.30</span></a>, the User model already has a <code>remember_digest</code> attribute, but it doesn’t yet have a <code>remember_token</code> attribute.<span class="intersentencespace"></span> We need a way to make a token available via <code>user.remember_token</code> (for storage in the cookies) <em>without</em> storing it in the database.<span class="intersentencespace"></span> We solved a similar issue with secure passwords in <a href="https://www.railstutorial.org/book/modeling_users#sec-adding_a_secure_password" class="hyperref">Section&nbsp;<span class="ref">6.3</span></a>, which paired a virtual <code>password</code> attribute with a secure <code>password_digest</code> attribute in the database.<span class="intersentencespace"></span> In that case, the virtual <code>password</code> attribute was created automatically by <code>has_secure_password</code>, but we’ll have to write the code for a <code>remember_token</code> ourselves.<span class="intersentencespace"></span> The way to do this is to use <code>attr_accessor</code> to create an accessible attribute, which we saw before in <a href="https://www.railstutorial.org/book/rails_flavored_ruby#sec-a_user_class" class="hyperref">Section&nbsp;<span class="ref">4.4.5</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">remember</span>
<span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>Note the form of the assignment in the first line of the <code>remember</code> method.<span class="intersentencespace"></span> Because of the way Ruby handles assignments inside objects, without <code>self</code> the assignment would create a <em>local</em> variable called <code>remember_token</code>, which isn’t what we want.<span class="intersentencespace"></span> Using <code>self</code> ensures that assignment sets the user’s <code>remember_token</code> attribute.<span class="intersentencespace"></span> (Now you know why the <code>before_save</code> callback from <a href="https://www.railstutorial.org/book/modeling_users#code-email_downcase" class="hyperref">Listing&nbsp;<span class="ref">6.31</span></a> uses <code>self.email</code> instead of just <code>email</code>.)<span class="intersentencespace"></span> Meanwhile, the second line of <code>remember</code> uses the <code>update_attribute</code> method to update the remember digest.<span class="intersentencespace"></span> (As noted in <a href="https://www.railstutorial.org/book/modeling_users#sec-updating_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.5</span></a>, this method bypasses the validations, which is necessary in this case because we don’t have access to the user’s password or confirmation.)</p>
<p>With these considerations in mind, we can create a valid token and associated digest by first making a new remember token using <code>User.new_token</code>, and then updating the remember digest with the result of applying <code>User.digest</code>.<span class="intersentencespace"></span> This procedure gives the <code>remember</code> method shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-user_model_remember" class="hyperref">Listing&nbsp;<span class="ref">8.32</span></a>.</p>
<div class="codelisting" id="_code-user_model_remember" data-tralics-id="uid830" data-number="8.32"><div class="heading"><span class="number">Listing 8.32:</span> 

<span class="description">Adding a <code>remember</code> method to the User model.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span>
</span>  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>

  <span class="c1"># Returns the hash digest of the given string.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                                  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Returns a random token.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">new_token</span>
    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
  <span class="k">end</span>

  <span class="c1"># Remembers a user in the database for use in persistent sessions.</span>
  <span class="k">def</span> <span class="nf">remember</span>
<span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
</span><span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="_sec-login_with_remembering" data-tralics-id="uid831" class="subsection" data-number="8.4.2"><h3><a href="https://www.railstutorial.org/book/log_in_log_out#sec-login_with_remembering" class="heading hyperref"><span class="number">8.4.2 </span>Login with remembering</a></h3>
<p>Having created a working <code>user.remember</code> method, we’re now in a position to create a persistent session by storing a user’s (encrypted) id and remember token as permanent cookies on the browser.<span class="intersentencespace"></span> The way to do this is with the <code>cookies</code> method, which (as with <code>session</code>) we can treat as a hash.<span class="intersentencespace"></span> A cookie consists of two pieces of information, a <code>value</code> and an optional <code>expires</code> date.<span class="intersentencespace"></span> For example, we could make a persistent session by creating a cookie with value equal to the remember token that expires 20&nbsp;years from now:</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">value</span><span class="p">:</span>   <span class="n">remember_token</span><span class="p">,</span>
                             <span class="ss">expires</span><span class="p">:</span> <span class="mi">20</span><span class="o">.</span><span class="n">years</span><span class="o">.</span><span class="n">from_now</span><span class="o">.</span><span class="n">utc</span> <span class="p">}</span>
</pre></div></div>
<p>(This uses one of the convenient Rails time helpers, as discussed in <a href="https://www.railstutorial.org/book/log_in_log_out#aside-time_helpers" class="hyperref">Box&nbsp;<span class="ref">8.2</span></a>.)<span class="intersentencespace"></span> This pattern of setting a cookie that expires 20 years in the future is so common that Rails has a special <code>permanent</code> method to implement it, so that we can simply write</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">remember_token</span>
</pre></div></div>
<p>This causes Rails to set the expiration to <code>20.years.from_now</code> automatically.</p>
<div class="aside" id="_aside-time_helpers" data-tralics-id="uid832" data-number="8.2"><div class="heading"><span class="number">Box 8.2.</span> 

<span class="description">Cookies expire <code class="tt">20.years.from_now</code></span></div>
<p>You may recall from <a href="https://www.railstutorial.org/book/rails_flavored_ruby#sec-a_class_of_our_own" class="hyperref">Section&nbsp;<span class="ref">4.4.2</span></a> that Ruby lets you add methods to <em>any</em> class, even built-in ones.<span class="intersentencespace"></span> In that section, we added a <code class="tt">palindrome?</code> method to the <code class="tt">String</code> class (and discovered as a result that <code class="tt">"deified"</code> is a palindrome), and we also saw how Rails adds a <code class="tt">blank?</code> method to class <code class="tt">Object</code> (so that <code class="tt">"".blank?</code>, <code class="tt">"&nbsp;".blank?</code>, and <code class="tt">nil.blank?</code> are all <code class="tt">true</code>).<span class="intersentencespace"></span> The <code class="tt">cookies.permanent</code> method, which creates “permanent” cookies with an expiration <code class="tt">20.years.from_now</code>, gives yet another example of this practice through one of Rails’ <em>time helpers</em>, which are methods added to <code class="tt">Fixnum</code> (the base class for integers):</p>
<pre>  $ rails console
  &gt;&gt; 1.year.from_now
  =&gt; Sun, 09 Aug 2015 16:48:17 UTC +00:00
  &gt;&gt; 10.weeks.ago
  =&gt; Sat, 31 May 2014 16:48:45 UTC +00:00</pre>
<p>Rails adds other helpers, too:</p>
<pre>  &gt;&gt; 1.kilobyte
  =&gt; 1024
  &gt;&gt; 5.megabytes
  =&gt; 5242880</pre>
<p>These are useful for upload validations, making it easy to restrict, say, image uploads to <code class="tt">5.megabytes</code>.</p>
<p>Although it should be used with caution, the flexibility to add methods to built-in classes allows for extraordinarily natural additions to plain Ruby.<span class="intersentencespace"></span> Indeed, much of the elegance of Rails ultimately derives from the malleability of the underlying Ruby language.</p>

</div><p>To store the user’s id in the cookies, we could follow the pattern used with the <code>session</code> method (<a href="https://www.railstutorial.org/book/log_in_log_out#code-log_in_function" class="hyperref">Listing&nbsp;<span class="ref">8.12</span></a>) using something like</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</pre></div></div>
<p>Because it places the id as plain text, this method exposes the form of the application’s cookies and makes it easier for an attacker to compromise user accounts.<span class="intersentencespace"></span> To avoid this problem, we’ll use a <em>signed</em> cookie, which securely encrypts the cookie before placing it on the browser:</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</pre></div></div>
<p>Because we want the user id to be paired with the permanent remember token, we should make it permanent as well, which we can do by chaining the <code>signed</code> and <code>permanent</code> methods:</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</pre></div></div>
<p>After the cookies are set, on subsequent page views we can retrieve the user with code like</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>where <code>cookies.signed[:user_id]</code> automatically decrypts the user id cookie.<span class="intersentencespace"></span> We can then use bcrypt to verify that <code>cookies[:remember_token]</code> matches the <code>remember_digest</code> generated in <a href="https://www.railstutorial.org/book/log_in_log_out#code-user_model_remember" class="hyperref">Listing&nbsp;<span class="ref">8.32</span></a>.<span class="intersentencespace"></span> (In case you’re wondering why we don’t just use the signed user id, without the remember token, this would allow an attacker with possession of the encrypted id to log in as the user in perpetuity.<span class="intersentencespace"></span> In the present design, an attacker with both cookies can log in as the user only until the user logs out.)</p>
<p>The final piece of the puzzle is to verify that a given remember token matches the user’s remember digest, and in this context there are a couple of equivalent ways to use bcrypt to verify a match.<span class="intersentencespace"></span> If you look at the <a href="https://github.com/rails/rails/blob/master/activemodel/lib/active_model/secure_password.rb" target="_blank">secure password source code</a>, you’ll find a comparison like this:<sup id="_cha-8_footnote-ref-20" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-20">20</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">password_digest</span><span class="p">)</span> <span class="o">==</span> <span class="n">unencrypted_password</span>
</pre></div></div>
<p>In our case, the analogous code would look like this:</p>
<div class="code"><div class="highlight"><pre><span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span> <span class="o">==</span> <span class="n">remember_token</span>
</pre></div></div>
<p>If you think about it, this code is really strange: it appears to be comparing a bcrypt password digest directly with a token, which would imply <em>decrypting</em> the digest in order to compare using <code>==</code>.<span class="intersentencespace"></span> But the whole point of using bcrypt is for hashing to be irreversible, so this can’t be right.<span class="intersentencespace"></span> Indeed, digging into the <a href="https://github.com/codahale/bcrypt-ruby/blob/master/lib/bcrypt/password.rb" target="_blank">source code of the bcrypt gem</a> verifies that the comparison operator <code>==</code> is being <em>redefined</em>, and under the hood the comparison above is equivalent to the following:</p>
<div class="code"><div class="highlight"><pre><span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
</pre></div></div>
<p>Instead of <code>==</code>, this uses the boolean method <code>is_password?</code> to perform the comparison.<span class="intersentencespace"></span> Because its meaning is a little clearer, we’ll prefer this second comparison form in the application code.</p>
<p>The above discussion suggests putting the digest–token comparison into an <code>authenticated?</code> method in the User model, which plays a similar role to the <code>authenticate</code> method provided by <code>has_secure_password</code> for authenticating a user (<a href="https://www.railstutorial.org/book/log_in_log_out#code-log_in_success" class="hyperref">Listing&nbsp;<span class="ref">8.13</span></a>).<span class="intersentencespace"></span> The implementation appears in <a href="https://www.railstutorial.org/book/log_in_log_out#code-authenticated_p" class="hyperref">Listing&nbsp;<span class="ref">8.33</span></a>.<span class="intersentencespace"></span> (Although the <code>authenticated?</code> method in <a href="https://www.railstutorial.org/book/log_in_log_out#code-authenticated_p" class="hyperref">Listing&nbsp;<span class="ref">8.33</span></a> is tied specifically to the remember digest, it will turn out to be useful in other contexts as well, and we’ll generalize it in <a href="https://www.railstutorial.org/book/account_activation_password_reset#cha-account_activation_and_password_reset" class="hyperref">Chapter&nbsp;<span class="ref">10</span></a>.)</p>
<div class="codelisting" id="_code-authenticated_p" data-tralics-id="uid834" data-number="8.33"><div class="heading"><span class="number">Listing 8.33:</span> 

<span class="description">Adding an <code>authenticated?</code> method to the User model.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>

  <span class="c1"># Returns the hash digest of the given string.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                                  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Returns a random token.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">new_token</span>
    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
  <span class="k">end</span>

  <span class="c1"># Remembers a user in the database for use in persistent sessions.</span>
  <span class="k">def</span> <span class="nf">remember</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="c1"># Returns true if the given token matches the digest.</span>
  <span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
<span class="hll">    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that the <code>remember_token</code> argument in the <code>authenticated?</code> method defined in <a href="https://www.railstutorial.org/book/log_in_log_out#code-authenticated_p" class="hyperref">Listing&nbsp;<span class="ref">8.33</span></a> is not the same as the accessor that we defined in <a href="https://www.railstutorial.org/book/log_in_log_out#code-user_model_remember" class="hyperref">Listing&nbsp;<span class="ref">8.32</span></a> using <code>attr_accessor :remember_token</code>; instead, it is a variable local to the method.<span class="intersentencespace"></span> (Because the argument refers to the remember token, it is not uncommon to use a method argument that has the same name.)<span class="intersentencespace"></span> Also note the use of the <code>remember_digest</code> attribute, which is the same as <code>self.remember_digest</code> and, like <code>name</code> and <code>email</code> in <a href="https://www.railstutorial.org/book/modeling_users#cha-modeling_users" class="hyperref">Chapter&nbsp;<span class="ref">6</span></a>, is created automatically by Active Record based on the name of the corresponding database column (<a href="https://www.railstutorial.org/book/log_in_log_out#code-add_remember_digest_to_users_generated" class="hyperref">Listing&nbsp;<span class="ref">8.30</span></a>).</p>
<p>We’re now in a position to remember a logged-in user, which we’ll do by adding a <code>remember</code> helper to go along with <code>log_in</code>, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-log_in_with_remember" class="hyperref">Listing&nbsp;<span class="ref">8.34</span></a>.</p>
<div class="codelisting" id="_code-log_in_with_remember" data-tralics-id="uid835" data-number="8.34"><div class="heading"><span class="number">Listing 8.34:</span> 

<span class="description">Logging in and remembering a user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">log_in</span> <span class="n">user</span>
<span class="hll">      <span class="n">remember</span> <span class="n">user</span>
</span>      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">log_out</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>As with <code>log_in</code>, <a href="https://www.railstutorial.org/book/log_in_log_out#code-log_in_with_remember" class="hyperref">Listing&nbsp;<span class="ref">8.34</span></a> defers the real work to the Sessions helper, where we define a <code>remember</code> method that calls <code>user.remember</code>, thereby generating a remember token and saving its digest to the database.<span class="intersentencespace"></span> It then uses <code>cookies</code> to create permanent cookies for the user id and remember token as described above.<span class="intersentencespace"></span> The result appears in <a href="https://www.railstutorial.org/book/log_in_log_out#code-remember_method" class="hyperref">Listing&nbsp;<span class="ref">8.35</span></a>.</p>
<div class="codelisting" id="_code-remember_method" data-tralics-id="uid836" data-number="8.35"><div class="heading"><span class="number">Listing 8.35:</span> 

<span class="description">Remembering the user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># Logs in the given user.</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>

  <span class="c1"># Remembers a user in a persistent session.</span>
  <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="hll">    <span class="n">user</span><span class="o">.</span><span class="n">remember</span>
</span><span class="hll">    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</span><span class="hll">    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
</span>  <span class="k">end</span>

  <span class="c1"># Returns the current logged-in user (if any).</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Returns true if the user is logged in, false otherwise.</span>
  <span class="k">def</span> <span class="nf">logged_in?</span>
    <span class="o">!</span><span class="n">current_user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">end</span>

  <span class="c1"># Logs out the current user.</span>
  <span class="k">def</span> <span class="nf">log_out</span>
    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the code in <a href="https://www.railstutorial.org/book/log_in_log_out#code-remember_method" class="hyperref">Listing&nbsp;<span class="ref">8.35</span></a>, a user logging in will be remembered in the sense that their browser will get a valid remember token, but it doesn’t yet do us any good because the <code>current_user</code> method defined in <a href="https://www.railstutorial.org/book/log_in_log_out#code-current_user" class="hyperref">Listing&nbsp;<span class="ref">8.14</span></a> knows only about the temporary session:</p>
<div class="code"><div class="highlight"><pre><span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>In the case of persistent sessions, we want to retrieve the user from the temporary session if <code>session[:user_id]</code> exists, but otherwise we should look for <code>cookies[:user_id]</code> to retrieve (and log in) the user corresponding to the persistent session.<span class="intersentencespace"></span> We can accomplish this as follows:</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span>
  <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
<span class="k">elsif</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
    <span class="n">log_in</span> <span class="n">user</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>(This follows the same <code>user &amp;&amp; user.authenticated</code> pattern we saw in <a href="https://www.railstutorial.org/book/log_in_log_out#code-find_authenticate_user" class="hyperref">Listing&nbsp;<span class="ref">8.5</span></a>.)<span class="intersentencespace"></span> The code above will work, but note the repeated use of both <code>session</code> and <code>cookies</code>.<span class="intersentencespace"></span> We can eliminate this duplication as follows:</p>
<div class="code"><div class="highlight"><pre><span class="hll"><span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
<span class="hll"><span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
    <span class="n">log_in</span> <span class="n">user</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>This uses the common but potentially confusing construction</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>Despite appearances, this is <em>not</em> a comparison (which would use double-equals <code>==</code>), but rather is an <em>assignment</em>.<span class="intersentencespace"></span> If you were to read it in words, you wouldn’t say “If user id equals session of user id…”, but rather something like “If session of user id exists (while setting user id to session of user id)…”.<sup id="_cha-8_footnote-ref-21" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-21">21</a></sup></p>
<p>Defining the <code>current_user</code> helper as discussed above leads to the implementation shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-persistent_current_user" class="hyperref">Listing&nbsp;<span class="ref">8.36</span></a>.</p>
<div class="codelisting" id="_code-persistent_current_user" data-tralics-id="uid838" data-number="8.36"><div class="heading"><span class="number">Listing 8.36:</span> 

<span class="description">Updating <code>current_user</code> for persistent sessions.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># Logs in the given user.</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>

  <span class="c1"># Remembers a user in a persistent session.</span>
  <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span><span class="o">.</span><span class="n">remember</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
  <span class="k">end</span>

  <span class="c1"># Returns the user corresponding to the remember token cookie.</span>
  <span class="k">def</span> <span class="nf">current_user</span>
<span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">      <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
</span><span class="hll">    <span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
</span><span class="hll">      <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">        <span class="n">log_in</span> <span class="n">user</span>
</span><span class="hll">        <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class="hll">      <span class="k">end</span>
</span><span class="hll">    <span class="k">end</span>
</span>  <span class="k">end</span>

  <span class="c1"># Returns true if the user is logged in, false otherwise.</span>
  <span class="k">def</span> <span class="nf">logged_in?</span>
    <span class="o">!</span><span class="n">current_user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">end</span>

  <span class="c1"># Logs out the current user.</span>
  <span class="k">def</span> <span class="nf">log_out</span>
    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the code as in <a href="https://www.railstutorial.org/book/log_in_log_out#code-persistent_current_user" class="hyperref">Listing&nbsp;<span class="ref">8.36</span></a>, newly logged in users are correctly remembered, as you can verify by logging in, closing the browser, and checking that you’re still logged in when you restart the sample application and revisit the sample application.<span class="intersentencespace"></span> If you want, you can even inspect the browser cookies to see the result directly (<a href="https://www.railstutorial.org/book/log_in_log_out#fig-cookie_in_browser" class="hyperref">Figure&nbsp;<span class="ref">8.10</span></a>).<sup id="_cha-8_footnote-ref-22" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-22">22</a></sup></p>
<div class="center figure" id="_fig-cookie_in_browser" data-tralics-id="uid840" data-number="8.10">
<div class="graphics image box"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/cookie_in_browser_chrome.png" alt="images/figures/cookie_in_browser_chrome"></div><div class="caption"><span class="header">Figure 8.10: </span><span class="description">The remember token cookie in the local browser.
</span></div></div>
<p>There’s only one problem with our application as it stands: short of clearing their browser cookies (or waiting 20 years), there’s no way for users to log out.<span class="intersentencespace"></span> This is exactly the sort of thing our test suite should catch, and indeed it should currently be <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="_uid841" data-tralics-id="uid841" data-number="8.37"><div class="heading"><span class="number">Listing 8.37:</span> <span class="description"><span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div></div></div>
<div id="_sec-forgetting_users" data-tralics-id="uid842" class="subsection" data-number="8.4.3"><h3><a href="https://www.railstutorial.org/book/log_in_log_out#sec-forgetting_users" class="heading hyperref"><span class="number">8.4.3 </span>Forgetting users</a></h3>
<p>To allow users to log out, we’ll define methods to forget users in analogy with the ones to remember them.<span class="intersentencespace"></span> The resulting <code>user.forget</code> method just undoes <code>user.remember</code> by updating the remember digest with <code>nil</code>, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-user_model_forget" class="hyperref">Listing&nbsp;<span class="ref">8.38</span></a>.</p>
<div class="codelisting" id="_code-user_model_forget" data-tralics-id="uid843" data-number="8.38"><div class="heading"><span class="number">Listing 8.38:</span> 

<span class="description">Adding a <code>forget</code> method to the User model.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>

  <span class="c1"># Returns the hash digest of the given string.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                                  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Returns a random token.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">new_token</span>
    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
  <span class="k">end</span>

  <span class="c1"># Remembers a user in the database for use in persistent sessions.</span>
  <span class="k">def</span> <span class="nf">remember</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="c1"># Returns true if the given token matches the digest.</span>
  <span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Forgets a user.</span>
  <span class="k">def</span> <span class="nf">forget</span>
<span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the code in <a href="https://www.railstutorial.org/book/log_in_log_out#code-user_model_forget" class="hyperref">Listing&nbsp;<span class="ref">8.38</span></a>, we’re now ready to forget a permanent session by adding a <code>forget</code> helper and calling it from the <code>log_out</code> helper (<a href="https://www.railstutorial.org/book/log_in_log_out#code-log_out_with_forget" class="hyperref">Listing&nbsp;<span class="ref">8.39</span></a>).<span class="intersentencespace"></span> As seen in <a href="https://www.railstutorial.org/book/log_in_log_out#code-log_out_with_forget" class="hyperref">Listing&nbsp;<span class="ref">8.39</span></a>, the <code>forget</code> helper calls <code>user.forget</code> and then deletes the <code>user_id</code> and <code>remember_token</code> cookies.</p>
<div class="codelisting" id="_code-log_out_with_forget" data-tralics-id="uid844" data-number="8.39"><div class="heading"><span class="number">Listing 8.39:</span> 

<span class="description">Logging out from a persistent session.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># Logs in the given user.</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Forgets a persistent session.</span>
  <span class="k">def</span> <span class="nf">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="hll">    <span class="n">user</span><span class="o">.</span><span class="n">forget</span>
</span><span class="hll">    <span class="n">cookies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
</span><span class="hll">    <span class="n">cookies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># Logs out the current user.</span>
  <span class="k">def</span> <span class="nf">log_out</span>
<span class="hll">    <span class="n">forget</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
</span>    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="_sec-two_subtle_bugs" data-tralics-id="uid845" class="subsection" data-number="8.4.4"><h3><a href="https://www.railstutorial.org/book/log_in_log_out#sec-two_subtle_bugs" class="heading hyperref"><span class="number">8.4.4 </span>Two subtle bugs</a></h3>
<p>There are two closely related subtleties left to address.<span class="intersentencespace"></span> The first subtlety is that, even though the “Log out” link appears only when logged-in, a user could potentially have multiple browser windows open to the site.<span class="intersentencespace"></span> If the user logged out in one window, thereby setting <code>current_user</code> to <code>nil</code>, clicking the “Log out” link in a second window would result in an error because of <code>forget(current_user)</code> in the <code>log_out</code> method (<a href="https://www.railstutorial.org/book/log_in_log_out#code-log_out_with_forget" class="hyperref">Listing&nbsp;<span class="ref">8.39</span></a>).<sup id="_cha-8_footnote-ref-23" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-23">23</a></sup><span class="intersentencespace"></span> We can avoid this by logging out only if the user is logged in.</p>
<p>The second subtlety is that a user could be logged in (and remembered) in multiple browsers, such as Chrome and Firefox, which causes a problem if the user logs out in the first browser but not the second, and then closes and re-opens the second one.<sup id="_cha-8_footnote-ref-24" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-24">24</a></sup><span class="intersentencespace"></span> For example, suppose that the user logs out in Firefox, thereby setting the remember digest to <code>nil</code> (via <code>user.forget</code> in <a href="https://www.railstutorial.org/book/log_in_log_out#code-user_model_forget" class="hyperref">Listing&nbsp;<span class="ref">8.38</span></a>).<span class="intersentencespace"></span> The application will still work in Firefox; because the <code>log_out</code> method in <a href="https://www.railstutorial.org/book/log_in_log_out#code-log_out_with_forget" class="hyperref">Listing&nbsp;<span class="ref">8.39</span></a> deletes the user’s id, both highlighted conditionals are <code>false</code>:</p>
<div class="code"><div class="highlight"><pre><span class="c1"># Returns the user corresponding to the remember token cookie.</span>
<span class="k">def</span> <span class="nf">current_user</span>
<span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span>    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
<span class="hll">  <span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span>    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
      <span class="n">log_in</span> <span class="n">user</span>
      <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>As a result, evaluation falls off the end of the <code>current_user</code> method, thereby returning <code>nil</code> as required.</p>
<p>In contrast, if we close Chrome, we set <code>session[:user_id]</code> to <code>nil</code> (because all <code>session</code> variables expire automatically on browser close), but the <code>user_id</code> <em>cookie</em> will still be present.<span class="intersentencespace"></span> This means that the corresponding user will still be pulled out of the database:</p>
<div class="code"><div class="highlight"><pre><span class="c1"># Returns the user corresponding to the remember token cookie.</span>
<span class="k">def</span> <span class="nf">current_user</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
<span class="hll">  <span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</span>      <span class="n">log_in</span> <span class="n">user</span>
      <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>Consequently, the inner <code>if</code> conditional will be evaluated:</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>In particular, because <code>user</code> isn’t <code>nil</code>, the <em>second</em> expression will be evaluated, which raises an error.<span class="intersentencespace"></span> This is because the user’s remember digest was deleted as part of logging out (<a href="https://www.railstutorial.org/book/log_in_log_out#code-user_model_forget" class="hyperref">Listing&nbsp;<span class="ref">8.38</span></a>) in Firefox, so when we access the application in Chrome we end up calling</p>
<div class="code"><div class="highlight"><pre><span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
</pre></div></div>
<p>with a <code>nil</code> remember digest, thereby raising an exception inside the bcrypt library.<span class="intersentencespace"></span> To fix this, we want <code>authenticated?</code> to return <code>false</code> instead.</p>
<p>These are exactly the sorts of subtleties that benefit from test-driven development, so we’ll write tests to catch the two errors before correcting them.<span class="intersentencespace"></span> We first get the integration test from <a href="https://www.railstutorial.org/book/log_in_log_out#code-user_logout_test" class="hyperref">Listing&nbsp;<span class="ref">8.28</span></a> to <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-test_double_logout" class="hyperref">Listing&nbsp;<span class="ref">8.40</span></a>.</p>
<div class="codelisting" id="_code-test_double_logout" data-tralics-id="uid848" data-number="8.40"><div class="heading"><span class="number">Listing 8.40:</span> 

<span class="description">A test for user logout.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_login_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersLoginTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"login with valid information followed by logout"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">login_path</span>
    <span class="n">post</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span> <span class="s1">'password'</span> <span class="p">}</span>
    <span class="n">assert</span> <span class="n">is_logged_in?</span>
    <span class="n">assert_redirected_to</span> <span class="vi">@user</span>
    <span class="n">follow_redirect!</span>
    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">logout_path</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">delete</span> <span class="n">logout_path</span>
    <span class="n">assert_not</span> <span class="n">is_logged_in?</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
<span class="hll">    <span class="c1"># Simulate a user clicking logout in a second window.</span>
</span><span class="hll">    <span class="n">delete</span> <span class="n">logout_path</span>
</span>    <span class="n">follow_redirect!</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">login_path</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span>      <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The second call to <code>delete logout_path</code> in <a href="https://www.railstutorial.org/book/log_in_log_out#code-test_double_logout" class="hyperref">Listing&nbsp;<span class="ref">8.40</span></a> should raise an error due to the missing <code>current_user</code>, leading to a <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span> test suite:</p>
<div class="codelisting" id="_uid849" data-tralics-id="uid849" data-number="8.41"><div class="heading"><span class="number">Listing 8.41:</span> <span class="description"><span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div></div><p>The application code simply involves calling <code>log_out</code> only if <code>logged_in?</code> is true, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-destroy_forget" class="hyperref">Listing&nbsp;<span class="ref">8.42</span></a>.</p>
<div class="codelisting" id="_code-destroy_forget" data-tralics-id="uid850" data-number="8.42"><div class="heading"><span class="number">Listing 8.42:</span> 

<span class="description">Only logging out if logged in.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
<span class="hll">    <span class="n">log_out</span> <span class="k">if</span> <span class="n">logged_in?</span>
</span>    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The second case, involving a scenario with two different browsers, is harder to simulate with an integration test, but it’s easy to check in the User model test directly.<span class="intersentencespace"></span> All we need is to start with a user that has no remember digest (which is true for the <code>@user</code> variable defined in the <code>setup</code> method) and then call <code>authenticated?</code>, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-test_authenticated_invalid_token" class="hyperref">Listing&nbsp;<span class="ref">8.43</span></a>.<span class="intersentencespace"></span> (Note that we’ve just left the remember token blank; it doesn’t matter what its value is, because the error occurs before it ever gets used.)</p>
<div class="codelisting" id="_code-test_authenticated_invalid_token" data-tralics-id="uid851" data-number="8.43"><div class="heading"><span class="number">Listing 8.43:</span> 

<span class="description">A test of <code>authenticated?</code> with a nonexistent digest.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                     <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"authenticated? should return false for a user with nil digest"</span> <span class="k">do</span>
    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Because <code>BCrypt::Password.new(nil)</code> raises an error, the test suite should now be <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="_uid852" data-tralics-id="uid852" data-number="8.44"><div class="heading"><span class="number">Listing 8.44:</span> <span class="description"><span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div></div><p>To fix the error and get to <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>, all we need to do is return <code>false</code> if the remember digest is <code>nil</code>, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-authenticated_p_fixed" class="hyperref">Listing&nbsp;<span class="ref">8.45</span></a>.</p>
<div class="codelisting" id="_code-authenticated_p_fixed" data-tralics-id="uid853" data-number="8.45"><div class="heading"><span class="number">Listing 8.45:</span> 

<span class="description">Updating <code>authenticated?</code> to handle a nonexistent digest.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Returns true if the given token matches the digest.</span>
  <span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
<span class="hll">    <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">remember_digest</span><span class="o">.</span><span class="n">nil?</span>
</span>    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Forgets a user.</span>
  <span class="k">def</span> <span class="nf">forget</span>
    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="k">end</span>  
<span class="k">end</span>
</pre></div></div></div><p>This uses the <code>return</code> keyword to return immediately if the remember digest is <code>nil</code>, which is a common way to emphasize that the rest of the method gets ignored in that case.<span class="intersentencespace"></span> The equivalent code</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">remember_digest</span><span class="o">.</span><span class="n">nil?</span>
  <span class="kp">false</span>
<span class="k">else</span>
  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>would also work fine, but I prefer the explicitness of the version in <a href="https://www.railstutorial.org/book/log_in_log_out#code-authenticated_p_fixed" class="hyperref">Listing&nbsp;<span class="ref">8.45</span></a> (which also happens to be slightly shorter).</p>
<p>With the code in <a href="https://www.railstutorial.org/book/log_in_log_out#code-authenticated_p_fixed" class="hyperref">Listing&nbsp;<span class="ref">8.45</span></a>, our full test suite should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>, and both subtleties should now be addressed:</p>
<div class="codelisting" id="_uid854" data-tralics-id="uid854" data-number="8.46"><div class="heading"><span class="number">Listing 8.46:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div></div></div>
<div id="_sec-remember_me_checkbox" data-tralics-id="uid855" class="subsection" data-number="8.4.5"><h3><a href="https://www.railstutorial.org/book/log_in_log_out#sec-remember_me_checkbox" class="heading hyperref"><span class="number">8.4.5 </span>“Remember me” checkbox</a></h3>
<p>With the code in <a href="https://www.railstutorial.org/book/log_in_log_out#sec-forgetting_users" class="hyperref">Section&nbsp;<span class="ref">8.4.3</span></a>, our application has a complete, professional-grade authentication system.<span class="intersentencespace"></span> As a final step, we’ll see how to make staying logged in optional using a “remember me” checkbox.<span class="intersentencespace"></span> A mockup of the login form with such a checkbox appears in <a href="https://www.railstutorial.org/book/log_in_log_out#fig-login_remember_me_mockup" class="hyperref">Figure&nbsp;<span class="ref">8.11</span></a>.</p>
<div class="center figure" id="_fig-login_remember_me_mockup" data-tralics-id="uid856" data-number="8.11">
<div class="graphics image box"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/login_remember_me_mockup.png" alt="images/figures/login_remember_me_mockup"></div><div class="caption"><span class="header">Figure 8.11: </span><span class="description">A mockup of a “remember me” checkbox.
</span></div></div>
<p>To write the implementation, we start by adding a checkbox to the login form from <a href="https://www.railstutorial.org/book/log_in_log_out#code-login_form" class="hyperref">Listing&nbsp;<span class="ref">8.2</span></a>.<span class="intersentencespace"></span> As with labels, text fields, password fields, and submit buttons, checkboxes can be created with a Rails helper method.<span class="intersentencespace"></span> In order to get the styling right, though, we have to <em>nest</em> the checkbox inside the label, as follows:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:remember_me</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"checkbox inline"</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">check_box</span> <span class="ss">:remember_me</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;span&gt;</span>Remember me on this computer<span class="nt">&lt;/span&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>Putting this into the login form gives the code shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-remember_me_checkbox" class="hyperref">Listing&nbsp;<span class="ref">8.47</span></a>.</p>
<div class="codelisting" id="_code-remember_me_checkbox" data-tralics-id="uid857" data-number="8.47"><div class="heading"><span class="number">Listing 8.47:</span> 

<span class="description">Adding a “remember me” checkbox to the login form.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/sessions/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Log in"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Log in<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">login_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:remember_me</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"checkbox inline"</span> <span class="k">do</span> <span class="cp">%&gt;</span>
</span><span class="hll">        <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">check_box</span> <span class="ss">:remember_me</span> <span class="cp">%&gt;</span>
</span><span class="hll">        <span class="nt">&lt;span&gt;</span>Remember me on this computer<span class="nt">&lt;/span&gt;</span>
</span><span class="hll">      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;p&gt;</span>New user? <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>In <a href="https://www.railstutorial.org/book/log_in_log_out#code-remember_me_checkbox" class="hyperref">Listing&nbsp;<span class="ref">8.47</span></a>, we’ve included the CSS classes <code>checkbox</code> and <code>inline</code>, which Bootstrap uses to put the checkbox and the text (“Remember me on this computer”) in the same line.<span class="intersentencespace"></span> In order to complete the styling, we need just a few more CSS rules, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-remember_me_css" class="hyperref">Listing&nbsp;<span class="ref">8.48</span></a>.<span class="intersentencespace"></span> The resulting login form appears in <a href="https://www.railstutorial.org/book/log_in_log_out#fig-login_form_remember_me" class="hyperref">Figure&nbsp;<span class="ref">8.12</span></a>.</p>
<div class="codelisting" id="_code-remember_me_css" data-tralics-id="uid858" data-number="8.48"><div class="heading"><span class="number">Listing 8.48:</span> 

<span class="description">CSS for the “remember me” checkbox.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="o">/*</span> <span class="nt">forms</span> <span class="o">*/</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.checkbox</span> <span class="p">{</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">-10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="nt">span</span> <span class="p">{</span>
    <span class="na">margin-left</span><span class="o">:</span> <span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">font-weight</span><span class="o">:</span> <span class="no">normal</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nn">#session_remember_me</span> <span class="p">{</span>
  <span class="na">width</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="na">margin-left</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div><div class="center figure" id="_fig-login_form_remember_me" data-tralics-id="uid859" data-number="8.12">
<div class="graphics image"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/login_form_remember_me.png" alt="images/figures/login_form_remember_me"></div><div class="caption"><span class="header">Figure 8.12: </span><span class="description">The login form with an added “remember me” checkbox.
</span></div></div>
<p>Having edited the login form, we’re now ready to remember users if they check the checkbox and forget them otherwise.<span class="intersentencespace"></span> Incredibly, because of all our work in the previous sections, the implementation can be reduced to one line.<span class="intersentencespace"></span> We start by noting that the <code>params</code> hash for submitted login forms now includes a value based on the checkbox (as you can verify by submitting the form in <a href="https://www.railstutorial.org/book/log_in_log_out#code-remember_me_checkbox" class="hyperref">Listing&nbsp;<span class="ref">8.47</span></a> with invalid information and inspecting the values in the debug section of the page).<span class="intersentencespace"></span> In particular, the value of</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span>
</pre></div></div>
<p>is <code>’1’</code> if the box is checked and <code>’0’</code> if it isn’t.</p>
<p>By testing the relevant value of the <code>params</code> hash, we can now remember or forget the user based on the value of the submission:<sup id="_cha-8_footnote-ref-25" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-25">25</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span>
  <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">else</span>
  <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>As explained in <a href="https://www.railstutorial.org/book/log_in_log_out#aside-ternary_operator" class="hyperref">Box&nbsp;<span class="ref">8.3</span></a>, this sort of <code>if</code>-<code>then</code> branching structure can be converted to one line using the <em>ternary operator</em> as follows:<sup id="_cha-8_footnote-ref-26" class="footnote"><a href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-26">26</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>Adding this to the Sessions controller’s <code>create</code> method leads to the amazingly compact code shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-remember_me_ternary" class="hyperref">Listing&nbsp;<span class="ref">8.49</span></a>.<span class="intersentencespace"></span> (Now you’re in a position to understand the code in <a href="https://www.railstutorial.org/book/log_in_log_out#code-digest_method" class="hyperref">Listing&nbsp;<span class="ref">8.18</span></a>, which uses the ternary operator to define the bcrypt <code>cost</code> variable.)</p>
<div class="codelisting" id="_code-remember_me_ternary" data-tralics-id="uid862" data-number="8.49"><div class="heading"><span class="number">Listing 8.49:</span> 

<span class="description">Handling the submission of the “remember me” checkbox.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">log_in</span> <span class="n">user</span>
<span class="hll">      <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span>      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">log_out</span> <span class="k">if</span> <span class="n">logged_in?</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the implementation in <a href="https://www.railstutorial.org/book/log_in_log_out#code-remember_me_ternary" class="hyperref">Listing&nbsp;<span class="ref">8.49</span></a>, our login system is complete, as you can verify by checking or unchecking the box in your browser.</p>
<div class="aside" id="_aside-ternary_operator" data-tralics-id="uid863" data-number="8.3"><div class="heading"><span class="number">Box 8.3.</span> 

<span class="description">10 types of people</span></div>
<p>There’s an old joke that there are 10 kinds of people in the world: those who understand binary and those who don’t (10, of course, being 2 in binary).<span class="intersentencespace"></span> In this spirit, we can say that there are 10 kinds of people in the world: those who like the ternary operator, those who don’t, and those who don’t yet know about it.<span class="intersentencespace"></span> (If you happen to be in the third category, soon you won’t be any longer.)</p>
<p>When you do a lot of programming, you quickly learn that one of the most common bits of control flow goes something like this:</p>
<pre>  if boolean?
    do_one_thing
  else
    do_something_else
  end</pre>
<p>Ruby, like many other languages (including C/C++, Perl, PHP, and Java), allows you to replace this with a much more compact expression using the <em>ternary operator</em> (so called because it consists of three parts):</p>
<pre>  boolean? ? do_one_thing : do_something_else</pre>
<p>You can also use the ternary operator to replace assignment, so that</p>
<pre>  if boolean?
    var = foo
  else
    var = bar
  end</pre>
<p>becomes</p>
<pre>  var = boolean? ? foo : bar</pre>
<p>Finally, it’s often convenient to use the ternary operator in a function’s return value:</p>
<pre>  def foo
    do_stuff
    boolean? ? "bar" : "baz"
  end</pre>
<p>Since Ruby implicitly returns the value of the last expression in a function, here the <code class="tt">foo</code> method returns <code class="tt">"bar"</code> or <code class="tt">"baz"</code> depending on whether <code class="tt">boolean?</code> is <code class="tt">true</code> or <code class="tt">false</code>.</p>

</div></div>
<div id="_sec-remember_tests" data-tralics-id="uid864" class="subsection" data-number="8.4.6"><h3><a href="https://www.railstutorial.org/book/log_in_log_out#sec-remember_tests" class="heading hyperref"><span class="number">8.4.6 </span>Remember tests</a></h3>
<p>Although our “remember me” functionality is now working, it’s important to write some tests to verify its behavior.<span class="intersentencespace"></span> One reason is to catch implementation errors, as discussed in a moment.<span class="intersentencespace"></span> Even more important, though, is that the core user persistence code is in fact completely untested at present.<span class="intersentencespace"></span> Fixing these issues will require some trickery, but the result will be a far more powerful test suite.</p>
<div id="_sec-testing_the_remember_me_box" data-tralics-id="uid865" class="subsubsection" data-number="8.4.6.1"><h4><a href="https://www.railstutorial.org/book/log_in_log_out#sec-testing_the_remember_me_box" class="heading">Testing the “remember me” box</a></h4>
<p>When I originally implemented the checkbox handling in <a href="https://www.railstutorial.org/book/log_in_log_out#code-remember_me_ternary" class="hyperref">Listing&nbsp;<span class="ref">8.49</span></a>, instead of the correct</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>I actually used</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>In this context, <code>params[:session][:remember_me]</code> is either <code>’0’</code> or <code>’1’</code>, both of which are <code>true</code> in a boolean context, so the resulting expression is <em>always true</em>, and the application acts as if the checkbox is always checked.<span class="intersentencespace"></span> This is exactly the kind of error a test can catch.</p>
<p>Because remembering users requires that they be logged in, our first step is to define a helper to log users in inside tests.<span class="intersentencespace"></span> In <a href="https://www.railstutorial.org/book/log_in_log_out#code-user_login_test_valid_information" class="hyperref">Listing&nbsp;<span class="ref">8.20</span></a>, we logged a user in using the <code>post</code> method and a valid <code>session</code> hash, but it’s cumbersome to do this every time.<span class="intersentencespace"></span> To avoid needless repetition, we’ll write a helper method called <code>log_in_as</code> to log in for us.</p>
<p>Our method for logging a user in depends on the type of test.<span class="intersentencespace"></span> Inside integration tests, we can post to the sessions path as in <a href="https://www.railstutorial.org/book/log_in_log_out#code-user_login_test_valid_information" class="hyperref">Listing&nbsp;<span class="ref">8.20</span></a>, but in other tests (such as controller and model tests) this won’t work, and we need to manipulate the <code>session</code> method directly.<span class="intersentencespace"></span> As a result, <code>log_in_as</code> should detect the kind of test being used and adjust accordingly.<span class="intersentencespace"></span> We can tell the difference between integration tests and other kinds of tests using Ruby’s convenient <code>defined?</code> method, which returns true if its argument is defined and false otherwise.<span class="intersentencespace"></span> In the present case, the <code>post_via_redirect</code> method (seen before in <a href="https://www.railstutorial.org/book/sign_up#code-a_test_for_valid_submission" class="hyperref">Listing&nbsp;<span class="ref">7.26</span></a>) is available only in integration tests, so the code</p>
<div class="code"><div class="highlight"><pre><span class="n">defined?</span><span class="p">(</span><span class="n">post_via_redirect</span><span class="p">)</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</pre></div></div>
<p>will return <code>true</code> inside an integration test and false otherwise.<span class="intersentencespace"></span> This suggests defining an <code>integration_test?</code> boolean method and writing an if-then statement schematically as follows:</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">integration_test?</span>
  <span class="c1"># Log in by posting to the sessions path</span>
<span class="k">else</span>
  <span class="c1"># Log in using the session</span>
<span class="k">end</span>
</pre></div></div>
<p>Filling in the comments with code leads to the <code>log_in_as</code> helper method shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-test_helper_log_in" class="hyperref">Listing&nbsp;<span class="ref">8.50</span></a>.<span class="intersentencespace"></span> (This is a fairly advanced method, so you are doing well if you can read it with full comprehension.)</p>
<div class="codelisting" id="_code-test_helper_log_in" data-tralics-id="uid866" data-number="8.50"><div class="heading"><span class="number">Listing 8.50:</span> 

<span class="description">Adding a <code>log_in_as</code> helper.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/test_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">ENV</span><span class="o">[</span><span class="s1">'RAILS_ENV'</span><span class="o">]</span> <span class="o">||=</span> <span class="s1">'test'</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">class</span> <span class="nc">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="n">fixtures</span> <span class="ss">:all</span>

  <span class="c1"># Returns true if a test user is logged in.</span>
  <span class="k">def</span> <span class="nf">is_logged_in?</span>
    <span class="o">!</span><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">].</span><span class="n">nil?</span>
  <span class="k">end</span>

  <span class="c1"># Logs in a test user.</span>
  <span class="k">def</span> <span class="nf">log_in_as</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">password</span>    <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span>    <span class="o">||</span> <span class="s1">'password'</span>
    <span class="n">remember_me</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">||</span> <span class="s1">'1'</span>
<span class="hll">    <span class="k">if</span> <span class="n">integration_test?</span>
</span>      <span class="n">post</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span>       <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                                  <span class="ss">password</span><span class="p">:</span>    <span class="n">password</span><span class="p">,</span>
                                  <span class="ss">remember_me</span><span class="p">:</span> <span class="n">remember_me</span> <span class="p">}</span>
    <span class="k">else</span>
      <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="c1"># Returns true inside an integration test.</span>
    <span class="k">def</span> <span class="nf">integration_test?</span>
<span class="hll">      <span class="n">defined?</span><span class="p">(</span><span class="n">post_via_redirect</span><span class="p">)</span>
</span>    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that, for maximum flexibility, the <code>log_in_as</code> method in <a href="https://www.railstutorial.org/book/log_in_log_out#code-test_helper_log_in" class="hyperref">Listing&nbsp;<span class="ref">8.50</span></a> accepts an <code>options</code> hash (as in <a href="https://www.railstutorial.org/book/sign_up#code-gravatar_option" class="hyperref">Listing&nbsp;<span class="ref">7.31</span></a>), with default options for the password and for the “remember me” checkbox set to <code>’password’</code> and <code>’1’</code>, respectively.<span class="intersentencespace"></span> In particular, because hashes return <code>nil</code> for nonexistent keys, code like</p>
<div class="code"><div class="highlight"><pre><span class="n">remember_me</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">||</span> <span class="s1">'1'</span>
</pre></div></div>
<p>evaluates to the given option if present and to the default otherwise (an application of the short-circuit evaluation described in <a href="https://www.railstutorial.org/book/log_in_log_out#aside-or_equals" class="hyperref">Box&nbsp;<span class="ref">8.1</span></a>).</p>
<p>To verify the behavior of the “remember me” checkbox, we’ll write two tests, one each for submitting with and without the checkbox checked.<span class="intersentencespace"></span> This is easy using the login helper defined in <a href="https://www.railstutorial.org/book/log_in_log_out#code-test_helper_log_in" class="hyperref">Listing&nbsp;<span class="ref">8.50</span></a>, with the two cases appearing as</p>
<div class="code"><div class="highlight"><pre><span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">)</span>
</pre></div></div>
<p>and</p>
<div class="code"><div class="highlight"><pre><span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'0'</span><span class="p">)</span>
</pre></div></div>
<p>(Because <code>’1’</code> is the default value of <code>remember_me</code>, we could omit the corresponding option in the first case above, but I’ve included it to make the parallel structure more apparent.)</p>
<p>After logging in, we can check if the user has been remembered by looking for the <code>remember_token</code> key in the <code>cookies</code>.<span class="intersentencespace"></span> Ideally, we would check that the cookie’s value is equal to the user’s remember token, but as currently designed there’s no way for the test to get access to it: the <code>user</code> variable in the controller has a remember token attribute, but (because <code>remember_token</code> is virtual) the <code>@user</code> variable in the test doesn’t.<span class="intersentencespace"></span> Fixing this minor blemish is left as an exercise (<a href="https://www.railstutorial.org/book/log_in_log_out#sec-log_in_out_exercises" class="hyperref">Section&nbsp;<span class="ref">8.6</span></a>), but for now we can just test to see if the relevant cookie is <code>nil</code> or not.</p>
<p>There’s one more subtlety, which is that for some reason inside tests the <code>cookies</code> method doesn’t work with symbols as keys, so that</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span>
</pre></div></div>
<p>is always <code>nil</code>.<span class="intersentencespace"></span> Luckily, <code>cookies</code> <em>does</em> work with string keys, so that</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="s1">'remember_token'</span><span class="o">]</span>
</pre></div></div>
<p>has the value we need.<span class="intersentencespace"></span> The resulting tests appear in <a href="https://www.railstutorial.org/book/log_in_log_out#code-remember_me_test" class="hyperref">Listing&nbsp;<span class="ref">8.51</span></a>.<span class="intersentencespace"></span> (Recall from <a href="https://www.railstutorial.org/book/log_in_log_out#code-user_login_test_valid_information" class="hyperref">Listing&nbsp;<span class="ref">8.20</span></a> that <code>users(:michael)</code> references the fixture user from <a href="https://www.railstutorial.org/book/log_in_log_out#code-real_user_fixture" class="hyperref">Listing&nbsp;<span class="ref">8.19</span></a>.)</p>
<div class="codelisting" id="_code-remember_me_test" data-tralics-id="uid867" data-number="8.51"><div class="heading"><span class="number">Listing 8.51:</span> 

<span class="description">A test of the “remember me” checkbox.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_login_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersLoginTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"login with remembering"</span> <span class="k">do</span>
<span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">)</span>
</span><span class="hll">    <span class="n">assert_not_nil</span> <span class="n">cookies</span><span class="o">[</span><span class="s1">'remember_token'</span><span class="o">]</span>
</span>  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"login without remembering"</span> <span class="k">do</span>
<span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'0'</span><span class="p">)</span>
</span><span class="hll">    <span class="n">assert_nil</span> <span class="n">cookies</span><span class="o">[</span><span class="s1">'remember_token'</span><span class="o">]</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Assuming you didn’t make the same implementation mistake I did, the tests should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="_uid868" data-tralics-id="uid868" data-number="8.52"><div class="heading"><span class="number">Listing 8.52:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div></div></div>
<div id="_sec-testing_the_remember_branch" data-tralics-id="uid869" class="subsubsection" data-number="8.4.6.2"><h4><a href="https://www.railstutorial.org/book/log_in_log_out#sec-testing_the_remember_branch" class="heading">Testing the remember branch</a></h4>
<p>In <a href="https://www.railstutorial.org/book/log_in_log_out#sec-login_with_remembering" class="hyperref">Section&nbsp;<span class="ref">8.4.2</span></a>, we verified by hand that the persistent session implemented in the preceding sections is working, but in fact the relevant branch in the <code>current_user</code> method is currently completely untested.<span class="intersentencespace"></span> My favorite way to handle this kind of situation is to raise an exception in the suspected untested block of code: if the code isn’t covered, the tests will still pass; if it is covered, the resulting error will identify the relevant test.<span class="intersentencespace"></span> The result in the present case appears in <a href="https://www.railstutorial.org/book/log_in_log_out#code-branch_raise" class="hyperref">Listing&nbsp;<span class="ref">8.53</span></a>.</p>
<div class="codelisting" id="_code-branch_raise" data-tralics-id="uid870" data-number="8.53"><div class="heading"><span class="number">Listing 8.53:</span> 

<span class="description">Raising an exception in an untested branch.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Returns the user corresponding to the remember token cookie.</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
      <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
<span class="hll">      <span class="k">raise</span>       <span class="c1"># The tests still pass, so this branch is currently untested.</span>
</span>      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
        <span class="n">log_in</span> <span class="n">user</span>
        <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>At this point, the tests are <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="_uid871" data-tralics-id="uid871" data-number="8.54"><div class="heading"><span class="number">Listing 8.54:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div></div><p>This is a problem, of course, because the code in <a href="https://www.railstutorial.org/book/log_in_log_out#code-branch_raise" class="hyperref">Listing&nbsp;<span class="ref">8.53</span></a> is broken.<span class="intersentencespace"></span> Moreover, persistent sessions are cumbersome to check by hand, so if we ever want to refactor the <code>current_user</code> method (as we will in <a href="https://www.railstutorial.org/book/account_activation_password_reset#cha-account_activation_and_password_reset" class="hyperref">Chapter&nbsp;<span class="ref">10</span></a>) it’s important to test it.</p>
<p>Because the <code>log_in_as</code> helper method defined in <a href="https://www.railstutorial.org/book/log_in_log_out#code-test_helper_log_in" class="hyperref">Listing&nbsp;<span class="ref">8.50</span></a> automatically sets <code>session[:user_id]</code>, testing the “remember” branch of the <code>current_user</code> method is difficult in an integration test.<span class="intersentencespace"></span> Luckily, we can bypass this restriction by testing the <code>current_user</code> method directly in a Sessions helper test, whose file we have to create:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> touch <span class="nb">test</span>/helpers/sessions_helper_test.rb
</pre></div></div>
<p>The test sequence is simple:</p>
<ol>
<li>Define a <code>user</code> variable using the fixtures.<span class="intersentencespace"></span>
</li>
<li>Call the <code>remember</code> method to remember the given user.<span class="intersentencespace"></span>
</li>
<li>Verify that <code>current_user</code> is equal to the given user.<span class="intersentencespace"></span>
</li></ol>
<p>Because the <code>remember</code> method doesn’t set <code>session[:user_id]</code>, this procedure will test the desired “remember” branch.<span class="intersentencespace"></span> The result appears in <a href="https://www.railstutorial.org/book/log_in_log_out#code-persistent_sessions_test" class="hyperref">Listing&nbsp;<span class="ref">8.55</span></a>.</p>
<div class="codelisting" id="_code-persistent_sessions_test" data-tralics-id="uid875" data-number="8.55"><div class="heading"><span class="number">Listing 8.55:</span> 

<span class="description">A test for persistent sessions.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/helpers/sessions_helper_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">SessionsHelperTest</span> <span class="o">&lt;</span> <span class="no">ActionView</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">remember</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"current_user returns right user when session is nil"</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">,</span> <span class="n">current_user</span>
    <span class="n">assert</span> <span class="n">is_logged_in?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"current_user returns nil when remember digest is wrong"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">new_token</span><span class="p">))</span>
    <span class="n">assert_nil</span> <span class="n">current_user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that we’ve added a second test, which checks that the current user is <code>nil</code> if the user’s remember digest doesn’t correspond correctly to the remember token, thereby testing the <code>authenticated?</code> expression in the nested <code>if</code> statement:</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>Incidentally, in <a href="https://www.railstutorial.org/book/log_in_log_out#code-persistent_sessions_test" class="hyperref">Listing&nbsp;<span class="ref">8.55</span></a> we could write</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_equal</span> <span class="n">current_user</span><span class="p">,</span> <span class="vi">@user</span>
</pre></div></div>
<p>instead, and it would work just the same, but (as mentioned briefly in <a href="https://www.railstutorial.org/book/filling_in_the_layout#sec-layout_exercises" class="hyperref">Section&nbsp;<span class="ref">5.6</span></a>) the conventional order for the arguments to <code>assert_equal</code> is <em>expected</em>, <em>actual</em>:</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_equal</span> <span class="o">&lt;</span><span class="n">expected</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">actual</span><span class="o">&gt;</span>
</pre></div></div>
<p>which in the case of <a href="https://www.railstutorial.org/book/log_in_log_out#code-persistent_sessions_test" class="hyperref">Listing&nbsp;<span class="ref">8.55</span></a> gives</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">,</span> <span class="n">current_user</span>
</pre></div></div>
<p>With the code as in <a href="https://www.railstutorial.org/book/log_in_log_out#code-persistent_sessions_test" class="hyperref">Listing&nbsp;<span class="ref">8.55</span></a>, the test is <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span> as required:</p>
<div class="codelisting" id="_uid876" data-tralics-id="uid876" data-number="8.56"><div class="heading"><span class="number">Listing 8.56:</span> <span class="description"><span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test TEST=test/helpers/sessions_helper_test.rb
</pre></div></div></div><p>We can get the tests in <a href="https://www.railstutorial.org/book/log_in_log_out#code-persistent_sessions_test" class="hyperref">Listing&nbsp;<span class="ref">8.55</span></a> to pass by removing the <code>raise</code> and restoring the original <code>current_user</code> method, as shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-branch_no_raise" class="hyperref">Listing&nbsp;<span class="ref">8.57</span></a>.<span class="intersentencespace"></span> (You can also verify by removing the <code>authenticated?</code> expression in <a href="https://www.railstutorial.org/book/log_in_log_out#code-branch_no_raise" class="hyperref">Listing&nbsp;<span class="ref">8.57</span></a> that the second test in <a href="https://www.railstutorial.org/book/log_in_log_out#code-persistent_sessions_test" class="hyperref">Listing&nbsp;<span class="ref">8.55</span></a> fails, which confirms that it tests the right thing.)</p>
<div class="codelisting" id="_code-branch_no_raise" data-tralics-id="uid877" data-number="8.57"><div class="heading"><span class="number">Listing 8.57:</span> 

<span class="description">Removing the raised exception.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Returns the user corresponding to the remember token cookie.</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
      <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
<span class="hll">    <span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span>      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
        <span class="n">log_in</span> <span class="n">user</span>
        <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>At this point, the test suite should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="_uid878" data-tralics-id="uid878" data-number="8.58"><div class="heading"><span class="number">Listing 8.58:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div></div><p>Now that the “remember” branch of <code>current_user</code> is tested, we can be confident of catching regressions without having to check by hand.</p>
</div></div></div><div id="_cid56" data-tralics-id="cid56" class="section" data-number="8.5"><h2><a href="https://www.railstutorial.org/book/log_in_log_out#cid56" class="heading hyperref"><span class="number">8.5 </span>Conclusion</a></h2>
<p>We’ve covered a lot of ground in the last two chapters, transforming our promising but unformed application into a site capable of the full suite of signup and login behaviors.<span class="intersentencespace"></span> All that is needed to complete the authentication functionality is to restrict access to pages based on login status and user identity.<span class="intersentencespace"></span> We’ll accomplish this task en route to giving users the ability to edit their information, which is the main goal of <a href="https://www.railstutorial.org/book/updating_and_deleting_users#cha-updating_showing_and_deleting_users" class="hyperref">Chapter&nbsp;<span class="ref">9</span></a>.</p>
<p>Before moving on, merge your changes back into the master branch:</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake test
$ git add -A
$ git commit -m "Finish log in/log out"
$ git checkout master
$ git merge log-in-log-out
</pre></div></div>
<p>Then push up the remote repository and the production server:</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake test
$ git push
$ git push heroku
$ heroku run rake db:migrate
</pre></div></div>
<p>Note that the application will briefly be in an invalid state after pushing but before the migration is finished.<span class="intersentencespace"></span> On a production site with significant traffic, it is a good idea to turn <a href="https://devcenter.heroku.com/articles/maintenance-mode" target="_blank"><em>maintenance mode</em></a> on before making the changes:</p>
<div class="code"><div class="highlight"><pre>$ heroku maintenance:on
$ git push heroku
$ heroku run rake db:migrate
$ heroku maintenance:off
</pre></div></div>
<p>This arranges to show a standard error page during the deployment and migration.<span class="intersentencespace"></span> (We won’t bother with this step again, but it’s good to see it at least once.)<span class="intersentencespace"></span> For more information, see the Heroku documentation on <a href="https://devcenter.heroku.com/articles/error-pages" target="_blank">error pages</a>.</p>
<div id="_sec-log_in_out_what_we_learned_in_this_chapter" data-tralics-id="uid879" class="subsection" data-number="8.5.1"><h3><a href="https://www.railstutorial.org/book/log_in_log_out#sec-log_in_out_what_we_learned_in_this_chapter" class="heading hyperref"><span class="number">8.5.1 </span>What we learned in this chapter</a></h3>
<ul>
<li>Rails can maintain state from one page to the next using both temporary and persistent cookies.<span class="intersentencespace"></span>
</li>
<li>The login form is designed to create a new session to log a user in.<span class="intersentencespace"></span>
</li>
<li>The <code>flash.now</code> method is used for flash messages on rendered pages.<span class="intersentencespace"></span>
</li>
<li>Test-driven development is useful when debugging by reproducing the bug in a test.<span class="intersentencespace"></span>
</li>
<li>Using the <code>session</code> method, we can securely place a user id on the browser to create a temporary session.<span class="intersentencespace"></span>
</li>
<li>We can change features such as links on the layouts based on login status.<span class="intersentencespace"></span>
</li>
<li>Integration tests can verify correct routes, database updates, and proper changes to the layout.<span class="intersentencespace"></span>
</li>
<li>We associate to each user a remember token and a corresponding remember digest for use in persistent sessions.<span class="intersentencespace"></span>
</li>
<li>Using the <code>cookies</code> method, we create a persistent session by placing a permanent remember token cookie on the browser.<span class="intersentencespace"></span>
</li>
<li>Login status is determined by the presence of a current user based on the temporary session’s user id or the permanent session’s unique remember token.<span class="intersentencespace"></span>
</li>
<li>The application signs users out by deleting the session’s user id and removing the permanent cookie from the browser.<span class="intersentencespace"></span>
</li>
<li>The ternary operator is a compact way to write simple if-then statements.<span class="intersentencespace"></span>
</li></ul>
</div></div><div id="_sec-log_in_out_exercises" data-tralics-id="cid57" class="section" data-number="8.6"><h2><a href="https://www.railstutorial.org/book/log_in_log_out#sec-log_in_out_exercises" class="heading hyperref"><span class="number">8.6 </span>Exercises</a></h2>
<ul>
<li>You can get the solutions manual for the exercises with any purchase at <a href="http://www.railstutorial.org/" target="_blank">www.railstutorial.org</a>.<span class="intersentencespace"></span>
</li>
<li><a href="https://app.convertkit.com/landing_pages/13816" target="_blank">Sign up for the Rails Tutorial email list</a> and get Rails Tutorial cheatsheet cards for the first and toy apps as a free bonus.<span class="intersentencespace"></span>
</li></ul>
<p>For a suggestion on how to avoid conflicts between exercises and the main tutorial, see the note on exercise topic branches in <a href="https://www.railstutorial.org/book/static_pages#sec-static_pages_exercises" class="hyperref">Section&nbsp;<span class="ref">3.6</span></a>.</p>
<ol>
<li>In <a href="https://www.railstutorial.org/book/log_in_log_out#code-user_model_remember" class="hyperref">Listing&nbsp;<span class="ref">8.32</span></a>, we defined the new token and digest class methods by explicitly prefixing them with <code>User</code>.<span class="intersentencespace"></span> This works fine and, because they are actually <em>called</em> using <code>User.new_token</code> and <code>User.digest</code>, it is probably the clearest way to define them.<span class="intersentencespace"></span> But there are two perhaps more idiomatically correct ways to define class methods, one slightly confusing and one extremely confusing.<span class="intersentencespace"></span> By running the test suite, verify that the implementations in <a href="https://www.railstutorial.org/book/log_in_log_out#code-token_digest_self" class="hyperref">Listing&nbsp;<span class="ref">8.59</span></a> (slightly confusing) and <a href="https://www.railstutorial.org/book/log_in_log_out#code-token_digest_class_self" class="hyperref">Listing&nbsp;<span class="ref">8.60</span></a> (extremely confusing) are correct.<span class="intersentencespace"></span> (Note that, in the context of <a href="https://www.railstutorial.org/book/log_in_log_out#code-token_digest_self" class="hyperref">Listing&nbsp;<span class="ref">8.59</span></a> and <a href="https://www.railstutorial.org/book/log_in_log_out#code-token_digest_class_self" class="hyperref">Listing&nbsp;<span class="ref">8.60</span></a>, <code>self</code> is the <code>User</code> class, whereas the other uses of <code>self</code> in the User model refer to a user object <em>instance</em>.<span class="intersentencespace"></span> This is part of what makes them confusing.)
</li>
<li>As indicated in <a href="https://www.railstutorial.org/book/log_in_log_out#sec-remember_tests" class="hyperref">Section&nbsp;<span class="ref">8.4.6</span></a>, as the application is currently designed there’s no way to access the virtual <code>remember_token</code> attribute in the integration test in <a href="https://www.railstutorial.org/book/log_in_log_out#code-remember_me_test" class="hyperref">Listing&nbsp;<span class="ref">8.51</span></a>.<span class="intersentencespace"></span> It is possible, though, using a special test method called <code>assigns</code>.<span class="intersentencespace"></span> Inside a test, you can access <em>instance</em> variables defined in the controller by using <code>assigns</code> with the corresponding symbol.<span class="intersentencespace"></span> For example, if the <code>create</code> action defines an <code>@user</code> variable, we can access it in the test using <code>assigns(:user)</code>.<span class="intersentencespace"></span> Right now, the Sessions controller <code>create</code> action defines a normal (non-instance) variable called <code>user</code>, but if we change it to an instance variable we can test that <code>cookies</code> correctly contains the user’s remember token.<span class="intersentencespace"></span> By filling in the missing elements in <a href="https://www.railstutorial.org/book/log_in_log_out#code-login_create_user_instance" class="hyperref">Listing&nbsp;<span class="ref">8.61</span></a> and <a href="https://www.railstutorial.org/book/log_in_log_out#code-improved_remember_me_test" class="hyperref">Listing&nbsp;<span class="ref">8.62</span></a> (indicated with question marks&nbsp;<code>?</code><span class="intersentencespace"></span> and <code>FILL_IN</code>), complete this improved test of the “remember me” checkbox.
</li></ol>
<div class="codelisting" id="_code-token_digest_self" data-tralics-id="uid896" data-number="8.59"><div class="heading"><span class="number">Listing 8.59:</span> 

<span class="description">Defining the new token and digest methods using <code>self</code>.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Returns the hash digest of the given string.</span>
<span class="hll">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</span>    <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                                  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Returns a random token.</span>
<span class="hll">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">new_token</span>
</span>    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-token_digest_class_self" data-tralics-id="uid897" data-number="8.60"><div class="heading"><span class="number">Listing 8.60:</span> 

<span class="description">Defining the new token and digest methods using <code>class &lt;&lt; self</code>.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="hll">  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span>    <span class="c1"># Returns the hash digest of the given string.</span>
<span class="hll">    <span class="k">def</span> <span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</span>      <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                                    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
      <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Returns a random token.</span>
<span class="hll">    <span class="k">def</span> <span class="nf">new_token</span>
</span>      <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div></div></div><div class="codelisting" id="_code-login_create_user_instance" data-tralics-id="uid898" data-number="8.61"><div class="heading"><span class="number">Listing 8.61:</span> 

<span class="description">A template for using an instance variable in the <code>create</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
<span class="hll">    <span class="p">?</span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
</span><span class="hll">    <span class="k">if</span> <span class="p">?</span><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="p">?</span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">      <span class="n">log_in</span> <span class="p">?</span><span class="n">user</span>
</span><span class="hll">      <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(?</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(?</span><span class="n">user</span><span class="p">)</span>
</span><span class="hll">      <span class="n">redirect_to</span> <span class="p">?</span><span class="n">user</span>
</span>    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">log_out</span> <span class="k">if</span> <span class="n">logged_in?</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-improved_remember_me_test" data-tralics-id="uid899" data-number="8.62"><div class="heading"><span class="number">Listing 8.62:</span> 

<span class="description">A template for an improved “remember me” test.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_login_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersLoginTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"login with remembering"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">)</span>
<span class="hll">    <span class="n">assert_equal</span> <span class="no">FILL_IN</span><span class="p">,</span> <span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">FILL_IN</span>
</span>  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"login without remembering"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'0'</span><span class="p">)</span>
    <span class="n">assert_nil</span> <span class="n">cookies</span><span class="o">[</span><span class="s1">'remember_token'</span><span class="o">]</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div></div><div id="cha-8_footnotes">
  <ol class="footnotes">
    <li id="_cha-8_footnote-1">Another common model is to expire the session after a certain amount of time.<span class="intersentencespace"></span> This is especially appropriate on sites containing sensitive information, such as banking and financial trading accounts.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-1">↑</a></li>
    <li id="_cha-8_footnote-2">Some browsers offer an option to restore such sessions via a “continue where you left off” feature, but of course Rails has no control over this behavior.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-2">↑</a></li>
    <li id="_cha-8_footnote-3">A second option is to use <code>form_tag</code> in place of <code>form_for</code>, which might be even more idiomatically correct Rails, but it has less in common with the signup form, and at this stage I want to emphasize the parallel structure.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-3">↑</a></li>
    <li id="_cha-8_footnote-4">The <code>log_in</code> method is available in the Sessions controller because of the module inclusion in <a href="https://www.railstutorial.org/book/log_in_log_out#code-sessions_helper_include" class="hyperref">Listing&nbsp;<span class="ref">8.11</span></a>.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-4">↑</a></li>
    <li id="_cha-8_footnote-5">This practice of remembering variable assignments from one method invocation to the next is known as <a href="http://en.wikipedia.org/wiki/Memoization" target="_blank"><em>memoization</em></a>.<span class="intersentencespace"></span> (Note that this is a technical term; in particular, it’s <em>not</em> a misspelling of “memorization”.)&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-5">↑</a></li>
    <li id="_cha-8_footnote-6">Image from <a href="http://www.flickr.com/photos/hermanusbackpackers/3343254977/" target="_blank">http://www.flickr.com/photos/hermanusbackpackers/3343254977/</a>.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-6">↑</a></li>
    <li id="_cha-8_footnote-7">Web browsers can’t actually issue <code class="tt">DELETE</code> requests; Rails fakes it with JavaScript.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-7">↑</a></li>
    <li id="_cha-8_footnote-8">See the <a href="http://getbootstrap.com/components/" target="_blank">Bootstrap components page</a> for more information.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-8">↑</a></li>
    <li id="_cha-8_footnote-9">If you’re using the cloud IDE, I recommend using a different browser to test the login behavior so that you don’t have to close down the browser running the IDE.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-9">↑</a></li>
    <li id="_cha-8_footnote-10">It’s worth noting that indentation in fixture files must take the form of spaces, not tabs, so take care when copying code like that shown in <a href="https://www.railstutorial.org/book/log_in_log_out#code-real_user_fixture" class="hyperref">Listing&nbsp;<span class="ref">8.19</span></a>.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-10">↑</a></li>
    <li id="_cha-8_footnote-11">As with the Sessions controller, the <code>log_in</code> method is available in the Users controller because of the module inclusion in <a href="https://www.railstutorial.org/book/log_in_log_out#code-sessions_helper_include" class="hyperref">Listing&nbsp;<span class="ref">8.11</span></a>.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-11">↑</a></li>
    <li id="_cha-8_footnote-12">For example, I once had a test suite that was <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span> even after accidentally deleting the main <code>log_in</code> method in the Sessions helper.<span class="intersentencespace"></span> The reason is that the tests were happily using a test helper with the same name, thereby passing even though the application was completely broken.<span class="intersentencespace"></span> As with <code>is_logged_in?</code>, we’ll avoid this issue by defining the test helper <code>log_in_as</code> in <a href="https://www.railstutorial.org/book/log_in_log_out#code-test_helper_log_in" class="hyperref">Listing&nbsp;<span class="ref">8.50</span></a>.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-12">↑</a></li>
    <li id="_cha-8_footnote-13">Some browsers offer a “<a href="http://stackoverflow.com/questions/20449641/rails-4-session-value-never-expires-or-dies-when-browser-closes" target="_blank">remember where I left off</a>” feature, which restores the session automatically, so be sure to disable any such feature before trying to log out.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-13">↑</a></li>
    <li id="_cha-8_footnote-14">Setting <code>@current_user</code> to <code>nil</code> would only matter if <code>@current_user</code> were created before the <code>destroy</code> action (which it isn’t) <em>and</em> if we didn’t issue an immediate redirect (which we do).<span class="intersentencespace"></span> This is an unlikely combination of events, and with the application as presently constructed it isn’t necessary, but because it’s security-related I include it for completeness.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-14">↑</a></li>
    <li id="_cha-8_footnote-15">Session hijacking was widely publicized by the <a href="http://codebutler.com/firesheep" target="_blank">Firesheep</a> application, which showed that remember tokens at many high-profile sites were visible when connected to public Wi-Fi networks.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-15">↑</a></li>
    <li id="_cha-8_footnote-16">This choice is based on the <a href="http://railscasts.com/episodes/274-remember-me-reset-password" target="_blank">RailsCast on remember me</a>.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-16">↑</a></li>
    <li id="_cha-8_footnote-17">Indeed, it had better be OK, because with bcrypt’s <a href="https://en.wikipedia.org/wiki/Salt_%28cryptography%29" target="_blank">salted hashes</a> there’s no way for us to tell if two users’ passwords match.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-17">↑</a></li>
    <li id="_cha-8_footnote-18">With unique remember tokens, an attacker always needs <em>both</em> the user id and the remember token cookies to hijack the session.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-18">↑</a></li>
    <li id="_cha-8_footnote-19">As a general rule, if a method doesn’t need an instance of an object, it should be a class method.<span class="intersentencespace"></span> Indeed, this decision will prove important in <a href="https://www.railstutorial.org/book/account_activation_password_reset#sec-account_activation_mailer" class="hyperref">Section&nbsp;<span class="ref">10.1.2</span></a>.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-19">↑</a></li>
    <li id="_cha-8_footnote-20">As noted in <a href="https://www.railstutorial.org/book/modeling_users#sec-a_hashed_password" class="hyperref">Section&nbsp;<span class="ref">6.3.1</span></a>, “unencrypted password” is a misnomer, as the secure password is <em>hashed</em>, not encrypted.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-20">↑</a></li>
    <li id="_cha-8_footnote-21">I generally use the convention of putting such assignments in parentheses, which is a visual reminder that it’s not a comparison.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-21">↑</a></li>
    <li id="_cha-8_footnote-22">Google “&lt;your browser name&gt; inspect cookies” to learn how to inspect the cookies on your system.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-22">↑</a></li>
    <li id="_cha-8_footnote-23">Thanks to reader Paulo Célio Júnior for pointing this out.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-23">↑</a></li>
    <li id="_cha-8_footnote-24">Thanks to reader Niels de Ron for pointing this out.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-24">↑</a></li>
    <li id="_cha-8_footnote-25">Note that this means unchecking the box will log out the user on all browsers on all computers.<span class="intersentencespace"></span> The alternate design of remembering user login sessions on each browser independently is potentially more convenient for users, but it’s less secure, and is also more complicated to implement.<span class="intersentencespace"></span> Ambitious readers are invited to try their hand at implementing it.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-25">↑</a></li>
    <li id="_cha-8_footnote-26">Before we wrote <code>remember user</code> without parentheses, but when used with the ternary operator omitting them results in a syntax error.&nbsp;<a class="arrow" href="https://www.railstutorial.org/book/log_in_log_out#cha-8_footnote-ref-26">↑</a></li>
  </ol>
</div></div></div>
<div class="book-bottom-menu">
<div class="bookMenu-arrows">
<a class="leftArrow" href="javascript://">◄</a>
<a class="upArrow" href="javascript://">▲</a>
<a class="rightArrow" href="javascript://">►</a>
</div>
</div>
</div>
<div id="bookContentNotAvailable">
<img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/empty_content-f645e37a2f80dc1a63b6889833b1d916e96339ce337b9da5db9fd00748cf29b0.png" alt="Empty content f645e37a2f80dc1a63b6889833b1d916e96339ce337b9da5db9fd00748cf29b0">
Sorry, content not available
</div>
</div>
<div class="emailPitch" id="bookEmailModal">
<a onclick="closeEmailPops()" class="emailSignupClose" href="javascript://">x</a>
<strong>GET A FREE EMAIL COURSE ON WEB DEVELOPMENT</strong>
<p>Sign up now to get a free 8-part email course on learning web development. This will also ensure you get updates about the Ruby on Rails Tutorial and related products (such as the <a href="http://learnenough.com/">Learn Enough™ to Be Dangerous</a> series of tutorials).</p>

<div class="j_followBookForm"><form action="https://www.softcover.io/books/107/follow" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="✓">
<!-- %input{name: "name", type: "text", placeholder: "YOUR NAME"} -->
<input name="email" placeholder="Your email address" type="text">
<input class="greyButton optClick_follow" type="submit" value="Follow Author">
</form>

</div>
</div>
<script>
  // setup book nav
  $(function(){
    Book.init({
      title: "Ruby on Rails Tutorial (3rd Ed.)",
      path: "/book",
      slug: "ruby_on_rails_tutorial_3rd_edition",
      isArticle: false,
      s3_path_prefix: "636/ruby_on_rails_tutorial_3rd_edition",
      chapters: [{"title":"Frontmatter\n","number":0,"slug":"frontmatter","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_3rd_edition/html/frontmatter_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20160418T015003Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20160418/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=a2c7d4f822daa0851a490fb3940c7a520115e1b3495a0a125d3ab28e36e975ad"},{"title":"Chapter 1: From zero to deploy\n","number":1,"slug":"beginning","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_3rd_edition/html/beginning_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20160418T015003Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20160418/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=4805dc37c74721d1f7a63b333ca5795617fe0293e97cfd0a8b171bf4ea9c533f"},{"title":"Chapter 2: A toy app\n","number":2,"slug":"toy_app","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_3rd_edition/html/toy_app_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20160418T015003Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20160418/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=71be3fe0110d9a50cb0d49a9a90c4bd3516650649d88002e9be95f49716caea8"},{"title":"Chapter 3: Mostly static pages\n","number":3,"slug":"static_pages","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_3rd_edition/html/static_pages_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20160418T015003Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20160418/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=5287d63baeab3798dcad5cd1abcccaa7773ccb2d730af27444d1ce29c65bc8cc"},{"title":"Chapter 4: Rails-flavored Ruby\n","number":4,"slug":"rails_flavored_ruby","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_3rd_edition/html/rails_flavored_ruby_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20160418T015003Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20160418/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=9d0324791dffa9c39023e72544d80af4101788fdf813d9656e5fa61bc66ec433"},{"title":"Chapter 5: Filling in the layout\n","number":5,"slug":"filling_in_the_layout","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_3rd_edition/html/filling_in_the_layout_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20160418T015003Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20160418/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=e334000e34b85431c524fede74734b61e9d11342ed18c540f8b9c8bd8e5f8318"},{"title":"Chapter 6: Modeling users\n","number":6,"slug":"modeling_users","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_3rd_edition/html/modeling_users_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20160418T015003Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20160418/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=e578462ee5d5c984d2ab03683587c6ab033ba2562208dc7c7401c48c556a29eb"},{"title":"Chapter 7: Sign up\n","number":7,"slug":"sign_up","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_3rd_edition/html/sign_up_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20160418T015003Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20160418/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=3ed8c56026334e06690aa5749950a57e879c8db29d19690125b20988d3051ba3"},{"title":"Chapter 8: Log in, log out\n","number":8,"slug":"log_in_log_out","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_3rd_edition/html/log_in_log_out_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20160418T015003Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20160418/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=75834742a45f9b0b9892cf27f0d2ca512af88b87c612f485fb4e44b3620603ae"},{"title":"Chapter 9: Updating, showing, and deleting users\n","number":9,"slug":"updating_and_deleting_users","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_3rd_edition/html/updating_and_deleting_users_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20160418T015003Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20160418/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=f7c74c47ed345dd9af034968c912990cf42d4d4127dcf42b9e630703100eb86a"},{"title":"Chapter 10: Account activation and password reset\n","number":10,"slug":"account_activation_password_reset","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_3rd_edition/html/account_activation_password_reset_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20160418T015003Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20160418/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=7a45d82bcf0aae521e20aeb96087a40b7509d153761035b4f10f672ed2f23a72"},{"title":"Chapter 11: User microposts\n","number":11,"slug":"user_microposts","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_3rd_edition/html/user_microposts_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20160418T015003Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20160418/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=02e55642f69f7397a4b9630f9cdc96f258f2c599c41f7255de955351053d9ab2"},{"title":"Chapter 12: Following users\n","number":12,"slug":"following_users","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_3rd_edition/html/following_users_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20160418T015003Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20160418/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=e9a36354bc841319d65b1e17d4a3b6ee7f9de55e0e75328698539fa8f7b6b2d2"}],
      full_page: false,
      custom_math: "\"failing\": \"\\\\coloredtext{red}{\\\\textsc{\\\\textbf{red}}}\",\n\"passing\": \"\\\\coloredtext{ForestGreen}{\\\\textsc{\\\\textbf{green}}}\""
    });
  });
</script>

</div>
</div>
<div class="footer clearfix">
<div class="wrapper" id="hide_chromeFooter">
<em>powered by</em>
<a class="logo" href="http://www.softcover.io/"><img src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/logo_foot-06b81d3a7ed51e8bbd39d0caaa622c1f6f5fca29d725d2e7aa1f6e79e3aaa4a5.png" alt="Logo foot 06b81d3a7ed51e8bbd39d0caaa622c1f6f5fca29d725d2e7aa1f6e79e3aaa4a5">
</a></div>
</div>

<script type="text/javascript">
setTimeout(function(){var a=document.createElement("script");
var b=document.getElementsByTagName("script")[0];
a.src=document.location.protocol+"//dnn506yrbagrg.cloudfront.net/pages/scripts/0023/6713.js?"+Math.floor(new Date().getTime()/3600000);
a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
</script>

<script type="text/javascript">
  var _sf_async_config = { uid: 9895, domain: 'softcover.io', useCanonical: true };
  (function() {
    function loadChartbeat() {
      window._sf_endpt = (new Date()).getTime();
      var e = document.createElement('script');
      e.setAttribute('language', 'javascript');
      e.setAttribute('type', 'text/javascript');
      e.setAttribute('src','//static.chartbeat.com/js/chartbeat.js');
      document.body.appendChild(e);
    };
    var oldonload = window.onload;
    window.onload = (typeof window.onload != 'function') ?
      loadChartbeat : function() { oldonload(); loadChartbeat(); };
  })();
</script>

<script type="text/javascript">
  (function() {
    window._pa = window._pa || {};
    // _pa.orderId = "myOrderId"; // OPTIONAL: attach unique conversion identifier to conversions
    // _pa.revenue = "19.99"; // OPTIONAL: attach dynamic purchase values to conversions
    // _pa.productId = "myProductId"; // OPTIONAL: Include product ID for use with dynamic ads
    var pa = document.createElement('script'); pa.type = 'text/javascript'; pa.async = true;
    pa.src = ('https:' == document.location.protocol ? 'https:' : 'http:') + "//tag.perfectaudience.com/serve/54eea5d20a23b37d87000040.js";
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(pa, s);
  })();
</script>



<iframe name="stripeXDM_default275771_provider" id="stripeXDM_default275771_provider" src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/channel.html" frameborder="0" style="position: absolute; top: -2000px; left: 0px;"></iframe><div id="fb-root" class=" fb_reset"><div style="position: absolute; top: -10000px; height: 0px; width: 0px;"><div><iframe name="fb_xdm_frame_https" frameborder="0" allowtransparency="true" allowfullscreen="true" scrolling="no" id="fb_xdm_frame_https" aria-hidden="true" title="Facebook Cross Domain Communication Frame" tabindex="-1" src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/xd_arbiter.html" style="border: none;"></iframe></div></div><div style="position: absolute; top: -10000px; height: 0px; width: 0px;"><div></div></div></div><iframe id="rufous-sandbox" scrolling="no" frameborder="0" allowtransparency="true" allowfullscreen="true" style="position: absolute; visibility: hidden; display: none; width: 0px; height: 0px; padding: 0px; border: none;" src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/saved_resource.html"></iframe><script language="javascript" type="text/javascript" src="./Chapter 8_ Log in, log out _ Ruby on Rails Tutorial (3rd Ed.) _ Softcover.io_files/chartbeat.js"></script><div style="position: absolute; width: 0px; height: 0px; overflow: hidden; padding: 0px; border: 0px; margin: 0px;"><div id="MathJax_Font_Test" style="position: absolute; visibility: hidden; top: 0px; left: 0px; width: auto; padding: 0px; border: 0px; margin: 0px; white-space: nowrap; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; font-size: 40px; font-weight: normal; font-style: normal; font-family: MathJax_Main, sans-serif;"></div></div></body></html>